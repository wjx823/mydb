(load "rmresign")

; AoE2 AI-script by braindroid (braindroid@hotmail.com).
;  Comments, questions and suggestions are most welcome.

; This code is not copyrighted so you can use it as you like.
;  However, if you release a modified version PLEASE change the
;  name of the file.

; This script was based on BingAI version 2.2 by Bingmann,
;  http://aok.xhounds.com/. However, it has been completely
;  modified. 

; The script only supports population-cap 125 and the
;  Aztec, French and Korean civilizations on land maps. 
;  It will build transport ships but no navy.

; This AI attacks in the Imperial Age with a set of units
;  specific for the civilization selected. 

; Goals used: 
; 1-4		Need resource
; 5			Build Essentials / Build Anything
; 6			Need towncenter
; 7			Attack Cycle, internal
; 8-11		Escrow resource
; 12-13		Is Zero and Is One
; 14-16		Free
; 17		No Gold Army
; 18		Current Age
; 19-20		Needed resource
; 21-30		Research ('tech-tree')
; 31-40		Reserved for use as local variables (not all used)
; Doctrine	Attack Cycle, global

;===========-Initial setup (Population-limit dependant)-====
; Values based on the population cap.
#load-if-defined POPULATION-CAP-75
(defconst min-villagers 27)
(defconst max-villagers 36)			; <=50
(defconst town-centers-to-build 2)	; <0
(defconst trade-carts-to-train 3)					; Only if any allies
(defconst max-population 75)
#end-if
#load-if-defined POPULATION-CAP-100
(defconst min-villagers 36)
(defconst max-villagers 48)			; <=50
(defconst town-centers-to-build 2)	; <0
(defconst trade-carts-to-train 4) 				; Only if any allies
(defconst max-population 100)
#end-if
#load-if-defined POPULATION-CAP-125
(defconst dark_age_vills 24)
(defconst feudal_age_vills 34)
(defconst castle_age_vills 50)
(defconst min-villagers 60)
(defconst max-villagers 80)			; <=100
(defconst town-centers-to-build 3)
(defconst trade-carts-to-train 10) 				; Only if any allies
(defconst max-population 125)
#end-if
#load-if-defined POPULATION-CAP-150
(defconst min-villagers 46)
(defconst max-villagers 50)			; <=50
(defconst town-centers-to-build 2)	; <0
(defconst trade-carts-to-train 4) 				; Only if any allies
(defconst max-population 150)
#end-if
#load-if-defined POPULATION-CAP-175
(defconst min-villagers 46)
(defconst max-villagers 50)			; <=50
(defconst town-centers-to-build 3)	; <0
(defconst trade-carts-to-train 5) 				; Only if any allies
(defconst max-population 175)
#end-if
#load-if-defined POPULATION-CAP-200
(defconst min-villagers 46)
(defconst max-villagers 50)			; <=50
(defconst town-centers-to-build 3)	; <0
(defconst trade-carts-to-train 5) 				; Only if any allies
(defconst max-population 200)
#end-if

;===========-Loading Initial setup (Civ dependant)-=========
; Values that depend on the civilization.
#load-if-defined BRITON-CIV

#end-if

#load-if-defined BYZANTINE-CIV

#end-if

#load-if-defined CELTIC-CIV

#end-if

#load-if-defined CHINESE-CIV

#end-if

#load-if-defined FRANKISH-CIV
; Frankish Stock Limits (no trading if less of resource in stock)
(defconst min_food_for_early_trade 1400)	; Before Imperial or all research
(defconst min_wood_for_early_trade 800)
(defconst min_stone_for_early_trade 750)
(defconst min_gold_for_early_trade 1000)
(defconst min_food_for_late_trade 660)	; In Imperial with all research
(defconst min_wood_for_late_trade 600)
(defconst min_stone_for_late_trade 250)
(defconst min_gold_for_late_trade 400)

; Frankish Scout Unit (unit-line to use for scouting)
(defconst scout_type scout-cavalry-line)
(defconst scout_food 80)						; Scout Unit train food
(defconst scout_wood 0)						; Scout Unit train wood
(defconst scout_gold 0)						; Scout Unit train gold

; Frankish Defending Unit (for early defence).
(defconst defender-type scout-cavalry-line)
(defconst defender-food 80)					; Defending Unit train food
(defconst defender-wood 0)						; Defending Unit train wood
(defconst defender-gold 0)						; Defending Unit train gold

; Frankish Unique Unit: Throwing Axeman.
(defconst unique-unit-food 55)				; Unique unit train food
(defconst unique-unit-wood 0)					; Unique unit train wood
(defconst unique-unit-gold 25)				; Unique unit train gold
(defconst unique-unit-upgrade-food 1000)		; Unique unit upgrade food
(defconst unique-unit-upgrade-wood 0)			; Unique unit upgrade wood
(defconst unique-unit-upgrade-gold 850)		; Unique unit upgrade gold

; Frankish Unique Tech: Bearded Axe.
; Researched if appropriate for trained units.
(defconst unique_tech_food 400)				; Food cost to research U Tech
(defconst unique_tech_wood 0)					; Wood cost to research U Tech
(defconst unique_tech_stone 0)				; Stone cost to research U Tech
(defconst unique_tech_gold 400)				; Gold cost to research U Tech

; Frankish Monk Unit (monk for everyone except Spanish).
(defconst monk_type monk)

; Frankish No Gold Unit (for late attacks when gold is scarce).
(defconst no_gold_unit scout-cavalry-line)
(defconst no_gold_unit_food 80)
(defconst no_gold_unit_wood 0)

#load-if-defined POPULATION-CAP-125
; Army size and research to conduct.
;INFANTRY
(defconst militias-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_militias_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_militia 0)		; Res Infantry, Upgr Militia (0=no, 1=yes)
(defconst spearmen-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_spearmen_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_spearmen 0)		; Res Inf, Upgr Spearmen (0=no, 1=yes)
(defconst eaglewarrs-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_eaglewarrs_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_eaglewarrs 0)		; Res Inf, Upgr Elite Eagle (0=no, 1=yes)

;ARCHERS
(defconst archers-to-train 0)				; Number of this unit-line to have (>=0)
(defconst min_archers_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_archers 0)		; Res Archers, Upgr Archers (0=no, 1=yes)
(defconst skirmishers-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_skirmishers_for_attack 0)	; To train before attack (>=0)
(defconst research_twig_skirmishers 0)	; Res Arch, Upgr Skirm (0=no, 1=yes)
(defconst cavalry-archers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cavarchers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cavarchers 0)		; Res Arch, Upgr Cav Archers (0=no, 1=yes)

;CANNONEERSf
(defconst hand-cannoneers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cannoneers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cannoneers 0)		; Res Cannon, Upgr Canneers (0=no, 1=yes)

;CAVALRY
(defconst scout-cavalry-to-train 10)	; Number of this unit-line to have (>=0)
(defconst min_scoutcav_for_attack 7)	; Number to train before attack (>=0)
(defconst research_twig_scoutcav 1)	; Res Cavalry, Upgr ScoutCav (0=no, 1=yes)
(defconst knights-to-train 25)		; Number of this unit-line to have (>=0)
(defconst min_knights_for_attack 14)	; Number to train before attack (>=0)
(defconst research_twig_knights 1)	; Res Cavalry, Upgr Knights (0=no, 1=yes)
(defconst camels-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_camels_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_camels 0)		; Res Cavalry, Upgr Camels (0=no, 1=yes)

;MONKS
(defconst monks-to-train 5)			; Number of this unit-line to have (>=0)
										; If Civ is Spanish missionaries are trained
(defconst min_monks_for_attack 3)		; Number to train before attack (>=0)
(defconst research_twig_monks 0)		; Research Monastery Techs (0=no, 1=yes)

;SIEGE
(defconst trebuchets-to-train 5)		; Number of this unit-line to have (>=0)
(defconst min_trebuchets_for_attack 5)	; Number to train before attack (>=0)
(defconst research_twig_trebuchets 1)	; Research Siege Techs (0=no, 1=yes)
(defconst scorpions-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_scorpions_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_scorpions 0)	; Res Siege, Upgr Scorpions (0=no, 1=yes)
(defconst battering-rams-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_rams_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_rams 0)		; Res Siege, Upgr Rams (0=no, 1=yes)
(defconst mangonels-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_mangonels_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_mangonels 0)	; Res Siege, Upgr Mangonels (0=no, 1=yes)
(defconst bombard-cannons-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_bombcannons_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_bombardcannons 0)	; Res Siege, Upgr BC (0=no, 1=yes)
(defconst petards-to-train 0)				; Number of this unit-line to have (>=0)
(defconst min_petards_for_attack 0)		; Number to train before attack (>=0)

;UNIQUE
(defconst unique-units-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_unique_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_unique 0)		; Res Infantry, Archers, Cannoneers or
										; Cavalry, Upgr Unique (0=no, 1=yes)

;TOWERS
;Constant 1: Number of towers to build (>=0)
;Constant 2: If you plan to build this line, research it (0=no, 1=yes)
(defconst home-towers-to-build 6)		; Number of this build-line to have (>=0)
(defconst towers-to-build 6)			; Number of this build-line to have (>=0)
(defconst research_twig_towers 0)		; Upgrade Towers (0=no, 1=yes)
(defconst bombard-towers-to-build 0)	; Number of this build-line to have (>=0)
(defconst research_twig_bombardtowers 0)	; Res. BombardTowers (0=no, 1=yes)

;BUILDINGS
(defconst barracks-to-build 1)
(defconst archery-ranges-to-build 0)
(defconst stables-to-build 4)
(defconst monasteries-to-build 2)
(defconst siege-workshops-to-build 0)
(defconst castles-to-build 3)
(defconst docks-to-build 1)
(defconst blacksmiths-to-build 2)

;MISCELLANEOUS
(defconst transports-to-train 1)	; Build Transport if we build docks.
(defconst min-monks-to-train 1)	; Need a Monk to collect relics.
(defconst scouts-to-train 1)		; Scout Cavalry or Eagle Warrior (set above)
; If types below = scout_type increase number below to include number of scouts
(defconst defenders-to-train 7)	; Def. units to train (set type above).
(defconst no_gold_units_to_train 35)	; No Gold units to train (set type above).

	#end-if
#end-if

#load-if-defined GOTHIC-CIV

#end-if

#load-if-defined JAPANESE-CIV

#end-if

#load-if-defined MONGOL-CIV

#end-if

#load-if-defined PERSIAN-CIV

#end-if

#load-if-defined SARACEN-CIV

#end-if

#load-if-defined TEUTONIC-CIV

#end-if

#load-if-defined TURKISH-CIV

#end-if

#load-if-defined VIKING-CIV 

#end-if

#load-if-defined AZTEC-CIV 
; Aztec Stock Limits (no trading if less of resource in stock)
(defconst min_food_for_early_trade 1200)	; Before Imperial or all research
(defconst min_wood_for_early_trade 800)
(defconst min_stone_for_early_trade 750)
(defconst min_gold_for_early_trade 1000)
(defconst min_food_for_late_trade 600)	; In Imperial with all research
(defconst min_wood_for_late_trade 600)
(defconst min_stone_for_late_trade 250)
(defconst min_gold_for_late_trade 400)

; Aztec Scout Unit (unit-line to use for scouting)
(defconst scout_type eagle-warrior-line)
(defconst scout_food 20)						; Scout Unit train food
(defconst scout_wood 0)						; Scout Unit train wood
(defconst scout_gold 50)						; Scout Unit train gold

; Aztec Defending Unit (for early defence).
(defconst defender-type skirmisher-line)
(defconst defender-food 25)					; Defending Unit train food
(defconst defender-wood 35)					; Defending Unit train wood
(defconst defender-gold 0)						; Defending Unit train gold

; Aztec Unique Unit: Jaguar Warrior.
(defconst unique-unit-food 60)				; Unique unit train food
(defconst unique-unit-wood 0)					; Unique unit train wood
(defconst unique-unit-gold 30)				; Unique unit train gold
(defconst unique-unit-upgrade-food 1000)		; Unique unit upgrade food
(defconst unique-unit-upgrade-wood 0)			; Unique unit upgrade wood
(defconst unique-unit-upgrade-gold 500)		; Unique unit upgrade gold

; Aztec Unique Tech: Garland Wars.
; Researched if appropriate for trained units.
(defconst unique_tech_food 450)				; Food cost to research U Tech
(defconst unique_tech_wood 0)					; Wood cost to research U Tech
(defconst unique_tech_stone 0)				; Stone cost to research U Tech
(defconst unique_tech_gold 750)				; Gold cost to research U Tech

; Aztec Monk Unit (monk for everyone except Spanish).
(defconst monk_type monk)

; Aztec No Gold Unit (for late attacks when gold is scarce).
(defconst no_gold_unit spearman-line)
(defconst no_gold_unit_food 35)
(defconst no_gold_unit_wood 25)

#load-if-defined POPULATION-CAP-125
; Army size and research to conduct.
;INFANTRY
(defconst militias-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_militias_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_militia 0)	; Res Infantry, Upgr Militia (0=no, 1=yes)
(defconst spearmen-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_spearmen_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_spearmen 0)	; Res Inf, Upgr Spearmen (0=no, 1=yes)
(defconst eaglewarrs-to-train 15)		; Number of this unit-line to have (>=0)
(defconst min_eaglewarrs_for_attack 7); Number to train before attack (>=0)
(defconst research_twig_eaglewarrs 1)	; Res Inf, Upgr Elite Eagle (0=no, 1=yes)

;ARCHERS
(defconst archers-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_archers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_archers 0)	; Res Archers, Upgr Archers (0=no, 1=yes)
(defconst skirmishers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_skirmishers_for_attack 0)	; To train before attack (>=0)
(defconst research_twig_skirmishers 0)	; Res Arch, Upgr Skirm (0=no, 1=yes)
(defconst cavalry-archers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cavarchers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cavarchers 0)		; Res Arch, Upgr Cav Archers (0=no, 1=yes)

;CANNONEERSf
(defconst hand-cannoneers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cannoneers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cannoneers 0)		; Res Cannon, Upgr Canneers (0=no, 1=yes)

;CAVALRY
(defconst scout-cavalry-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_scoutcav_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_scoutcav 0)	; Res Cavalry, Upgr ScoutCav (0=no, 1=yes)
(defconst knights-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_knights_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_knights 0)	; Res Cavalry, Upgr Knights (0=no, 1=yes)
(defconst camels-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_camels_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_camels 0)		; Res Cavalry, Upgr Camels (0=no, 1=yes)

;MONKS
(defconst monks-to-train 15)			; Number of this unit-line to have (>=0)
										; If Civ is Spanish missionaries are trained
(defconst min_monks_for_attack 7)		; Number to train before attack (>=0)
(defconst research_twig_monks 1)		; Research Monastery Techs (0=no, 1=yes)

;SIEGE
(defconst trebuchets-to-train 5)		; Number of this unit-line to have (>=0)
(defconst min_trebuchets_for_attack 5)	; Number to train before attack (>=0)
(defconst research_twig_trebuchets 1)	; Research Siege Techs (0=no, 1=yes)
(defconst scorpions-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_scorpions_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_scorpions 0)	; Res Siege, Upgr Scorpions (0=no, 1=yes)
(defconst battering-rams-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_rams_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_rams 0)		; Res Siege, Upgr Rams (0=no, 1=yes)
(defconst mangonels-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_mangonels_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_mangonels 0)	; Res Siege, Upgr Mangonels (0=no, 1=yes)
(defconst bombard-cannons-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_bombcannons_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_bombardcannons 0)	; Res Siege, Upgr BC (0=no, 1=yes)
(defconst petards-to-train 0)				; Number of this unit-line to have (>=0)
(defconst min_petards_for_attack 0)		; Number to train before attack (>=0)

;UNIQUE
(defconst unique-units-to-train 10)	; Number of this unit-line to have (>=0)
(defconst min_unique_for_attack 7)	; Number to train before attack (>=0)
(defconst research_twig_unique 1)		; Res Infantry, Archers, Cannoneers or
										; Cavalry, Upgr Unique (0=no, 1=yes)

;TOWERS
;Constant 1: Number of towers to build (>=0)
;Constant 2: If you plan to build this line, research it (0=no, 1=yes)
(defconst home-towers-to-build 6)		; Number of this build-line to have (>=0)
(defconst towers-to-build 6)			; Number of this build-line to have (>=0)
(defconst research_twig_towers 0)		; Upgrade Towers (0=no, 1=yes)
(defconst bombard-towers-to-build 0)	; Number of this build-line to have (>=0)
(defconst research_twig_bombardtowers 0)	; Res. BombardTowers (0=no, 1=yes)

;BUILDINGS
(defconst barracks-to-build 4)
(defconst archery-ranges-to-build 1)
(defconst stables-to-build 0)
(defconst monasteries-to-build 3)
(defconst siege-workshops-to-build 0)
(defconst castles-to-build 4)
(defconst docks-to-build 1)
(defconst blacksmiths-to-build 1)

;MISCELLANEOUS
(defconst transports-to-train 1)		; Build Transport if we build docks.
(defconst min-monks-to-train 2)		; Need a Monk to collect relics.
(defconst scouts-to-train 1)			; Scout Cavalry or Eagle Warrior (set above)
; If types below = scout_type increase number below to include number of scouts
(defconst defenders-to-train 7)		; Def. units to train (set type above).
(defconst no_gold_units_to_train 35)	; No Gold units to train (set type above).
	#end-if
#end-if

#load-if-defined HUN-CIV 

#end-if

#load-if-defined KOREAN-CIV 
; Korean Stock Limits (no trading if less of resource in stock)
(defconst min_food_for_early_trade 1550)	; Before Imperial or all research
(defconst min_wood_for_early_trade 1100)
(defconst min_stone_for_early_trade 750)
(defconst min_gold_for_early_trade 1200)
(defconst min_food_for_late_trade 600)	; In Imperial with all research
(defconst min_wood_for_late_trade 800)
(defconst min_stone_for_late_trade 250)
(defconst min_gold_for_late_trade 400)

; Korean Scout Unit (unit-line to use for scouting)
(defconst scout_type scout-cavalry-line)
(defconst scout_food 80)						; Scout Unit train food
(defconst scout_wood 0)						; Scout Unit train wood
(defconst scout_gold 0)						; Scout Unit train gold

; Korean Defending Unit (for early defence).
(defconst defender-type skirmisher-line)
(defconst defender-food 25)					; Defending Unit train food
(defconst defender-wood 35)					; Defending Unit train wood
(defconst defender-gold 0)						; Defending Unit train gold

; Korean Unique Unit: War Wagon.
(defconst unique-unit-food 0)					; Unique unit train food
(defconst unique-unit-wood 80)				; Unique unit train wood
(defconst unique-unit-gold 60)				; Unique unit train gold
(defconst unique-unit-upgrade-food 0)			; Unique unit upgrade food
(defconst unique-unit-upgrade-wood 1000)		; Unique unit upgrade wood
(defconst unique-unit-upgrade-gold 800)		; Unique unit upgrade gold

; Korean Unique Tech: Shinkichon.
; Researched if appropriate for trained units.
(defconst unique_tech_food 0)					; Food cost to research U Tech
(defconst unique_tech_wood 800)				; Wood cost to research U Tech
(defconst unique_tech_stone 0)				; Stone cost to research U Tech
(defconst unique_tech_gold 500)				; Gold cost to research U Tech

; Korean Monk Unit (monk for everyone except Spanish).
(defconst monk_type monk)

; Korean No Gold Unit (for late attacks when gold is scarce).
(defconst no_gold_unit skirmisher-line)
(defconst no_gold_unit_food 25)
(defconst no_gold_unit_wood 35)

#load-if-defined POPULATION-CAP-125
; Army size and research to conduct.
;INFANTRY
(defconst militias-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_militias_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_militia 0)	; Res Infantry, Upgr Militia (0=no, 1=yes)
(defconst spearmen-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_spearmen_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_spearmen 0)	; Res Inf, Upgr Spearmen (0=no, 1=yes)
(defconst eaglewarrs-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_eaglewarrs_for_attack 0); Number to train before attack (>=0)
(defconst research_twig_eaglewarrs 0)	; Res Inf, Upgr Elite Eagle (0=no, 1=yes)

;ARCHERS
(defconst archers-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_archers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_archers 0)	; Res Archers, Upgr Archers (0=no, 1=yes)
(defconst skirmishers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_skirmishers_for_attack 0)	; To train before attack (>=0)
(defconst research_twig_skirmishers 0)	; Res Arch, Upgr Skirm (0=no, 1=yes)
(defconst cavalry-archers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cavarchers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cavarchers 0)		; Res Arch, Upgr Cav Archers (0=no, 1=yes)

;CANNONEERSf
(defconst hand-cannoneers-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_cannoneers_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_cannoneers 0)		; Res Cannon, Upgr Canneers (0=no, 1=yes)

;CAVALRY
(defconst scout-cavalry-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_scoutcav_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_scoutcav 0)	; Res Cavalry, Upgr ScoutCav (0=no, 1=yes)
(defconst knights-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_knights_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_knights 0)	; Res Cavalry, Upgr Knights (0=no, 1=yes)
(defconst camels-to-train 0)			; Number of this unit-line to have (>=0)
(defconst min_camels_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_camels 0)		; Res Cavalry, Upgr Camels (0=no, 1=yes)

;MONKS
(defconst monks-to-train 5)			; Number of this unit-line to have (>=0)
										; If Civ is Spanish missionaries are trained
(defconst min_monks_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_monks 0)		; Research Monastery Techs (0=no, 1=yes)

;SIEGE
(defconst trebuchets-to-train 5)		; Number of this unit-line to have (>=0)
(defconst min_trebuchets_for_attack 5)	; Number to train before attack (>=0)
(defconst research_twig_trebuchets 1)	; Research Siege Techs (0=no, 1=yes)
(defconst scorpions-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_scorpions_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_scorpions 0)	; Res Siege, Upgr Scorpions (0=no, 1=yes)
(defconst battering-rams-to-train 0)	; Number of this unit-line to have (>=0)
(defconst min_rams_for_attack 0)		; Number to train before attack (>=0)
(defconst research_twig_rams 0)		; Res Siege, Upgr Rams (0=no, 1=yes)
(defconst mangonels-to-train 10)		; Number of this unit-line to have (>=0)
(defconst min_mangonels_for_attack 4)	; Number to train before attack (>=0)
(defconst research_twig_mangonels 1)	; Res Siege, Upgr Mangonels (0=no, 1=yes)
(defconst bombard-cannons-to-train 0)		; Number of this unit-line to have (>=0)
(defconst min_bombcannons_for_attack 0)	; Number to train before attack (>=0)
(defconst research_twig_bombardcannons 0)	; Res Siege, Upgr BC (0=no, 1=yes)
(defconst petards-to-train 0)				; Number of this unit-line to have (>=0)
(defconst min_petards_for_attack 0)		; Number to train before attack (>=0)

;UNIQUE
(defconst unique-units-to-train 25)	; Number of this unit-line to have (>=0)
(defconst min_unique_for_attack 14)	; Number to train before attack (>=0)
(defconst research_twig_unique 1)		; Res Infantry, Archers, Cannoneers or
										; Cavalry, Upgr Unique (0=no, 1=yes)

;TOWERS
;Constant 1: Number of towers to build (>=0)
;Constant 2: If you plan to build this line, research it (0=no, 1=yes)
(defconst home-towers-to-build 6)		; Number of this build-line to have (>=0)
(defconst towers-to-build 6)			; Number of this build-line to have (>=0)
(defconst research_twig_towers 1)		; Upgrade Towers (0=no, 1=yes)
(defconst bombard-towers-to-build 6)	; Number of this build-line to have (>=0)
(defconst research_twig_bombardtowers 1)	; Res. BombardTowers (0=no, 1=yes)

;BUILDINGS
(defconst barracks-to-build 1)
(defconst archery-ranges-to-build 2)
(defconst stables-to-build 1)
(defconst monasteries-to-build 1)
(defconst siege-workshops-to-build 3)
(defconst castles-to-build 5)
(defconst docks-to-build 1)
(defconst blacksmiths-to-build 1)

;MISCELLANEOUS
(defconst transports-to-train 1)		; Build Transport if we build docks.
(defconst min-monks-to-train 2)		; Need a Monk to collect relics.
(defconst scouts-to-train 1)			; Scout Cavalry or Eagle Warrior (set above)
; If types below = scout_type increase number below to include number of scouts
(defconst defenders-to-train 7)		; Def. units to train (set type above).
(defconst no_gold_units_to_train 35)	; No Gold units to train (set type above).
	#end-if
#end-if

#load-if-defined MAYAN-CIV 

#end-if

#load-if-defined SPANISH-CIV 

; Info under unique om att missionaries anges under/som munkar

#end-if

#load-if-defined SCENARIO-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined ARABIA-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined BLACK-FOREST-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 100)
(defconst gates-to-build 4)

#end-if
#load-if-defined MONGOLIA-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined OASIS-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined YUCATAN-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 100)
(defconst gates-to-build 4)

#end-if
#load-if-defined GHOST-LAKE-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined HIGHLAND-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined SCANDANAVIA-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if
#load-if-defined CONTINENTAL-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 100)
(defconst gates-to-build 4)

#end-if
#load-if-defined ARCHIPELAGO-MAP 

; Wall parameters
(defconst wall-perimeter 2)
(defconst required-palisade-percent 0)
(defconst required-wall-percent 0)
(defconst gates-to-build 0)

#end-if

;===========-No constants to change below-==================

;===========-Economy: Initial setup-========================

; Maximum distances before building new gathering site.
(defconst max-food-dropsite-distance 10)
(defconst max-wood-dropsite-distance 8)
(defconst max-gold-dropsite-distance 5)
(defconst max-stone-dropsite-distance 5)
(defconst max-hunt-dropsite-distance 16)
(defconst emergency-wood-gather-distance -1)
(defconst idle-farm-gather-distance 20)

; Dropsite distances
; Allow the dropsites to get farther from the town.
(defconst first-dropsite-distance 25)
(defconst second-dropsite-distance 50)
(defconst third-dropsite-distance 100)
(defconst fourth-dropsite-distance 200)
(defconst buffer-dropsite-distance 50)

; Limit the number of camps so the AI doesn't build them 
; continuously when the resources run out.
(defconst max-lumber-camps 10)
(defconst max-mining-camps 10)

; Build Houses until housing-headroom is at least this much.
; Must be >= 1 or might not be able to train units.
(defconst min-extra-housing-early 3)	; In early ages units are produced slowly
(defconst min-extra-housing-late 5)	; In Imperial units are produced faster

; These goals are set to 1 if we need to buy/collect more.
(defconst need-food-goal 1)
(defconst need-wood-goal 2)
(defconst need-gold-goal 3)
(defconst need-stone-goal 4)

; These goals are set to 1 when we need to escrow resources.
(defconst escrow-food-goal 8)
(defconst escrow-wood-goal 9)
(defconst escrow-gold-goal 10)
(defconst escrow-stone-goal 11)

; This goal lets us check user-defined constants for zero/non-zero.
; It is always set to 0.  Then we can do (goal is-zero-goal user-constant)
; to see if user-constant is zero.
(defconst is-zero-goal 12)			;This one with d-a-s-h-e-s!

; This goal lets us check user-defined constants for one/non-one.
(defconst is_one_goal 13)			;This one with under_scores!

; This goal is turned 'on' when there is little gold left on the map.
(defconst no_gold_limits 17)

; Keep track of which age we are in or are in the process of advancing to.
(defconst current-age-goal 18)

; Need to know if we wanted gold or stone on the last pass to decide
; whether or not to bother with mining camps.
(defconst needed-gold-goal 19)
(defconst needed-stone-goal 20)

(defrule
	(true)
=>
	(chat-local-to-self "Braindroid 1.5")
	(disable-self)
)

(defrule
	(true)
=>
	(set-escrow-percentage food 0)
	(set-escrow-percentage wood 0)
	(set-escrow-percentage gold 0)
	(set-escrow-percentage stone 0)
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(disable-self)
)

(defrule
	(true)
=>
	(set-goal escrow-food-goal 0)
	(set-goal escrow-wood-goal 0)
	(set-goal escrow-gold-goal 0)
	(set-goal escrow-stone-goal 0)
	(set-goal is-zero-goal 0)
	(set-goal is_one_goal 1)
	(set-goal no_gold_limits 0)
	(set-goal needed-gold-goal 0)
	(set-goal needed-stone-goal 0)
	(disable-self)
)

;===========-Research: Initial setup-=======================

; Technology branches - decide what to research
(defconst research_branch_city 21)
(defconst research_branch_defence 22)
(defconst research_branch_infantry 23)
(defconst research_branch_archers 24)
(defconst research_branch_cannon 25)
(defconst research_branch_cavalry 26)
(defconst research_branch_monks 27)
(defconst research_branch_siege 28)
(defconst research_branch_trade 29)
(defconst research_next_phase 30)

; Only change these constants if you've changed the tech-tree.
; The Phase 3 constants are not used.
(defconst research_city_p1_last 10)
(defconst research_city_p2_last 17)
(defconst research_city_p3_last 39)
(defconst research_defence_p1_last 1)
(defconst research_defence_p2_last 19)
(defconst research_defence_p3_last 42)
(defconst research_infantry_p1_last 1)
(defconst research_infantry_p2_last 34)
(defconst research_infantry_p3_last 41)
(defconst research_archers_p1_last 1)
(defconst research_archers_p2_last 34)
(defconst research_archers_p3_last 41)
(defconst research_cannon_p1_last 1)
(defconst research_cannon_p2_last 25)
(defconst research_cannon_p3_last 34)
(defconst research_cavalry_p1_last 1)
(defconst research_cavalry_p2_last 34)
(defconst research_cavalry_p3_last 41)
(defconst research_monks_p1_last 1)
(defconst research_monks_p2_last 20)
(defconst research_monks_p3_last 37)
(defconst research_siege_p1_last 1)
(defconst research_siege_p2_last 21)
(defconst research_siege_p3_last 37)
(defconst research_trade_p1_last 1)
(defconst research_trade_p2_last 17)
(defconst research_trade_p3_last 36)

; Initialize the branches.
(defrule
	(true)
=>
	(set-goal research_branch_city 0)
	(set-goal research_branch_defence 0)
	(set-goal research_branch_infantry 0)
	(set-goal research_branch_archers 0)
	(set-goal research_branch_cannon 0)
	(set-goal research_branch_cavalry 0)
	(set-goal research_branch_monks 0)
	(set-goal research_branch_siege 0)
	(set-goal research_branch_trade 0)
	(disable-self)
)

; We always need to research the City and Defence branches.
(defrule
	(true)
=>
	(set-goal research_branch_city 1)
	(set-goal research_branch_defence 1)
	(disable-self)
)

; The Trade branch is only researched if we start with an ally.
; Also checked for City - Cartography.
(defrule
	(or (players-stance any-human ally)
		(players-stance any-computer ally))
=>
	(set-goal research_branch_trade 1)
	(disable-self)
)

;Will we research the Infantry branch?
(defrule
	(or (civ-selected celtic)
	(or (civ-selected frankish)
	(or (civ-selected gothic)
	(or (civ-selected japanese)
		(civ-selected teutonic)))))
	(goal is_one_goal research_twig_unique)
=>
	(set-goal research_branch_infantry 1)
	(disable-self)
)
(defrule
	(or (and (or (civ-selected aztec)
				(civ-selected viking))
			(goal is_one_goal research_twig_unique))
	(or (goal is_one_goal research_twig_militia)
	(or (goal is_one_goal research_twig_spearmen)
		(goal is_one_goal research_twig_eaglewarrs))))
=>
	(set-goal research_branch_infantry 1)
	(disable-self)
)

;Will we research the Archer branch?
(defrule
	(or (civ-selected briton)
	(or (civ-selected chinese)
	(or (civ-selected mayan)
	(or (civ-selected korean)
		(civ-selected mongol)))))
	(goal is_one_goal research_twig_unique)
=>
	(set-goal research_branch_archers 1)
	(disable-self)
)
(defrule
	(or (goal is_one_goal research_twig_archers)
	(or (goal is_one_goal research_twig_skirmishers)
		(goal is_one_goal research_twig_cavarchers)))
=>
	(set-goal research_branch_archers 1)
	(disable-self)
)

;Will we research the Cannon branch?
(defrule
	(or (and	(or (civ-selected turkish)
				(civ-selected spanish))
				(goal is_one_goal research_twig_unique))
		(goal is_one_goal research_twig_cannoneers))
=>
	(set-goal research_branch_cannon 1)
	(disable-self)
)

;Will we research the Cavalry branch?
(defrule
	(or (civ-selected byzantine)
	(or (civ-selected persian)
	(or (civ-selected hun)
		(civ-selected saracen))))
	(goal is_one_goal research_twig_unique)
=>
	(set-goal research_branch_cavalry 1)
	(disable-self)
)
(defrule
	(or (goal is_one_goal research_twig_scoutcav)
	(or (goal is_one_goal research_twig_knights)
		(goal is_one_goal research_twig_camels)))
=>
	(set-goal research_branch_cavalry 1)
	(disable-self)
)

;Will we research the Monk branch?
(defrule
	(goal is_one_goal research_twig_monks)
=>
	(set-goal research_branch_monks 1)
	(disable-self)
)

;Will we research the Siege branch?
(defrule
	(or (goal is_one_goal research_twig_trebuchets)
	(or (goal is_one_goal research_twig_mangonels)
	(or (goal is_one_goal research_twig_rams)
	(or (goal is_one_goal research_twig_scorpions)
		(goal is_one_goal research_twig_bombardcannons)))))
=>
	(set-goal research_branch_siege 1)
	(disable-self)
)

;===========-Military: Initial setup-här=======================
; Timer to spread attacks.
(defconst attack-timer 1)			; Timer
(defconst time_to_initialize 10)		; Values
(defconst time_to_charge 300)
(defconst time_to_recuperate 60)

; Keep track of wheather the army is ready for attack.
(defconst attack_when_goal 7)		; Goal
(defconst attack_later 0)			; Values
(defconst attack_now 1)
(defconst infarch_ready 50)
(defconst cavsiege_ready 51)
(defconst army_ready 52)

; Values for attack doctrine
(defconst doc_early_hide 0)
(defconst doc_early_defend_city 1)
(defconst doc_late_defence 10)
(defconst doc_late_offence 11)
(defconst doc_late_no_gold_offence 12)

; Enable attack timer, wall placement and doctrine
(defrule
	(true)
=>
	(enable-timer attack-timer time_to_initialize)
	(enable-wall-placement wall-perimeter)
	(set-doctrine doc_early_defend_city)
	(disable-self)
)

;==============-Research this pass? - segment-==================
; This goal is set to 1 if we want more town centers.
; Nothing will be researched when we need one.
(defconst want-more-town-centers 6)

; Decide if we need towncenters.
(defrule
	(true)
=>
	(set-goal want-more-town-centers 0)
)
(defrule
	(building-type-count-total town-center < 1)
=>
	(set-goal want-more-town-centers 1)
)
(defrule
	(building-type-count-total town-center < 2)
	(current-age >= castle-age)
=>
	(set-goal want-more-town-centers 1)
)

;==============-Research: Phase Advancement-====================
; Initialize phase.
(defrule
	(true)
=>
	(set-goal research_next_phase 0)
	(disable-self)
)

; When *all* phase 1 techs that will be researched 
; are researched we proceed to phase 2.
(defrule
	(not (goal research_next_phase 99))
	(current-age == imperial-age)
	(goal research_next_phase 0)
	(or (goal research_branch_city 0)
		(goal research_branch_city research_city_p1_last))
=>
	(set-goal research_next_phase 1)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 1)
	(or (goal research_branch_defence 0)
		(goal research_branch_defence research_defence_p1_last))
=>
	(set-goal research_next_phase 2)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 2)
	(or (goal research_branch_infantry 0)
		(goal research_branch_infantry research_infantry_p1_last))
=>
	(set-goal research_next_phase 3)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 3)
	(or (goal research_branch_archers 0)
		(goal research_branch_archers research_archers_p1_last))
=>
	(set-goal research_next_phase 4)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 4)
	(or (goal research_branch_cannon 0)
		(goal research_branch_cannon research_cannon_p1_last))
=>
	(set-goal research_next_phase 5)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 5)
	(or (goal research_branch_cavalry 0)
		(goal research_branch_cavalry research_cavalry_p1_last))
=>
	(set-goal research_next_phase 6)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 6)
	(or (goal research_branch_monks 0)
		(goal research_branch_monks research_monks_p1_last))
=>
	(set-goal research_next_phase 7)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 7)
	(or (goal research_branch_siege 0)
		(goal research_branch_siege research_siege_p1_last))
=>
	(set-goal research_next_phase 8)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 8)
	(or (goal research_branch_trade 0)
		(goal research_branch_trade research_trade_p1_last))
=>
	(set-goal research_next_phase 9)
)
; Some 'space' if we need more branches.
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 9)
=>
	(set-goal research_next_phase 10)
)
; Reset if research_next_phase is *not* 10.
(defrule
	(not (goal research_next_phase 99))
	(not (goal research_next_phase 10))
=>
	(set-goal research_next_phase 0)
)

; If research_next_phase is 10 we can proceed to phase 2.
(defrule
	(goal research_next_phase 10)
	(goal research_branch_city research_city_p1_last)
=>
	(set-goal research_branch_city 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_defence research_defence_p1_last)
=>
	(set-goal research_branch_defence 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_infantry research_infantry_p1_last)
=>
	(set-goal research_branch_infantry 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_archers research_archers_p1_last)
=>
	(set-goal research_branch_archers 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_cannon research_cannon_p1_last)
=>
	(set-goal research_branch_cannon 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_cavalry research_cavalry_p1_last)
=>
	(set-goal research_branch_cavalry 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_monks research_monks_p1_last)
=>
	(set-goal research_branch_monks 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_siege research_siege_p1_last)
=>
	(set-goal research_branch_siege 17)
	(disable-self)
)
(defrule
	(goal research_next_phase 10)
	(goal research_branch_trade research_trade_p1_last)
=>
	(set-goal research_branch_siege 17)
	(disable-self)
)

; When *all* phase 2 techs are researched 
; we proceed to phase 3.
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 10)
	(or (goal research_branch_city 0)
		(goal research_branch_city research_city_p2_last))
=>
	(set-goal research_next_phase 11)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 11)
	(or (goal research_branch_defence 0)
		(goal research_branch_defence research_defence_p2_last))
=>
	(set-goal research_next_phase 12)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 12)
	(or (goal research_branch_infantry 0)
		(goal research_branch_infantry research_infantry_p2_last))
=>
	(set-goal research_next_phase 13)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 13)
	(or (goal research_branch_archers 0)
		(goal research_branch_archers research_archers_p2_last))
=>
	(set-goal research_next_phase 14)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 14)
	(or (goal research_branch_cannon 0)
		(goal research_branch_cannon research_cannon_p2_last))
=>
	(set-goal research_next_phase 15)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 15)
	(or (goal research_branch_cavalry 0)
		(goal research_branch_cavalry research_cavalry_p2_last))
=>
	(set-goal research_next_phase 16)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 16)
	(or (goal research_branch_monks 0)
		(goal research_branch_monks research_monks_p2_last))
=>
	(set-goal research_next_phase 17)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 17)
	(or (goal research_branch_siege 0)
		(goal research_branch_siege research_siege_p2_last))
=>
	(set-goal research_next_phase 18)
)
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 18)
	(or (goal research_branch_trade 0)
		(goal research_branch_trade research_trade_p2_last))
=>
	(set-goal research_next_phase 19)
)
; Some 'space' if we need more branches.
(defrule
	(not (goal research_next_phase 99))
	(goal research_next_phase 19)
=>
	(set-goal research_next_phase 20)
)
; Reset if research_next_phase is *not* 20.
(defrule
	(not (goal research_next_phase 99))
	(not (goal research_next_phase 20))
=>
	(set-goal research_next_phase 10)
)

; If research_next_phase is 20 we can proceed to phase 3.
(defrule
	(goal research_next_phase 20)
	(goal research_branch_city research_city_p2_last)
=>
	(set-goal research_branch_city 33)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_defence research_defence_p2_last)
=>
	(set-goal research_branch_defence 33)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_infantry research_infantry_p2_last)
=>
	(set-goal research_branch_infantry 40)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_archers research_archers_p2_last)
=>
	(set-goal research_branch_archers 40)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_cannon research_cannon_p2_last)
=>
	(set-goal research_branch_cannon 33)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_cavalry research_cavalry_p2_last)
=>
	(set-goal research_branch_cavalry 40)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_monks research_monks_p2_last)
=>
	(set-goal research_branch_monks 33)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_siege research_siege_p2_last)
=>
	(set-goal research_branch_siege 33)
	(disable-self)
)
(defrule
	(goal research_next_phase 20)
	(goal research_branch_trade research_trade_p2_last)
=>
	(set-goal research_branch_trade 33)
	(disable-self)
)

; Stop the counting when we reach phase 3.
(defrule
	(goal research_next_phase 20)
=>
	(set-goal research_next_phase 99)
	(disable-self)
)
;===========-Economy: Initial Strategic Numbers-============
; Set initial strategic numbers
(defrule
	(true)
=>
	(set-strategic-number sn-percent-civilian-explorers 0)
	(set-strategic-number sn-percent-civilian-builders 0)
	(set-strategic-number sn-percent-civilian-gatherers 100)
	(set-strategic-number sn-cap-civilian-explorers 2000)
	(set-strategic-number sn-cap-civilian-builders 2000)
	(set-strategic-number sn-cap-civilian-gatherers 2000)
	(set-strategic-number sn-total-number-explorers 2000)
	(set-strategic-number sn-minimum-civilian-explorers 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-food-gatherer-percentage 100)
	(set-strategic-number sn-gold-gatherer-percentage 0)
	(set-strategic-number sn-stone-gatherer-percentage 0)
	(set-strategic-number sn-wood-gatherer-percentage 0)
	(set-strategic-number sn-number-enemy-objects-required 0)
	(set-strategic-number sn-retask-gather-amount 1)
	(set-strategic-number sn-max-retask-gather-amount 1)
	(set-strategic-number sn-initial-exploration-required 0)
	(set-strategic-number sn-use-by-type-max-gathering 1)
	(set-strategic-number sn-percent-half-exploration 100)
	(set-strategic-number sn-minimum-boar-hunt-group-size 8)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-minimum-town-size 10)
	(set-strategic-number sn-camp-max-distance first-dropsite-distance)
	(set-strategic-number sn-mill-max-distance first-dropsite-distance)
	(set-strategic-number sn-minimum-water-body-size-for-dock 144)
	(set-strategic-number sn-required-forest-tiles 5)
	(set-strategic-number sn-max-build-plan-gatherer-percentage 0)
	(set-strategic-number sn-food-dropsite-distance max-food-dropsite-distance)
	(set-strategic-number sn-wood-dropsite-distance max-wood-dropsite-distance)
	(set-strategic-number sn-stone-dropsite-distance max-stone-dropsite-distance)
	(set-strategic-number sn-gold-dropsite-distance max-gold-dropsite-distance)
	(set-strategic-number sn-minimum-dropsite-buffer buffer-dropsite-distance)
	(set-strategic-number sn-random-placement-factor 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-maximum-wood-drop-distance max-wood-dropsite-distance)
	(set-strategic-number sn-maximum-food-drop-distance max-food-dropsite-distance)
	(set-strategic-number sn-maximum-hunt-drop-distance max-hunt-dropsite-distance)
	(set-strategic-number sn-maximum-fish-boat-drop-distance -1)
	(set-strategic-number sn-maximum-gold-drop-distance max-gold-dropsite-distance)
	(set-strategic-number sn-maximum-stone-drop-distance max-stone-dropsite-distance)
	(set-strategic-number sn-build-frequency 1)
	(set-strategic-number sn-number-build-attempts-before-skip 25)
	(set-strategic-number sn-max-skips-per-attempt 10)
	(set-strategic-number sn-minimum-amount-for-trading 100)
	(disable-self)
)

;===========-Military: Initial Strategic Numbers-===========
; Set initial strategic numbers
(defrule
	(true)
=>
	(set-strategic-number sn-sentry-distance 0)
	(set-strategic-number sn-sentry-distance-variation 2)
	(set-strategic-number sn-number-attack-groups 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-number-explore-groups 0)
	(set-strategic-number sn-minimum-explore-group-size 1)
	(set-strategic-number sn-maximum-explore-group-size 1)
	(set-strategic-number sn-garrison-rams 1)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-relic-return-distance 10)
	(set-strategic-number sn-minimum-peace-like-level 85)
	(set-strategic-number sn-percent-exploration-required 100)
	(set-strategic-number sn-zero-priority-distance 50)
	(set-strategic-number sn-scaling-frequency 10)
	(set-strategic-number sn-save-scenario-information 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-hits-before-alliance-change 3)
	(set-strategic-number sn-attack-diplomacy-impact 10)
	(set-strategic-number sn-easiest-reaction-percentage 100)
	(set-strategic-number sn-easier-reaction-percentage 100)
	(set-strategic-number sn-track-player-history 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-attack-winning-player 0)
	(set-strategic-number sn-coop-share-information 1)
	(set-strategic-number sn-attack-winning-player-factor 0)
	(set-strategic-number sn-coop-share-attacking 1)
	(set-strategic-number sn-coop-share-attacking-interval 120)
	(set-strategic-number sn-percentage-explore-exterminators 0)
	(disable-self)
)
(defrule
	(true)
=>
	(set-strategic-number sn-allow-civilian-defense 1)
	(set-strategic-number sn-do-not-scale-for-difficulty-level 1)
	(set-strategic-number sn-gather-defense-units 0)
	(set-strategic-number sn-group-form-distance 1)
	(set-strategic-number sn-ignore-attack-group-under-attack 0)
	(set-strategic-number sn-consecutive-idle-unit-limit 0)
	(disable-self)
)

;===========-Initial Setup (Starting Age Dependant)-========
#load-if-defined DARK-AGE-START
(defrule
	(true)
=>
	(set-goal current-age-goal dark-age)
	(set-strategic-number sn-maximum-town-size 12)
	(disable-self)
)
#end-if
#load-if-defined FEUDAL-AGE-START
(defrule
	(true)
=>
	(set-goal current-age-goal feudal-age)
	(set-strategic-number sn-maximum-town-size 14)
	(disable-self)
)
#end-if
#load-if-defined CASTLE-AGE-START
(defrule
	(true)
=>
	(set-goal current-age-goal castle-age)
	(set-strategic-number sn-maximum-town-size 16)
	(disable-self)
)
#end-if
#load-if-defined IMPERIAL-AGE-START
(defrule
	(true)
=>
	(set-goal current-age-goal imperial-age)
	(set-strategic-number sn-maximum-town-size 20)
	(disable-self)
)
#end-if
#load-if-defined POST-IMPERIAL-AGE-START
(defrule
	(true)
=>
	(set-goal current-age-goal imperial-age)
	(set-strategic-number sn-maximum-town-size 20)
	(set-goal research_next_phase 99)			; No research necessary.
	(disable-self)
)
#end-if

;===========-Economy: Wood Emergency-=======================
; Decide if there's a wood emergency
(defrule
	(true)
=>
	(set-strategic-number sn-maximum-wood-drop-distance max-wood-dropsite-distance)
)
(defrule
	(or (wood-amount < 100)
		(building-type-count lumber-camp >= max-lumber-camps))
	(dropsite-min-distance wood > max-wood-dropsite-distance)
=>
	(set-strategic-number sn-maximum-wood-drop-distance emergency-wood-gather-distance)
)

;===========-Military: Exploration-=========================
; Decide if exploration is needed immediately.
(defconst need-to-explore-now 40)

(defrule
	(true)
=>
	(set-goal need-to-explore-now 0)
)
(defrule
	(or (map-type scandanavia)
		(not (resource-found food)))
	(game-time < 120)
=>
	(set-goal need-to-explore-now 100)
)

; Explore with villagers if needed.
(defrule
	(goal need-to-explore-now 100)
=>
	(set-strategic-number sn-percent-civilian-gatherers 0)
	(set-strategic-number sn-percent-civilian-explorers 100)
	(set-strategic-number sn-minimum-civilian-explorers 2000)
)
(defrule
	(goal need-to-explore-now 0)
=>
	(set-strategic-number sn-percent-civilian-gatherers 100)
	(set-strategic-number sn-percent-civilian-explorers 0)
	(set-strategic-number sn-minimum-civilian-explorers 0)
)

; Explore with Scout Cavalry/Eagle Warriors only.
; Only explore with one in the Imperial Age.
(defrule
	(unit-type-count scout_type <= 1)
=>
	(set-strategic-number sn-number-explore-groups 0)
)
(defrule
	(unit-type-count scout_type >= 1)
=>
	(set-strategic-number sn-number-explore-groups 1)
)
(defrule
	(not (goal current-age-goal imperial-age))
	(unit-type-count scout_type >= scouts-to-train)
=>
	(set-strategic-number sn-number-explore-groups scouts-to-train)
)

;===========-Economy / Military: No Gold Left-==============
; Decide if there is very little gold left on the map.

(defrule
	(game-time > 3600)
	(cc-players-unit-type-count 0 66 <= 6)	; Less than 7 gold mines
	(gold-amount <= 290)
=>
	(set-goal no_gold_limits 1)
	(chat-local-to-self "There's very little gold left")
	(disable-self)
)

;==============-Research: Need building for next age-===========
; Decide if we need building to research next age. If we do the
; goal is set to 1 and farming and some research is not allowed.
; (It's better to save the wood for the important building.)
(defconst build-limits 5)

; Initialize / Reinitilize
(defrule
	(true)
=>
	(set-goal build-limits 0)
)
(defrule
	(current-age == castle-age)
=>
	(set-goal build-limits 30)
)
(defrule
	(current-age == feudal-age)
=>
	(set-goal build-limits 20)
)
(defrule
	(current-age == dark-age)
=>
	(set-goal build-limits 10)
)

; Check for Dark Age buildings.
(defrule
	(goal build-limits 10)					; It's the Dark Age.
	(building-type-count-total mill > 0)		; We have a Mill.
=>
	(set-goal build-limits 11)				; We have 1 Dark Age building.
)
(defrule
	(goal build-limits 11)					; We do have a Mill.
	(building-type-count-total lumber-camp > 0)	; We have a Lumber Camp.
=>
	(set-goal build-limits 12)				; We have 2 Dark Age buildings.
)
(defrule
	(goal build-limits 10)					; We have no Mill.
	(building-type-count-total lumber-camp > 0)	; We have a Lumber Camp.
=>
	(set-goal build-limits 11)				; We have 1 Dark Age building.
)
(defrule
	(goal build-limits 11)
	(building-type-count-total mining-camp > 0)
=>
	(set-goal build-limits 12)
)
(defrule
	(goal build-limits 10)
	(building-type-count-total mining-camp > 0)
=>
	(set-goal build-limits 11)
)
(defrule
	(goal build-limits 11)
	(building-type-count-total barracks > 0)
=>
	(set-goal build-limits 12)
)
(defrule
	(goal build-limits 10)
	(building-type-count-total barracks > 0)
=>
	(set-goal build-limits 11)
)
(defrule
	(goal build-limits 11)
	(building-type-count-total dock > 0)
=>
	(set-goal build-limits 12)
)
(defrule
	(goal build-limits 10)
	(building-type-count-total dock > 0)
=>
	(set-goal build-limits 11)
)
(defrule
	(or (goal build-limits 10)	; We lack important building.
		(goal build-limits 11))
	(food-amount > 400)		; We don't want limited build too early.
=>
	(set-goal build-limits 1)		; Limited build 'on'.
)
(defrule
	(or (goal build-limits 10)		; We must reset if 
	(or (goal build-limits 11)		;  food < 400 or we have 
		(goal build-limits 12)))	;  the buildings we need.
=>
	(set-goal build-limits 0)		; Limited build 'off'.
)
; Check for Feudal Age buildings.
(defrule
	(goal build-limits 20)
	(building-type-count-total blacksmith > 0)
=>
	(set-goal build-limits 21)
)
(defrule
	(goal build-limits 21)
	(building-type-count-total market > 0)
=>
	(set-goal build-limits 22)
)
(defrule
	(goal build-limits 20)
	(building-type-count-total market > 0)
=>
	(set-goal build-limits 21)
)
(defrule
	(goal build-limits 21)
	(building-type-count-total stable > 0)
=>
	(set-goal build-limits 22)
)
(defrule
	(goal build-limits 20)
	(building-type-count-total stable > 0)
=>
	(set-goal build-limits 21)
)
(defrule
	(goal build-limits 21)
	(building-type-count-total archery-range > 0)
=>
	(set-goal build-limits 22)
)
(defrule
	(goal build-limits 20)
	(building-type-count-total archery-range > 0)
=>
	(set-goal build-limits 21)
)
(defrule
	(or (goal build-limits 20)
		(goal build-limits 21))
=>
	(set-goal build-limits 1)
)
(defrule
	(goal build-limits 22)
=>
	(set-goal build-limits 0)
)
; Check for Castle Age buildings.
(defrule
	(goal build-limits 30)
	(building-type-count-total monastery > 0)
=>
	(set-goal build-limits 31)
)
(defrule
	(goal build-limits 31)
	(building-type-count-total university > 0)
=>
	(set-goal build-limits 32)
)
(defrule
	(goal build-limits 30)
	(building-type-count-total university > 0)
=>
	(set-goal build-limits 31)
)
(defrule
	(goal build-limits 31)
	(building-type-count-total siege-workshop > 0)
=>
	(set-goal build-limits 32)
)
(defrule
	(goal build-limits 30)
	(building-type-count-total siege-workshop > 0)
=>
	(set-goal build-limits 31)
)
(defrule
	(or (goal build-limits 30)			; You only need *one* Castle.
		(goal build-limits 31))
	(building-type-count-total castle > 0)
=>
	(set-goal build-limits 32)
)
(defrule
	(or (goal build-limits 30)
		(goal build-limits 31))
=>
	(set-goal build-limits 1)
)
(defrule
	(goal build-limits 32)
=>
	(set-goal build-limits 0)
)

;===========-Research: Next Age-============================
; FEUDAL AGE
; Advance to the Feudal Age when available.
(defrule
	(goal current-age-goal dark-age)
	(food-amount < 500)
	(unit-type-count villager >= dark_age_vills)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(current-age == dark-age)
	(food-amount >= 500)
	(unit-type-count villager >= dark_age_vills)
	(can-research feudal-age)
=>
	(research feudal-age)
	(set-goal current-age-goal feudal-age)
	(set-strategic-number sn-maximum-town-size 14)
)

; CASTLE AGE
; Advance to the Castle Age when available.
(defrule
	(goal current-age-goal feudal-age)
	(food-amount < 800)
	(unit-type-count villager >= feudal_age_vills)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal current-age-goal feudal-age)
	(gold-amount < 200)
	(unit-type-count villager >= feudal_age_vills)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(current-age == feudal-age)
	(food-amount >= 800)
	(gold-amount >= 200)
	(unit-type-count villager >= feudal_age_vills)
	(can-research castle-age)
=>
	(research castle-age)
	(set-goal current-age-goal castle-age)
	(set-strategic-number sn-maximum-town-size 16)
)

; IMPERIAL AGE
; Advance to the Imperial Age.
(defrule
	(goal current-age-goal castle-age)
	(food-amount < 1000)
	(unit-type-count villager >= castle_age_vills)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal current-age-goal castle-age)
	(gold-amount < 800)
	(unit-type-count villager >= castle_age_vills)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(current-age == castle-age)
	(food-amount >= 1000)
	(gold-amount >= 800)
	(unit-type-count villager >= castle_age_vills)
	(can-research imperial-age)
=>
	(research imperial-age)
	(set-goal current-age-goal imperial-age)
	(set-strategic-number sn-maximum-town-size 20)
)

;===========-Buildings: Building-===========================
; TOWN CENTER
; We must have at least one Town Center.
(defrule
	(goal want-more-town-centers 1)
	(wood-amount < 275)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 1)
	(stone-amount < 100)
=>
	(set-goal need-stone-goal 1)
	(set-goal escrow-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 1)
	(can-build-with-escrow town-center)
=>
	(release-escrow wood)
	(release-escrow stone)
	(build town-center)
)

; We always wanna have stone if we loose our town center.
(defrule
	(current-age >= castle-age)
	(building-type-count-total town-center < 2)
	(stone-amount < 100)
=>
	(set-goal need-stone-goal 1)
)

; Build extra Town Centers when everything else is built.
(defrule
	(building-type-count-total town-center < town-centers-to-build)
	(building-type-count-total barracks >= barracks-to-build)
	(building-type-count-total stable >= stables-to-build)
	(building-type-count-total archery-range >= archery-ranges-to-build)
	(building-type-count-total monastery >= monasteries-to-build)
	(building-type-count-total siege-workshop >= siege-workshops-to-build)
	(building-available town-center)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(wood-amount < 275)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(building-type-count-total town-center < town-centers-to-build)
	(building-type-count-total barracks >= barracks-to-build)
	(building-type-count-total stable >= stables-to-build)
	(building-type-count-total archery-range >= archery-ranges-to-build)
	(building-type-count-total monastery >= monasteries-to-build)
	(building-type-count-total siege-workshop >= siege-workshops-to-build)
	(building-available town-center)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(stone-amount < 100)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(building-type-count-total town-center < town-centers-to-build)
	(building-type-count-total barracks >= barracks-to-build)
	(building-type-count-total stable >= stables-to-build)
	(building-type-count-total archery-range >= archery-ranges-to-build)
	(building-type-count-total monastery >= monasteries-to-build)
	(building-type-count-total siege-workshop >= siege-workshops-to-build)
	(building-available town-center)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(can-build town-center)
=>
	(build town-center)
)

; HOUSES
; Always have extra houses.
(defrule
	(goal want-more-town-centers 0)
	(not (civ-selected hun))
	(or (and (housing-headroom < min-extra-housing-early)
			(current-age != imperial-age))
		(and (housing-headroom < min-extra-housing-late)
			(goal current-age-goal imperial-age)))
	(wood-amount < 30)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (and (housing-headroom < min-extra-housing-early)
			(current-age != imperial-age))
		(and (housing-headroom < min-extra-housing-late)
			(goal current-age-goal imperial-age)))
	(can-build house)
=>
	(build house)
)

; MILL
; Need a Mill for Farms and berries.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill < 1)
	(or (resource-found food)
		(game-time > 120))
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill < 1)
	(or (resource-found food)
		(game-time > 120))
	(can-build-with-escrow mill)
=>
	(release-escrow wood)
	(build mill)
)

; FARMS
; Decide if new farms should be allowed. Town centers and buildings needed
; for age advancement have priority.
; A mill is needed first, and wood is reserved for a lumber camp.
; We need to farm if there are no other sources of food.
; Also start farming when there are enough villagers to keep
; producing food for villagers while gathering wood.
; Start collecting wood if that is holding us back.
(defconst allow-farming 39)

(defrule
	(true)
=>
	(set-goal allow-farming 0)
)
(defrule
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(building-type-count-total mill > 0)
	(or (building-type-count-total lumber-camp > 0)
		(wood-amount >= 160))
	(or (map-type scandanavia)
	(or (unit-type-count-total villager > 15)
		(sheep-and-forage-too-far)))
=>
	(set-goal allow-farming 1)
)

; Make a farm if none is idle.
(defrule
	(goal allow-farming 1)
	(idle-farm-count < 1)
	(wood-amount < 60)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal allow-farming 1)
	(idle-farm-count < 1)
	(can-build farm)
=>
	(build farm)
)

; LUMBER CAMP
; Build a Lumber Camp.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total lumber-camp < 1)
	(game-time > 130)
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)	
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total lumber-camp < 1)
	(game-time > 130)
	(can-build-with-escrow lumber-camp)
=>
	(release-escrow wood)
	(set-strategic-number sn-camp-max-distance 12)
	(build lumber-camp)
)

; Build Lumber Camp if too far away.
(defrule
	(goal want-more-town-centers 0)
	(game-time > 20)
	(building-type-count-total lumber-camp < max-lumber-camps)
	(dropsite-min-distance wood > max-wood-dropsite-distance)
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(game-time > 20)
	(building-type-count-total mill >= 1)
	(building-type-count-total lumber-camp < max-lumber-camps)
	(building-type-count-total lumber-camp < 4)
	(dropsite-min-distance wood > max-wood-dropsite-distance)
	(can-build lumber-camp)
=>
	(set-strategic-number sn-camp-max-distance first-dropsite-distance)
	(build lumber-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(game-time > 20)
	(building-type-count-total lumber-camp < max-lumber-camps)
	(building-type-count-total lumber-camp >= 4)
	(building-type-count-total lumber-camp < 8)
	(dropsite-min-distance wood > max-wood-dropsite-distance)
	(can-build lumber-camp)
=>
	(set-strategic-number sn-camp-max-distance second-dropsite-distance)
	(build lumber-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(game-time > 20)
	(building-type-count-total lumber-camp < max-lumber-camps)
	(building-type-count-total lumber-camp >= 8)
	(building-type-count-total lumber-camp < 12)
	(dropsite-min-distance wood > max-wood-dropsite-distance)
	(can-build lumber-camp)
=>
	(set-strategic-number sn-camp-max-distance third-dropsite-distance)
	(build lumber-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(game-time > 20)
	(building-type-count-total lumber-camp < max-lumber-camps)
	(building-type-count-total lumber-camp >= 12)
	(dropsite-min-distance wood > max-wood-dropsite-distance)
	(can-build lumber-camp)
=>
	(set-strategic-number sn-camp-max-distance fourth-dropsite-distance)
	(build lumber-camp)
)

; MINING CAMP
; Build Mining Camps if too far away.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total mining-camp < max-mining-camps)
	(or (and (goal needed-gold-goal 1)
			(dropsite-min-distance gold > max-gold-dropsite-distance))
		(and (goal needed-stone-goal 1)
			(dropsite-min-distance stone > max-stone-dropsite-distance)))
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total lumber-camp > 0)
	(building-type-count-total mining-camp < 1)
	(resource-found gold)
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance first-dropsite-distance)
	(build mining-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total lumber-camp > 0)
	(building-type-count-total mining-camp < 2)
	(resource-found stone)
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance first-dropsite-distance)
	(build mining-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total mining-camp < max-mining-camps)
	(building-type-count-total mining-camp < 4)
	(or (and (goal needed-gold-goal 1)
			(dropsite-min-distance gold > max-gold-dropsite-distance))
		(and (goal needed-stone-goal 1)
			(dropsite-min-distance stone > max-stone-dropsite-distance)))
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance first-dropsite-distance)
	(build mining-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total mining-camp < max-mining-camps)
	(building-type-count-total mining-camp >= 4)
	(building-type-count-total mining-camp < 8)
	(or (and (goal needed-gold-goal 1)
			(dropsite-min-distance gold > max-gold-dropsite-distance))
		(and (goal needed-stone-goal 1)
			(dropsite-min-distance stone > max-stone-dropsite-distance)))
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance second-dropsite-distance)
	(build mining-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total mining-camp < max-mining-camps)
	(building-type-count-total mining-camp >= 8)
	(building-type-count-total mining-camp < 12)
	(or (and (goal needed-gold-goal 1)
			(dropsite-min-distance gold > max-gold-dropsite-distance))
		(and (goal needed-stone-goal 1)
			(dropsite-min-distance stone > max-stone-dropsite-distance)))
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance third-dropsite-distance)
	(build mining-camp)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total mill > 0)
	(building-type-count-total mining-camp < max-mining-camps)
	(building-type-count-total mining-camp >= 12)
	(building-type-count-total mining-camp < 16)
	(or (and (goal needed-gold-goal 1)
			(dropsite-min-distance gold > max-gold-dropsite-distance))
		(and (goal needed-stone-goal 1)
			(dropsite-min-distance stone > max-stone-dropsite-distance)))
	(can-build mining-camp)
=>
	(set-strategic-number sn-camp-max-distance fourth-dropsite-distance)
	(build mining-camp)
)

; BLACKSMITH
; Build a Blacksmith when available with escrow.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total blacksmith < 1)
	(building-available blacksmith)
	(wood-amount < 150)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total blacksmith < 1)
	(can-build-with-escrow blacksmith)
=>
	(release-escrow wood)
	(build blacksmith)
)

; Build the rest of the Blacksmiths in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total blacksmith < blacksmiths-to-build)
	(building-available blacksmith)
	(wood-amount < 150)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total blacksmith < blacksmiths-to-build)
	(can-build-with-escrow blacksmith)
=>
	(release-escrow wood)
	(build blacksmith)
)

; BARRACKS
; Build a Barracks when available, but not 'till we've begun to
;  research Feudal Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal feudal-age)
		(goal current-age-goal castle-age))
	(building-type-count-total barracks < 1)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal feudal-age)
		(goal current-age-goal castle-age))
	(building-type-count-total barracks < 1)
	(can-build barracks)
=>
	(build barracks)
)

; Build the rest of the Barracks in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total barracks < barracks-to-build)
	(building-available barracks)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total barracks < barracks-to-build)
	(can-build barracks)
=>
	(build barracks)
)

; STABLE
; Build a Stable when available with escrow.
(defrule
	(goal want-more-town-centers 0)
	(building-available stable)
	(building-type-count-total stable < 1)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total stable < 1)
	(can-build-with-escrow stable)
=>
	(release-escrow wood)
	(build stable)
)

; Build the rest of the Stables in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total stable < stables-to-build)
	(building-available stable)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total stable < stables-to-build)
	(can-build stable)
=>
	(build stable)
)

; ARCHERY RANGE
; Build an Archery Range when available with escrow if 'on'.
(defrule
	(goal want-more-town-centers 0)
	(building-available archery-range)
	(building-type-count-total archery-range < 1)
	(building-type-count-total archery-range < archery-ranges-to-build)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total archery-range < 1)
	(building-type-count-total archery-range < archery-ranges-to-build)
	(can-build-with-escrow archery-range)
=>
	(release-escrow wood)
	(build archery-range)
)

; Build the rest of the Archery Ranges in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total archery-range < archery-ranges-to-build)
	(building-available archery-range)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total archery-range < archery-ranges-to-build)
	(can-build archery-range)
=>
	(build archery-range)
)

; MARKET
; Build a Market when available with escrow.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total market < 1)
	(building-available market)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total market < 1)
	(can-build-with-escrow market)
=>
	(release-escrow wood)
	(build market)
)

; WALLS
; Build Gates for a Wall.
(defrule
	(goal want-more-town-centers 0)
	(building-available gate)
	(building-type-count-total gate < gates-to-build)
	(stone-amount < 30)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total gate < gates-to-build)
	(can-build-gate wall-perimeter)
	(not (town-under-attack))
=>
	(build-gate wall-perimeter)
)

; Build the Wall.
(defrule
	(goal want-more-town-centers 0)
	(building-available stone-wall-line)
	(wall-completed-percentage wall-perimeter < required-wall-percent)
	(stone-amount < 200)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal required-wall-percent))
	(can-build-wall wall-perimeter stone-wall-line)
	(not (town-under-attack))
=>
	(build-wall wall-perimeter stone-wall-line)
)

; CASTLE
; Build an early Castle with escrow if we will train Unique Units.
(defrule
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal unique-units-to-train))
	(building-type-count-total castle < 1)
	(building-available castle)
	(stone-amount < 650)
=>
	(set-goal need-stone-goal 1)
	(set-goal escrow-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(not (town-under-attack))
	(not (goal is-zero-goal unique-units-to-train))
	(building-type-count-total castle < 1)
	(can-build-with-escrow castle)
=>
	(release-escrow stone)
	(build castle)
)

; Build the rest of the Castles in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total castle < castles-to-build)
	(building-available castle)
	(stone-amount < 650)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(not (town-under-attack))
	(building-type-count-total castle < castles-to-build)
	(can-build castle)
=>
	(build castle)
)

; TOWERS
; Build Home Towers after the Wall (if we'll build wall).
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total watch-tower-line < home-towers-to-build)
	(wood-amount < 25)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total watch-tower-line < home-towers-to-build)
	(stone-amount < 125)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total watch-tower-line < home-towers-to-build)
	(can-build watch-tower-line)
	(not (town-under-attack))
=>
	(build watch-tower-line)
)

; Build Bombard Towers after the Wall and Castles are done.
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total castle >= castles-to-build)
	(building-available bombard-tower)
	(building-type-count-total bombard-tower < bombard-towers-to-build)
	(wood-amount < 25)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total castle >= castles-to-build)
	(building-available bombard-tower)
	(building-type-count-total bombard-tower < bombard-towers-to-build)
	(stone-amount < 125)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(wall-completed-percentage wall-perimeter >= required-wall-percent)
	(building-type-count-total castle >= castles-to-build)
	(building-type-count-total bombard-tower < bombard-towers-to-build)
	(can-build bombard-tower)
	(not (town-under-attack))
=>
	(build bombard-tower)
)

; UNIVERSITY
; Don't need a University if all research is done.
#load-if-not-defined POST-IMPERIAL-AGE-START

; Else, build a University when available with escrow.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total university < 1)
	(building-available university)
	(wood-amount < 200)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total university < 1)
	(can-build-with-escrow university)
=>
	(release-escrow wood)
	(build university)
)

#end-if

; MONASTERY
; Build a Monastery when available with escrow.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total monastery < 1)
	(building-available monastery)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(building-type-count-total monastery < 1)
	(can-build-with-escrow monastery)
=>
	(release-escrow wood)
	(build monastery)
)

; Build the rest of the Monasteries in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total monastery < monasteries-to-build)
	(building-available monastery)
	(wood-amount < 175)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total monastery < monasteries-to-build)
	(can-build monastery)
=>
	(build monastery)
)

; SIEGE WORKSHOP
; Build the Siege Workshops in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total siege-workshop < siege-workshops-to-build)
	(building-available siege-workshop)
	(wood-amount < 200)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total siege-workshop < siege-workshops-to-build)
	(can-build siege-workshop)
=>
	(build siege-workshop)
)

; DOCK
; Build Docks in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total dock < docks-to-build)
	(building-available dock)
	(wood-amount < 150)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total dock < docks-to-build)
	(can-build dock)
=>
	(build dock)
)

;===========-Military: Train Defence-=======================
; Train units for defence, but not when we've reached Imperial.
(defrule
	(current-age != imperial-age)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total defender-type < defenders-to-train)
	(food-amount < defender-food)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(current-age != imperial-age)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total defender-type < defenders-to-train)
	(wood-amount < defender-wood)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(current-age != imperial-age)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total defender-type < defenders-to-train)
	(gold-amount < defender-gold)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(current-age != imperial-age)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total defender-type < defenders-to-train)
	(can-train defender-type)
=>
	(train defender-type)
)

;==============-Research: Researching-=========================
; TOWNCENTER
; Research Loom when waiting for food or housing.
; Loom is always researched.
(defrule
	(unit-type-count villager >= 20)
	(can-research ri-loom)
=>
	(research ri-loom)
)

; Research Wheelbarrow (City)
(defrule
	(or (goal research_branch_city 3)
		(goal research_branch_city 53))
	(goal want-more-town-centers 0)
	(research-available ri-wheel-barrow)
	(food-amount < 175)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 3)
		(goal research_branch_city 53))
	(goal want-more-town-centers 0)
	(research-available ri-wheel-barrow)
	(wood-amount < 50)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 3)
	(goal want-more-town-centers 0)
	(can-research ri-wheel-barrow)
=>
	(research ri-wheel-barrow)
	(set-goal research_branch_city 54)
)
(defrule
	(goal research_branch_city 53)
	(goal want-more-town-centers 0)
	(can-research ri-wheel-barrow)
=>
	(research ri-wheel-barrow)
)
(defrule
	(or (goal research_branch_city 3)
		(goal research_branch_city 54))
	(research-completed ri-wheel-barrow)
=>
	(set-goal research_branch_city 4)
)
(defrule
	(goal research_branch_city 3)
	(building-type-count town-center >= 1)	
	(current-age >= feudal-age)
	(not (research-available ri-wheel-barrow))
=>
	(set-goal research_branch_city 4)
)

; Research Town Watch (City)
(defrule
	(or (goal research_branch_city 34)
		(goal research_branch_city 84))
	(goal want-more-town-centers 0)
	(research-available ri-town-watch)
	(food-amount < 75)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_city 34)
	(goal want-more-town-centers 0)
	(can-research ri-town-watch)
=>
	(research ri-town-watch)
	(set-goal research_branch_city 85)
)
(defrule
	(goal research_branch_city 84)
	(goal want-more-town-centers 0)
	(can-research ri-town-watch)
=>
	(research ri-town-watch)
)
(defrule
	(or (goal research_branch_city 34)
		(goal research_branch_city 85))
	(research-completed ri-town-watch)
=>
	(set-goal research_branch_city 35)
)
(defrule
	(goal research_branch_city 34)
	(building-type-count town-center >= 1)	
	(current-age >= feudal-age)
	(not (research-available ri-town-watch))
=>
	(set-goal research_branch_city 35)
)

; Research Hand Cart but not if limited build (City)
(defrule
	(or (goal research_branch_city 6)
		(goal research_branch_city 56))
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(research-available ri-hand-cart)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 6)
		(goal research_branch_city 56))
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(research-available ri-hand-cart)
	(wood-amount < 200)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 6)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-hand-cart)
=>
	(research ri-hand-cart)
	(set-goal research_branch_city 57)
)
(defrule
	(goal research_branch_city 56)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-hand-cart)
=>
	(research ri-hand-cart)
)
(defrule
	(or (goal research_branch_city 6)
		(goal research_branch_city 57))
	(research-completed ri-hand-cart)
=>
	(set-goal research_branch_city 7)
)
(defrule
	(goal research_branch_city 6)
	(building-type-count town-center >= 1)
	(current-age >= castle-age)
	(research-completed ri-wheel-barrow)
	(not (research-available ri-hand-cart))
=>
	(set-goal research_branch_city 7)
)

; LUMBER CAMP
; Research Double-Bit Axe (City)
(defrule
	(or (goal research_branch_city 1)
		(goal research_branch_city 51))
	(goal want-more-town-centers 0)
	(research-available ri-double-bit-axe)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 1)
		(goal research_branch_city 51))
	(goal want-more-town-centers 0)
	(research-available ri-double-bit-axe)
	(wood-amount < 50)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 1)
	(goal want-more-town-centers 0)
	(can-research ri-double-bit-axe)
=>
	(research ri-double-bit-axe)
	(set-goal research_branch_city 52)
)
(defrule
	(goal research_branch_city 51)
	(goal want-more-town-centers 0)
	(can-research ri-double-bit-axe)
=>
	(research ri-double-bit-axe)
)
(defrule
	(or (goal research_branch_city 1)
		(goal research_branch_city 52))
	(research-completed ri-double-bit-axe)
=>
	(set-goal research_branch_city 2)
)

(defrule
	(goal research_branch_city 1)
	(building-type-count lumber-camp >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-double-bit-axe))
=>
	(set-goal research_branch_city 2)
)

; Research Bow Saw but not if limited build (City)
(defrule
	(or (goal research_branch_city 7)
		(goal research_branch_city 57))
	(goal want-more-town-centers 0)
	(research-available ri-bow-saw)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 7)
		(goal research_branch_city 57))
	(goal want-more-town-centers 0)
	(research-available ri-bow-saw)
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
)
(defrule
 	(goal research_branch_city 7)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-bow-saw)
=>
	(research ri-bow-saw)
	(set-goal research_branch_city 58)
)
(defrule
	(goal research_branch_city 57)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-bow-saw)
=>
	(research ri-bow-saw)
)
(defrule
	(or (goal research_branch_city 7)
		(goal research_branch_city 58))
	(research-completed ri-bow-saw)
=>
	(set-goal research_branch_city 8)
)
(defrule
	(goal research_branch_city 7)
	(building-type-count lumber-camp >= 1)
	(current-age >= castle-age)
	(research-completed ri-double-bit-axe)
	(not (research-available ri-bow-saw))
=>
	(set-goal research_branch_city 8)
)

; Research Two-Man Saw but not if limited build (City)
(defrule
	(or (goal research_branch_city 33)
		(goal research_branch_city 83))
	(goal want-more-town-centers 0)
	(research-available ri-two-man-saw)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
 	(or (goal research_branch_city 33)
		(goal research_branch_city 83))
	(goal want-more-town-centers 0)
	(research-available ri-two-man-saw)
	(wood-amount < 200)
=>
	(set-goal need-wood-goal 1)
)
(defrule
 	(goal research_branch_city 33)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-two-man-saw)
=>
	(research ri-two-man-saw)
	(set-goal research_branch_city 84)
)
(defrule
	(goal research_branch_city 83)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-two-man-saw)
=>
	(research ri-two-man-saw)
)
(defrule
	(or (goal research_branch_city 33)
		(goal research_branch_city 84))
	(research-completed ri-two-man-saw)
=>
	(set-goal research_branch_city 34)
)
(defrule
	(goal research_branch_city 33)
	(building-type-count lumber-camp >= 1)
	(current-age >= imperial-age)
	(research-completed ri-double-bit-axe)
	(research-completed ri-bow-saw)
	(not (research-available ri-two-man-saw))
=>
	(set-goal research_branch_city 34)
)

; MILL
; Research Horse Collar (City)
(defrule
	(or (goal research_branch_city 2)
		(goal research_branch_city 52))
	(goal want-more-town-centers 0)
	(research-available ri-horse-collar)
	(food-amount < 75)
=>
	(set-goal need-food-goal 1)
)
 (defrule
 	(or (goal research_branch_city 2)
		(goal research_branch_city 52))
	(goal want-more-town-centers 0)
	(research-available ri-horse-collar)
	(wood-amount < 75)
=>
	(set-goal need-wood-goal 1)
)
 (defrule
	(goal research_branch_city 2)
	(goal want-more-town-centers 0)
	(can-research ri-horse-collar)
=>
	(research ri-horse-collar)
	(set-goal research_branch_city 53)
)
(defrule
	(goal research_branch_city 52)
	(goal want-more-town-centers 0)
	(can-research ri-horse-collar)
=>
	(research ri-horse-collar)
)
(defrule
	(or (goal research_branch_city 2)
		(goal research_branch_city 53))
	(research-completed ri-horse-collar)
=>
	(set-goal research_branch_city 3)
)

(defrule
	(goal research_branch_city 2)
	(building-type-count mill >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-horse-collar))
=>
	(set-goal research_branch_city 3)
)

; Research Heavy Plow but not if limited build (City)
(defrule
 	(or (goal research_branch_city 9)
		(goal research_branch_city 59))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-plow)
	(food-amount < 125)
=>
	(set-goal need-food-goal 1)
)
 (defrule
 	(or (goal research_branch_city 9)
		(goal research_branch_city 59))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-plow)
	(wood-amount < 125)
=>
	(set-goal need-wood-goal 1)
)
 (defrule
 	(goal research_branch_city 9)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-heavy-plow)
=>
	(research ri-heavy-plow)
	(set-goal research_branch_city 60)
)
(defrule
	(goal research_branch_city 59)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-heavy-plow)
=>
	(research ri-heavy-plow)
)
(defrule
	(or (goal research_branch_city 9)
		(goal research_branch_city 60))
	(research-completed ri-heavy-plow)
=>
	(set-goal research_branch_city 10)
)

(defrule
	(goal research_branch_city 9)
	(building-type-count mill >= 1)
	(current-age >= castle-age)
	(research-completed ri-horse-collar)
	(not (research-available ri-heavy-plow))
=>
	(set-goal research_branch_city 10)
)

; Research Crop Rotation but not if limited build (City)
(defrule
 	(or (goal research_branch_city 35)
		(goal research_branch_city 85))
	(goal want-more-town-centers 0)
	(research-available ri-crop-rotation)
	(food-amount < 250)
=>
	(set-goal need-food-goal 1)
)
 (defrule
  	(or (goal research_branch_city 35)
		(goal research_branch_city 85))
	(goal want-more-town-centers 0)
	(research-available ri-crop-rotation)
	(wood-amount < 250)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 35)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-crop-rotation)
=>
	(research ri-crop-rotation)
	(set-goal research_branch_city 86)
)
(defrule
	(goal research_branch_city 85)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-crop-rotation)
=>
	(research ri-crop-rotation)
)
(defrule
	(or (goal research_branch_city 35)
		(goal research_branch_city 86))
	(research-completed ri-crop-rotation)
=>
	(set-goal research_branch_city 36)
)
(defrule
	(goal research_branch_city 35)
	(building-type-count mill >= 1)
	(current-age >= imperial-age)
	(research-completed ri-horse-collar)
	(research-completed ri-heavy-plow)
	(not (research-available ri-crop-rotation))
=>
	(set-goal research_branch_city 36)
)

; MINING CAMP
; Research Gold Mining (City)
(defrule
	(or (goal research_branch_city 4)
		(goal research_branch_city 54))
	(goal want-more-town-centers 0)
	(research-available ri-gold-mining)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 4)
		(goal research_branch_city 54))
	(goal want-more-town-centers 0)
	(research-available ri-gold-mining)
	(wood-amount < 75)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 4)
	(goal want-more-town-centers 0)
	(can-research ri-gold-mining)
=>
	(research ri-gold-mining)
	(set-goal research_branch_city 55)
)
(defrule
	(goal research_branch_city 54)
	(goal want-more-town-centers 0)
	(can-research ri-gold-mining)
=>
	(research ri-gold-mining)
)
(defrule
	(or (goal research_branch_city 4)
		(goal research_branch_city 55))
	(research-completed ri-gold-mining)
=>
	(set-goal research_branch_city 5)
)

(defrule
	(goal research_branch_city 4)
	(building-type-count mining-camp >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-gold-mining))
=>
	(set-goal research_branch_city 5)
)

; Research Stone Mining (City)
(defrule
	(or (goal research_branch_city 5)
		(goal research_branch_city 55))
	(goal want-more-town-centers 0)
	(research-available ri-stone-mining)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 5)
		(goal research_branch_city 55))
	(goal want-more-town-centers 0)
	(research-available ri-stone-mining)
	(wood-amount < 75)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 5)
	(goal want-more-town-centers 0)
	(can-research ri-stone-mining)
=>
	(research ri-stone-mining)
	(set-goal research_branch_city 56)
)
(defrule
	(goal research_branch_city 55)
	(goal want-more-town-centers 0)
	(can-research ri-stone-mining)
=>
	(research ri-stone-mining)
)
(defrule
	(or (goal research_branch_city 5)
		(goal research_branch_city 56))
	(research-completed ri-stone-mining)
=>
	(set-goal research_branch_city 6)
)
(defrule
	(goal research_branch_city 5)
	(building-type-count mining-camp >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-stone-mining))
=>
	(set-goal research_branch_city 6)
)

; Research Gold Shaft Mining but not if limited build (City)
(defrule
	(or (goal research_branch_city 8)
		(goal research_branch_city 58))
	(goal want-more-town-centers 0)
	(research-available ri-gold-shaft-mining)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 8)
		(goal research_branch_city 58))
	(goal want-more-town-centers 0)
	(research-available ri-gold-shaft-mining)
	(wood-amount < 150)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_city 8)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-gold-shaft-mining)
=>
	(research ri-gold-shaft-mining)
	(set-goal research_branch_city 59)
)
(defrule
	(goal research_branch_city 58)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-gold-shaft-mining)
=>
	(research ri-gold-shaft-mining)
)
(defrule
	(or (goal research_branch_city 8)
		(goal research_branch_city 59))
	(research-completed ri-gold-shaft-mining)
=>
	(set-goal research_branch_city 9)
)

(defrule
	(goal research_branch_city 8)
	(building-type-count town-center >= 1)
	(current-age >= castle-age)
	(research-completed ri-gold-mining)
	(not (research-available ri-gold-shaft-mining))
=>
	(set-goal research_branch_city 9)
)

; Research Stone Shaft Mining but not if limited build (City)
(defrule
	(or (goal research_branch_city 36)
		(goal research_branch_city 86))
	(goal want-more-town-centers 0)
	(research-available ri-stone-shaft-mining)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 36)
		(goal research_branch_city 86))
	(goal want-more-town-centers 0)
	(research-available ri-stone-shaft-mining)
	(wood-amount < 150)
=>
	(set-goal need-wood-goal 1)
)
 (defrule
	(goal research_branch_city 36)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-stone-shaft-mining)
=>
	(research ri-stone-shaft-mining)
	(set-goal research_branch_city 87)
)
(defrule
	(goal research_branch_city 86)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-stone-shaft-mining)
=>
	(research ri-stone-shaft-mining)
)
(defrule
	(or (goal research_branch_city 36)
		(goal research_branch_city 87))
	(research-completed ri-stone-shaft-mining)
=>
	(set-goal research_branch_city 37)
)
(defrule
	(goal research_branch_city 36)
	(building-type-count town-center >= 1)
	(current-age >= castle-age)
	(research-completed ri-stone-mining)
	(not (research-available ri-stone-shaft-mining))
=>
	(set-goal research_branch_city 37)
)

; UNIVERSITY
; Upgrade Walls if built (Defence)
(defrule
	(or (goal research_branch_defence 17)
		(goal research_branch_defence 67))
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal required-wall-percent))
	(research-available ri-fortified-wall)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_defence 17)
		(goal research_branch_defence 67))
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal required-wall-percent))
	(research-available ri-fortified-wall)
	(stone-amount < 100)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal research_branch_defence 17)
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal required-wall-percent))
	(can-research ri-fortified-wall)
=>
	(research ri-fortified-wall)
	(set-goal research_branch_defence 68)
)
(defrule
	(goal research_branch_defence 67)
	(goal want-more-town-centers 0)
	(not (goal is-zero-goal required-wall-percent))
	(can-research ri-fortified-wall)
=>
	(research ri-fortified-wall)
)
(defrule
	(or (goal research_branch_defence 17)
		(goal research_branch_defence 68))
	(or (research-completed ri-fortified-wall)
		(goal is-zero-goal required-wall-percent))
=>
	(set-goal research_branch_defence 18)
)
(defrule
	(goal research_branch_defence 17)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-fortified-wall))
=>
	(set-goal research_branch_defence 18)
)

; Upgrade to Guard Towers if 'on' (Defence)
(defrule
	(goal is_one_goal research_twig_towers)
	(or (goal research_branch_defence 39)
		(goal research_branch_defence 89))
	(goal want-more-town-centers 0)
	(research-available ri-guard-tower)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(or (goal research_branch_defence 39)
		(goal research_branch_defence 89))
	(goal want-more-town-centers 0)
	(research-available ri-guard-tower)
	(stone-amount < 250)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(goal research_branch_defence 39)
	(goal want-more-town-centers 0)
	(can-research ri-guard-tower)
=>
	(research ri-guard-tower)
	(set-goal research_branch_defence 90)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(goal research_branch_defence 89)
	(goal want-more-town-centers 0)
	(can-research ri-guard-tower)
=>
	(research ri-guard-tower)
)
(defrule
	(or (goal research_branch_defence 39)
		(goal research_branch_defence 90))
	(or (research-completed ri-guard-tower)
		(goal is-zero-goal research_twig_towers))
=>
	(set-goal research_branch_defence 40)
)
(defrule
	(goal research_branch_defence 39)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-guard-tower))
=>
	(set-goal research_branch_defence 40)
)

; Research Ballistics but not if limited build (Defence, Archers, Cannoneers)
(defrule
	(or	(or (goal research_branch_defence 34)
			(goal research_branch_defence 84))
	(or	(or (goal research_branch_archers 25)
			(goal research_branch_archers 75))
		(or (goal research_branch_cannon 21)
			(goal research_branch_cannon 71))))
	(goal want-more-town-centers 0)
	(research-available ri-ballistics)
	(wood-amount < 300)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(or	(or (goal research_branch_defence 34)
			(goal research_branch_defence 84))
	(or	(or (goal research_branch_archers 25)
			(goal research_branch_archers 75))
		(or (goal research_branch_cannon 21)
			(goal research_branch_cannon 71))))
	(goal want-more-town-centers 0)
	(research-available ri-ballistics)
	(gold-amount < 175)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_defence 34)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-ballistics)
=>
	(research ri-ballistics)
	(set-goal research_branch_defence 85)
)
(defrule
	(goal research_branch_archers 25)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-ballistics)
=>
	(research ri-ballistics)
	(set-goal research_branch_archers 76)
)
(defrule
	(goal research_branch_cannon 21)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-ballistics)
=>
	(research ri-ballistics)
	(set-goal research_branch_cannon 72)
)
(defrule
	(or (goal research_branch_defence 84)
	(or	(goal research_branch_archers 75)
		(goal research_branch_cannon 71)))
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-ballistics)
=>
	(research ri-ballistics)
)
(defrule
	(or (goal research_branch_defence 34)
		(goal research_branch_defence 85))
	(research-completed ri-ballistics)
=>
	(set-goal research_branch_defence 35)
)
(defrule
	(or (goal research_branch_archers 25)
		(goal research_branch_archers 76))
	(research-completed ri-ballistics)
=>
	(set-goal research_branch_archers 26)
)
(defrule
	(or (goal research_branch_cannon 21)
		(goal research_branch_cannon 72))
	(research-completed ri-ballistics)
=>
	(set-goal research_branch_cannon 22)
)
(defrule
	(goal research_branch_defence 34)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-ballistics))
=>
	(set-goal research_branch_defence 35)
)
(defrule
	(goal research_branch_archers 25)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-ballistics))
=>
	(set-goal research_branch_archers 26)
)
(defrule
	(goal research_branch_cannon 21)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-ballistics))
=>
	(set-goal research_branch_cannon 22)
)

; Research Murder Holes (Defence)
(defrule
	(or (goal research_branch_defence 18)
		(goal research_branch_defence 68))
	(goal want-more-town-centers 0)
	(research-available ri-murder-holes)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_defence 18)
		(goal research_branch_defence 68))
	(goal want-more-town-centers 0)
	(research-available ri-murder-holes)
	(stone-amount < 200)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal research_branch_defence 18)
	(goal want-more-town-centers 0)
	(can-research ri-murder-holes)
=>
	(research ri-murder-holes)
	(set-goal research_branch_defence 69)
)
(defrule
	(goal research_branch_defence 68)
	(goal want-more-town-centers 0)
	(can-research ri-murder-holes)
=>
	(research ri-murder-holes)
)
(defrule
	(or (goal research_branch_defence 18)
		(goal research_branch_defence 69))
	(research-completed ri-murder-holes)
=>
	(set-goal research_branch_defence 19)
)
(defrule
	(goal research_branch_defence 18)
	(building-type-count university >= 1)
	(current-age >= castle-age)
	(not (research-available ri-murder-holes))
=>
	(set-goal research_branch_defence 19)
)

; Research Chemistry with escrow (Defence, Archers, Cannoneers)
(defrule
	(or	(or (goal research_branch_defence 35)
			(goal research_branch_defence 85))
	(or	(or (goal research_branch_archers 28)
			(goal research_branch_archers 78))
		(or (goal research_branch_cannon 17)
			(goal research_branch_cannon 67))))
	(goal want-more-town-centers 0)
	(research-available ri-chemistry)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_defence 35)
			(goal research_branch_defence 85))
	(or	(or (goal research_branch_archers 28)
			(goal research_branch_archers 78))
		(or (goal research_branch_cannon 17)
			(goal research_branch_cannon 67))))
	(goal want-more-town-centers 0)
	(research-available ri-chemistry)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal research_branch_defence 35)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-chemistry)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-chemistry)
	(set-goal research_branch_defence 86)
)
(defrule
	(goal research_branch_archers 28)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-chemistry)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-chemistry)
	(set-goal research_branch_archers 79)
)
(defrule
	(goal research_branch_cannon 17)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-chemistry)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-chemistry)
	(set-goal research_branch_cannon 68)
)
(defrule
	(or	(goal research_branch_defence 85)
	(or	(goal research_branch_archers 78)
		(goal research_branch_cannon 67)))
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-chemistry)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-chemistry)
)
(defrule
	(or (goal research_branch_defence 35)
		(goal research_branch_defence 86))
	(research-completed ri-chemistry)
=>
	(set-goal research_branch_defence 36)
)
(defrule
	(or (goal research_branch_archers 28)
		(goal research_branch_archers 79))
	(research-completed ri-chemistry)
=>
	(set-goal research_branch_archers 29)
)
(defrule
	(or (goal research_branch_cannon 17)
		(goal research_branch_cannon 68))
	(research-completed ri-chemistry)
=>
	(set-goal research_branch_cannon 18)
)
(defrule
	(goal research_branch_defence 35)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-chemistry))
=>
	(set-goal research_branch_defence 36)
)
(defrule
	(goal research_branch_archers 28)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-chemistry))
=>
	(set-goal research_branch_archers 29)
)
(defrule
	(goal research_branch_cannon 17)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-chemistry))
=>
	(set-goal research_branch_cannon 18)
)

; Upgrade to Keep if towers 'on' (Defence)
(defrule
	(goal is_one_goal research_twig_towers)
	(or (goal research_branch_defence 40)
		(goal research_branch_defence 90))
	(goal want-more-town-centers 0)
	(research-available ri-keep)
	(food-amount < 500)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(or (goal research_branch_defence 40)
		(goal research_branch_defence 90))
	(goal want-more-town-centers 0)
	(research-available ri-keep)
	(stone-amount < 350)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(goal research_branch_defence 40)
	(goal want-more-town-centers 0)
	(can-research ri-keep)
=>
	(research ri-keep)
	(set-goal research_branch_defence 91)
)
(defrule
	(goal is_one_goal research_twig_towers)
	(goal research_branch_defence 90)
	(goal want-more-town-centers 0)
	(can-research ri-keep)
=>
	(research ri-keep)
)
(defrule
	(or (goal research_branch_defence 40)
		(goal research_branch_defence 91))
	(or (research-completed ri-keep)
		(goal is-zero-goal research_twig_towers))
=>
	(set-goal research_branch_defence 41)
)
(defrule
	(goal research_branch_defence 40)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-guard-tower)
		(not (research-available ri-guard-tower)))
	(not (research-available ri-keep))
=>
	(set-goal research_branch_defence 41)
)

; Research Bombard Tower if 'on' (Defence)
(defrule
	(goal is_one_goal research_twig_bombardtowers)
	(or (goal research_branch_defence 41)
		(goal research_branch_defence 91))
	(goal want-more-town-centers 0)
	(research-available ri-bombard-tower)
	(food-amount < 800)
=>
	(set-goal need-food-goal 1)
)
 (defrule
	(goal is_one_goal research_twig_bombardtowers)
	(or (goal research_branch_defence 41)
		(goal research_branch_defence 91))
	(goal want-more-town-centers 0)
	(research-available ri-bombard-tower)
	(stone-amount < 400)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal is_one_goal research_twig_bombardtowers)
	(goal research_branch_defence 41)
	(goal want-more-town-centers 0)
	(can-research ri-bombard-tower)
=>
	(research ri-bombard-tower)
	(set-goal research_branch_defence 92)
)
(defrule
	(goal is_one_goal research_twig_bombardtowers)
	(goal research_branch_defence 91)
	(goal want-more-town-centers 0)
	(can-research ri-bombard-tower)
=>
	(research ri-bombard-tower)
)
(defrule
	(or (goal research_branch_defence 41)
		(goal research_branch_defence 92))
	(or (research-completed ri-bombard-tower)
		(goal is-zero-goal research_twig_bombardtowers))
=>
	(set-goal research_branch_defence 42)
)
(defrule
	(goal research_branch_defence 41)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-chemistry)
		(not (research-available ri-chemistry)))
	(not (research-available ri-bombard-tower))
=>
	(set-goal research_branch_defence 42)
)

; Research Siege Engineers but not if limited build (Siege)
(defrule
	(or (goal research_branch_siege 34)
		(goal research_branch_siege 84))
	(goal want-more-town-centers 0)
	(research-available ri-siege-engineers)
	(food-amount < 500)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_siege 34)
		(goal research_branch_siege 84))
	(goal want-more-town-centers 0)
	(research-available ri-siege-engineers)
	(wood-amount < 600)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_siege 34)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-siege-engineers)
=>
	(research ri-siege-engineers)
	(set-goal research_branch_siege 85)
)
(defrule
	(goal research_branch_siege 84)
	(goal want-more-town-centers 0)
	(goal build-limits 0)
	(can-research ri-siege-engineers)
=>
	(research ri-siege-engineers)
)
(defrule
	(or (goal research_branch_siege 34)
		(goal research_branch_siege 85))
	(research-completed ri-siege-engineers)
=>
	(set-goal research_branch_siege 35)
)
(defrule
	(goal research_branch_siege 34)
	(building-type-count university >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-siege-engineers))
=>
	(set-goal research_branch_siege 35)
)

; BLACKSMITH
; Research Scale Barding Armor (Cavalry)
(defrule
	(or (goal research_branch_cavalry 17)
		(goal research_branch_cavalry 67))
	(goal want-more-town-centers 0)
	(research-available ri-scale-barding)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_cavalry 17)
	(goal want-more-town-centers 0)
	(can-research ri-scale-barding)
=>
	(research ri-scale-barding)
	(set-goal research_branch_cavalry 68)
)
(defrule
	(goal research_branch_cavalry 67)
	(goal want-more-town-centers 0)
	(can-research ri-scale-barding)
=>
	(research ri-scale-barding)
)
(defrule
	(or (goal research_branch_cavalry 17)
		(goal research_branch_cavalry 68))
	(research-completed ri-scale-barding)
=>
	(set-goal research_branch_cavalry 18)
)
(defrule
	(goal research_branch_cavalry 17)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-scale-barding))
=>
	(set-goal research_branch_cavalry 18)
)

; Research Chain Barding Armor (Cavalry)
(defrule
	(or (goal research_branch_cavalry 22)
		(goal research_branch_cavalry 72))
	(goal want-more-town-centers 0)
	(research-available ri-chain-barding)
	(food-amount < 250)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_cavalry 22)
		(goal research_branch_cavalry 72))
	(goal want-more-town-centers 0)
	(research-available ri-chain-barding)
	(gold-amount < 150)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_cavalry 22)
	(goal want-more-town-centers 0)
	(can-research ri-chain-barding)
=>
	(research ri-chain-barding)
	(set-goal research_branch_cavalry 73)
)
(defrule
	(goal research_branch_cavalry 72)
	(goal want-more-town-centers 0)
	(can-research ri-chain-barding)
=>
	(research ri-chain-barding)
)
(defrule
	(or (goal research_branch_cavalry 22)
		(goal research_branch_cavalry 73))
	(research-completed ri-chain-barding)
=>
	(set-goal research_branch_cavalry 23)
)
(defrule
	(goal research_branch_cavalry 22)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-scale-barding)
	(not (research-available ri-chain-barding))
=>
	(set-goal research_branch_cavalry 23)
)

; Research Plate Barding Armor (Cavalry)
(defrule
	(or (goal research_branch_cavalry 27)
		(goal research_branch_cavalry 77))
	(goal want-more-town-centers 0)
	(research-available ri-plate-barding)
	(food-amount < 350)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_cavalry 27)
		(goal research_branch_cavalry 77))
	(goal want-more-town-centers 0)
	(research-available ri-plate-barding)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_cavalry 27)
	(goal want-more-town-centers 0)
	(can-research ri-plate-barding)
=>
	(research ri-plate-barding)
	(set-goal research_branch_cavalry 78)
)
(defrule
	(goal research_branch_cavalry 77)
	(goal want-more-town-centers 0)
	(can-research ri-plate-barding)
=>
	(research ri-plate-barding)
)
(defrule
	(or (goal research_branch_cavalry 27)
		(goal research_branch_cavalry 78))
	(research-completed ri-plate-barding)
=>
	(set-goal research_branch_cavalry 28)
)
(defrule
	(goal research_branch_cavalry 27)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-scale-barding)
	(or (research-completed ri-chain-barding)
		(not (research-available ri-chain-barding)))
	(not (research-available ri-plate-barding))
=>
	(set-goal research_branch_cavalry 28)
)

; Research Forging (Infantry, Cavalry)
(defrule
	(or	(or (goal research_branch_infantry 22)
			(goal research_branch_infantry 72))
		(or (goal research_branch_cavalry 19)
			(goal research_branch_cavalry 69)))
	(goal want-more-town-centers 0)
	(research-available ri-forging)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_infantry 22)
	(goal want-more-town-centers 0)
	(can-research ri-forging)
=>
	(research ri-forging)
	(set-goal research_branch_infantry 73)
)
(defrule
	(goal research_branch_cavalry 19)
	(goal want-more-town-centers 0)
	(can-research ri-forging)
=>
	(research ri-forging)
	(set-goal research_branch_cavalry 70)
)
(defrule
	(or	(goal research_branch_infantry 72)
		(goal research_branch_cavalry 69))
	(goal want-more-town-centers 0)
	(can-research ri-forging)
=>
	(research ri-forging)
)
(defrule
	(or (goal research_branch_infantry 22)
		(goal research_branch_infantry 73))
	(research-completed ri-forging)
=>
	(set-goal research_branch_infantry 23)
)
(defrule
	(or (goal research_branch_cavalry 19)
		(goal research_branch_cavalry 70))
	(research-completed ri-forging)
=>
	(set-goal research_branch_cavalry 20)
)
(defrule
	(goal research_branch_infantry 22)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-forging))
=>
	(set-goal research_branch_infantry 23)
)
(defrule
	(goal research_branch_cavalry 19)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-forging))
=>
	(set-goal research_branch_cavalry 20)
)

; Research Iron Casting (Infantry, Cavalry)
(defrule
	(or	(or (goal research_branch_infantry 24)
			(goal research_branch_infantry 74))
		(or (goal research_branch_cavalry 25)
			(goal research_branch_cavalry 75)))
	(goal want-more-town-centers 0)
	(research-available ri-iron-casting)
	(food-amount < 220)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_infantry 24)
			(goal research_branch_infantry 74))
		(or (goal research_branch_cavalry 25)
			(goal research_branch_cavalry 75)))
	(goal want-more-town-centers 0)
	(research-available ri-iron-casting)
	(gold-amount < 120)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_infantry 24)
	(goal want-more-town-centers 0)
	(can-research ri-iron-casting)
=>
	(research ri-iron-casting)
	(set-goal research_branch_infantry 75)
)
(defrule
	(goal research_branch_cavalry 25)
	(goal want-more-town-centers 0)
	(can-research ri-iron-casting)
=>
	(research ri-iron-casting)
	(set-goal research_branch_cavalry 76)
)
(defrule
	(or	(goal research_branch_infantry 74)
		(goal research_branch_cavalry 75))
	(goal want-more-town-centers 0)
	(can-research ri-iron-casting)
=>
	(research ri-iron-casting)
)
(defrule
	(or (goal research_branch_infantry 24)
		(goal research_branch_infantry 75))
	(research-completed ri-iron-casting)
=>
	(set-goal research_branch_infantry 25)
)
(defrule
	(or (goal research_branch_cavalry 25)
		(goal research_branch_cavalry 76))
	(research-completed ri-iron-casting)
=>
	(set-goal research_branch_cavalry 26)
)
(defrule
	(goal research_branch_infantry 24)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-forging)
	(not (research-available ri-iron-casting))
=>
	(set-goal research_branch_infantry 25)
)
(defrule
	(goal research_branch_cavalry 25)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-forging)
	(not (research-available ri-iron-casting))
=>
	(set-goal research_branch_cavalry 26)
)

; Research Blast Furnace (Infantry, Cavalry)
(defrule
	(or	(or (goal research_branch_infantry 29)
			(goal research_branch_infantry 79))
		(or (goal research_branch_cavalry 31)
			(goal research_branch_cavalry 81)))
	(goal want-more-town-centers 0)
	(research-available ri-blast-furnace)
	(food-amount < 275)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_infantry 29)
			(goal research_branch_infantry 79))
		(or (goal research_branch_cavalry 31)
			(goal research_branch_cavalry 81)))
	(goal want-more-town-centers 0)
	(research-available ri-blast-furnace)
	(gold-amount < 225)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_infantry 29)
	(goal want-more-town-centers 0)
	(can-research ri-blast-furnace)
=>
	(research ri-blast-furnace)
	(set-goal research_branch_infantry 80)
)
(defrule
	(goal research_branch_cavalry 31)
	(goal want-more-town-centers 0)
	(can-research ri-blast-furnace)
=>
	(research ri-blast-furnace)
	(set-goal research_branch_cavalry 82)
)
(defrule
	(or	(goal research_branch_infantry 79)
		(goal research_branch_cavalry 81))
	(goal want-more-town-centers 0)
	(can-research ri-blast-furnace)
=>
	(research ri-blast-furnace)
)
(defrule
	(or (goal research_branch_infantry 29)
		(goal research_branch_infantry 80))
	(research-completed ri-blast-furnace)
=>
	(set-goal research_branch_infantry 30)
)
(defrule
	(or (goal research_branch_cavalry 31)
		(goal research_branch_cavalry 82))
	(research-completed ri-blast-furnace)
=>
	(set-goal research_branch_cavalry 32)
)
(defrule
	(goal research_branch_infantry 29)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-forging)
	(or (research-completed ri-iron-casting)
		(not (research-available ri-iron-casting)))
	(not (research-available ri-blast-furnace))
=>
	(set-goal research_branch_infantry 30)
)
(defrule
	(goal research_branch_cavalry 31)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-forging)
	(or (research-completed ri-iron-casting)
		(not (research-available ri-iron-casting)))
	(not (research-available ri-blast-furnace))
=>
	(set-goal research_branch_cavalry 32)
)

; Research Padded Archer Armor (Archers, Cannoneers)
(defrule
	(or	(or (goal research_branch_archers 21)
			(goal research_branch_archers 71))
		(or (goal research_branch_cannon 18)
			(goal research_branch_cannon 68)))
	(goal want-more-town-centers 0)
	(research-available ri-padded-archer-armor)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_archers 21)
	(goal want-more-town-centers 0)
	(can-research ri-padded-archer-armor)
=>
	(research ri-padded-archer-armor)
	(set-goal research_branch_archers 72)
)
(defrule
	(goal research_branch_cannon 18)
	(goal want-more-town-centers 0)
	(can-research ri-padded-archer-armor)
=>
	(research ri-padded-archer-armor)
	(set-goal research_branch_cannon 69)
)
(defrule
	(or	(goal research_branch_archers 71)
		(goal research_branch_cannon 68))
	(goal want-more-town-centers 0)
	(can-research ri-padded-archer-armor)
=>
	(research ri-padded-archer-armor)
)
(defrule
	(or (goal research_branch_archers 21)
		(goal research_branch_archers 72))
	(research-completed ri-padded-archer-armor)
=>
	(set-goal research_branch_archers 22)
)
(defrule
	(or (goal research_branch_cannon 18)
		(goal research_branch_cannon 69))
	(research-completed ri-padded-archer-armor)
=>
	(set-goal research_branch_cannon 19)
)
(defrule
	(goal research_branch_archers 21)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-padded-archer-armor))
=>
	(set-goal research_branch_archers 22)
)
(defrule
	(goal research_branch_cannon 18)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-padded-archer-armor))
=>
	(set-goal research_branch_cannon 19)
)

; Research Leather Archer Armor (Archers, Cannoneers)
(defrule
	(or	(or (goal research_branch_archers 24)
			(goal research_branch_archers 74))
		(or (goal research_branch_cannon 20)
			(goal research_branch_cannon 70)))
	(goal want-more-town-centers 0)
	(research-available ri-leather-archer-armor)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
 (defrule
	(or	(or (goal research_branch_archers 24)
			(goal research_branch_archers 74))
		(or (goal research_branch_cannon 20)
			(goal research_branch_cannon 70)))
	(goal want-more-town-centers 0)
	(research-available ri-leather-archer-armor)
	(gold-amount < 150)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_archers 24)
	(goal want-more-town-centers 0)
	(can-research ri-leather-archer-armor)
=>
	(research ri-leather-archer-armor)
	(set-goal research_branch_archers 75)
)
(defrule
	(goal research_branch_cannon 20)
	(goal want-more-town-centers 0)
	(can-research ri-leather-archer-armor)
=>
	(research ri-leather-archer-armor)
	(set-goal research_branch_cannon 71)
)
(defrule
	(or	(goal research_branch_archers 74)
		(goal research_branch_cannon 70))
	(goal want-more-town-centers 0)
	(can-research ri-leather-archer-armor)
=>
	(research ri-leather-archer-armor)
)
(defrule
	(or (goal research_branch_archers 24)
		(goal research_branch_archers 75))
	(research-completed ri-leather-archer-armor)
=>
	(set-goal research_branch_archers 25)
)
(defrule
	(or (goal research_branch_cannon 20)
		(goal research_branch_cannon 71))
	(research-completed ri-leather-archer-armor)
=>
	(set-goal research_branch_cannon 21)
)
(defrule
	(goal research_branch_archers 24)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-padded-archer-armor)
	(not (research-available ri-leather-archer-armor))
=>
	(set-goal research_branch_archers 25)
)
(defrule
	(goal research_branch_cannon 20)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-padded-archer-armor)
	(not (research-available ri-leather-archer-armor))
=>
	(set-goal research_branch_cannon 21)
)

; Research Ring Archer Armor (Archers, Cannoneers)
(defrule
	(or	(or (goal research_branch_archers 31)
			(goal research_branch_archers 81))
		(or (goal research_branch_cannon 22)
			(goal research_branch_cannon 72)))
	(goal want-more-town-centers 0)
	(research-available ri-ring-archer-armor)
	(food-amount < 250)
=>
	(set-goal need-food-goal 1)
)
 (defrule
	(or	(or (goal research_branch_archers 31)
			(goal research_branch_archers 81))
		(or (goal research_branch_cannon 22)
			(goal research_branch_cannon 72)))
	(goal want-more-town-centers 0)
	(research-available ri-ring-archer-armor)
	(gold-amount < 250)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_archers 31)
	(goal want-more-town-centers 0)
	(can-research ri-ring-archer-armor)
=>
	(research ri-ring-archer-armor)
	(set-goal research_branch_archers 82)
)
(defrule
	(goal research_branch_cannon 22)
	(goal want-more-town-centers 0)
	(can-research ri-ring-archer-armor)
=>
	(research ri-ring-archer-armor)
	(set-goal research_branch_cannon 73)
)
(defrule
	(or	(goal research_branch_archers 81)
		(goal research_branch_cannon 72))
	(goal want-more-town-centers 0)
	(can-research ri-ring-archer-armor)
=>
	(research ri-ring-archer-armor)
)
(defrule
	(or (goal research_branch_archers 31)
		(goal research_branch_archers 82))
	(research-completed ri-ring-archer-armor)
=>
	(set-goal research_branch_archers 32)
)
(defrule
	(or (goal research_branch_cannon 22)
		(goal research_branch_cannon 73))
	(research-completed ri-ring-archer-armor)
=>
	(set-goal research_branch_cannon 23)
)
(defrule
	(goal research_branch_archers 31)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-padded-archer-armor)
	(or (research-completed ri-leather-archer-armor)
		(not (research-available ri-leather-archer-armor)))
	(not (research-available ri-ring-archer-armor))
=>
	(set-goal research_branch_archers 32)
)
(defrule
	(goal research_branch_cannon 22)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-padded-archer-armor)
	(or (research-completed ri-leather-archer-armor)
		(not (research-available ri-leather-archer-armor)))
	(not (research-available ri-ring-archer-armor))
=>
	(set-goal research_branch_cannon 23)
)

; Research Scale Mail (Infantry)
(defrule
	(or (goal research_branch_infantry 20)
		(goal research_branch_infantry 70))
	(goal want-more-town-centers 0)
	(research-available ri-scale-mail)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_infantry 20)
	(goal want-more-town-centers 0)
	(can-research ri-scale-mail)
=>
	(research ri-scale-mail)
	(set-goal research_branch_infantry 71)
)
(defrule
	(goal research_branch_infantry 70)
	(goal want-more-town-centers 0)
	(can-research ri-scale-mail)
=>
	(research ri-scale-mail)
)
(defrule
	(or (goal research_branch_infantry 20)
		(goal research_branch_infantry 71))
	(research-completed ri-scale-mail)
=>
	(set-goal research_branch_infantry 21)
)
(defrule
	(goal research_branch_infantry 20)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-scale-mail))
=>
	(set-goal research_branch_infantry 21)
)

; Research Chain Mail (Infantry)
(defrule
	(or (goal research_branch_infantry 23)
		(goal research_branch_infantry 73))
	(goal want-more-town-centers 0)
	(research-available ri-chain-mail)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
 (defrule
	(or (goal research_branch_infantry 23)
		(goal research_branch_infantry 73))
	(goal want-more-town-centers 0)
	(research-available ri-chain-mail)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_infantry 23)
	(goal want-more-town-centers 0)
	(can-research ri-chain-mail)
=>
	(research ri-chain-mail)
	(set-goal research_branch_infantry 74)
)
(defrule
	(goal research_branch_infantry 73)
	(goal want-more-town-centers 0)
	(can-research ri-chain-mail)
=>
	(research ri-chain-mail)
)
(defrule
	(or (goal research_branch_infantry 23)
		(goal research_branch_infantry 74))
	(research-completed ri-chain-mail)
=>
	(set-goal research_branch_infantry 24)
)
(defrule
	(goal research_branch_infantry 23)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-scale-mail)
	(not (research-available ri-chain-mail))
=>
	(set-goal research_branch_infantry 24)
)

; Research Plate Mail (Infantry)
(defrule
	(or (goal research_branch_infantry 27)
		(goal research_branch_infantry 77))
	(goal want-more-town-centers 0)
	(research-available ri-plate-mail)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_infantry 27)
		(goal research_branch_infantry 77))
	(goal want-more-town-centers 0)
	(research-available ri-plate-mail)
	(gold-amount < 150)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_infantry 27)
	(goal want-more-town-centers 0)
	(can-research ri-plate-mail)
=>
	(research ri-plate-mail)
	(set-goal research_branch_infantry 78)
)
(defrule
	(goal research_branch_infantry 77)
	(goal want-more-town-centers 0)
	(can-research ri-plate-mail)
=>
	(research ri-plate-mail)
)
(defrule
	(or (goal research_branch_infantry 27)
		(goal research_branch_infantry 78))
	(research-completed ri-plate-mail)
=>
	(set-goal research_branch_infantry 28)
)
(defrule
	(goal research_branch_infantry 27)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-scale-mail)
	(research-completed ri-chain-mail)
	(not (research-available ri-plate-mail))
=>
	(set-goal research_branch_infantry 28)
)

; Research Fletching (Defence, Archers)
(defrule
	(or	(or (goal research_branch_defence 33)
			(goal research_branch_defence 83))
		(or (goal research_branch_archers 18)
			(goal research_branch_archers 68)))
	(goal want-more-town-centers 0)
	(research-available ri-fletching)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_defence 33)
			(goal research_branch_defence 83))
		(or (goal research_branch_archers 18)
			(goal research_branch_archers 68)))
	(goal want-more-town-centers 0)
	(research-available ri-fletching)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_defence 33)
	(goal want-more-town-centers 0)
	(can-research ri-fletching)
=>
	(research ri-fletching)
	(set-goal research_branch_defence 84)
)
(defrule
	(goal research_branch_archers 18)
	(goal want-more-town-centers 0)
	(can-research ri-fletching)
=>
	(research ri-fletching)
	(set-goal research_branch_archers 69)
)
(defrule
	(or	(goal research_branch_defence 83)
		(goal research_branch_archers 68))
	(goal want-more-town-centers 0)
	(can-research ri-fletching)
=>
	(research ri-fletching)
)
(defrule
	(or (goal research_branch_defence 33)
		(goal research_branch_defence 84))
	(research-completed ri-fletching)
=>
	(set-goal research_branch_defence 34)
)
(defrule
	(or (goal research_branch_archers 18)
		(goal research_branch_archers 69))
	(research-completed ri-fletching)
=>
	(set-goal research_branch_archers 19)
)
(defrule
	(goal research_branch_defence 33)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-fletching))
=>
	(set-goal research_branch_defence 34)
)
(defrule
	(goal research_branch_archers 18)
	(building-type-count blacksmith >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-fletching))
=>
	(set-goal research_branch_archers 19)
)

; Research Bodkin Arrow (Defence, Archers)
(defrule
	(or	(or (goal research_branch_defence 36)
			(goal research_branch_defence 86))
		(or (goal research_branch_archers 27)
			(goal research_branch_archers 77)))
	(goal want-more-town-centers 0)
	(research-available ri-bodkin-arrow)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_defence 36)
			(goal research_branch_defence 86))
		(or (goal research_branch_archers 27)
			(goal research_branch_archers 77)))
	(goal want-more-town-centers 0)
	(research-available ri-bodkin-arrow)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_defence 36)
	(goal want-more-town-centers 0)
	(can-research ri-bodkin-arrow)
=>
	(research ri-bodkin-arrow)
	(set-goal research_branch_defence 87)
)
(defrule
	(goal research_branch_archers 27)
	(goal want-more-town-centers 0)
	(can-research ri-bodkin-arrow)
=>
	(research ri-bodkin-arrow)
	(set-goal research_branch_archers 78)
)
(defrule
	(or	(goal research_branch_defence 86)
		(goal research_branch_archers 77))
	(goal want-more-town-centers 0)
	(can-research ri-bodkin-arrow)
=>
	(research ri-bodkin-arrow)
)
(defrule
	(or (goal research_branch_defence 36)
		(goal research_branch_defence 87))
	(research-completed ri-bodkin-arrow)
=>
	(set-goal research_branch_defence 37)
)
(defrule
	(or (goal research_branch_archers 27)
		(goal research_branch_archers 78))
	(research-completed ri-bodkin-arrow)
=>
	(set-goal research_branch_archers 28)
)
(defrule
	(goal research_branch_defence 36)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-fletching)
	(not (research-available ri-bodkin-arrow))
=>
	(set-goal research_branch_defence 37)
)
(defrule
	(goal research_branch_archers 27)
	(building-type-count blacksmith >= 1)
	(current-age >= castle-age)
	(research-completed ri-fletching)
	(not (research-available ri-bodkin-arrow))
=>
	(set-goal research_branch_archers 28)
)

; Research Bracer (Defence, Archers)
(defrule
	(or	(or (goal research_branch_defence 38)
			(goal research_branch_defence 88))
		(or (goal research_branch_archers 32)
			(goal research_branch_archers 82)))
	(goal want-more-town-centers 0)
	(research-available ri-bracer)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_defence 38)
			(goal research_branch_defence 88))
		(or (goal research_branch_archers 32)
			(goal research_branch_archers 82)))
	(goal want-more-town-centers 0)
	(research-available ri-bracer)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_defence 38)
	(goal want-more-town-centers 0)
	(can-research ri-bracer)
=>
	(research ri-bracer)
	(set-goal research_branch_defence 89)
)
(defrule
	(goal research_branch_archers 32)
	(goal want-more-town-centers 0)
	(can-research ri-bracer)
=>
	(research ri-bracer)
	(set-goal research_branch_archers 83)
)
(defrule
	(or	(goal research_branch_defence 88)
		(goal research_branch_archers 82))
	(goal want-more-town-centers 0)
	(can-research ri-bracer)
=>
	(research ri-bracer)
)
(defrule
	(or (goal research_branch_defence 38)
		(goal research_branch_defence 89))
	(research-completed ri-bracer)
=>
	(set-goal research_branch_defence 39)
)
(defrule
	(or (goal research_branch_archers 32)
		(goal research_branch_archers 83))
	(research-completed ri-bracer)
=>
	(set-goal research_branch_archers 33)
)
(defrule
	(goal research_branch_defence 38)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-fletching)
	(or (research-completed ri-bodkin-arrow)
		(not (research-available ri-bodkin-arrow)))
	(not (research-available ri-bracer))
=>
	(set-goal research_branch_defence 39)
)
(defrule
	(goal research_branch_archers 32)
	(building-type-count blacksmith >= 1)
	(current-age >= imperial-age)
	(research-completed ri-fletching)
	(or (research-completed ri-bodkin-arrow)
		(not (research-available ri-bodkin-arrow)))
	(not (research-available ri-bracer))
=>
	(set-goal research_branch_archers 33)
)

; CASTLE
; Research Conscription (Infantry, Archers, Cannoneers, Cavalry)
(defrule
	(or	(or (goal research_branch_infantry 40)
			(goal research_branch_infantry 90))
		(or (goal research_branch_archers 40)
			(goal research_branch_archers 90)))
	(goal want-more-town-centers 0)
	(research-available ri-conscription)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_cannon 33)
			(goal research_branch_cannon 83))
		(or (goal research_branch_cavalry 21)
			(goal research_branch_cavalry 71)))
	(goal want-more-town-centers 0)
	(research-available ri-conscription)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or	(or (goal research_branch_infantry 40)
			(goal research_branch_infantry 90))
		(or (goal research_branch_archers 40)
			(goal research_branch_archers 90)))
	(goal want-more-town-centers 0)
	(research-available ri-conscription)
	(gold-amount < 150)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(or	(or (goal research_branch_cannon 33)
			(goal research_branch_cannon 83))
		(or (goal research_branch_cavalry 21)
			(goal research_branch_cavalry 71)))
	(goal want-more-town-centers 0)
	(research-available ri-conscription)
	(gold-amount < 150)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_infantry 40)
	(goal want-more-town-centers 0)
	(can-research ri-conscription)
=>
	(research ri-conscription)
	(set-goal research_branch_infantry 91)
)
(defrule
	(goal research_branch_archers 40)
	(goal want-more-town-centers 0)
	(can-research ri-conscription)
=>
	(research ri-conscription)
	(set-goal research_branch_archers 91)
)
(defrule
	(goal research_branch_cannon 33)
	(goal want-more-town-centers 0)
	(can-research ri-conscription)
=>
	(research ri-conscription)
	(set-goal research_branch_cannon 84)
)
(defrule
	(goal research_branch_cavalry 21)
	(goal want-more-town-centers 0)
	(can-research ri-conscription)
=>
	(research ri-conscription)
	(set-goal research_branch_cavalry 72)
)
(defrule
	(or	(goal research_branch_infantry 90)
	(or	(goal research_branch_archers 90)
	(or	(goal research_branch_cannon 83)
		(goal research_branch_cavalry 71))))
	(goal want-more-town-centers 0)
	(can-research ri-conscription)
=>
	(research ri-conscription)
)
(defrule
	(or (goal research_branch_infantry 40)
		(goal research_branch_infantry 91))
	(research-completed ri-conscription)
=>
	(set-goal research_branch_infantry 41)
)
(defrule
	(or (goal research_branch_archers 40)
		(goal research_branch_archers 91))
	(research-completed ri-conscription)
=>
	(set-goal research_branch_archers 41)
)
(defrule
	(or (goal research_branch_cannon 33)
		(goal research_branch_cannon 84))
	(research-completed ri-conscription)
=>
	(set-goal research_branch_cannon 34)
)
(defrule
	(or (goal research_branch_cavalry 21)
		(goal research_branch_cavalry 72))
	(research-completed ri-conscription)
=>
	(set-goal research_branch_cavalry 22)
)
(defrule
	(goal research_branch_infantry 40)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available ri-conscription))
=>
	(set-goal research_branch_infantry 41)
)
(defrule
	(goal research_branch_archers 40)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available ri-conscription))
=>
	(set-goal research_branch_archers 41)
)
(defrule
	(goal research_branch_cannon 33)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available ri-conscription))
=>
	(set-goal research_branch_cannon 34)
)
(defrule
	(goal research_branch_cavalry 21)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available ri-conscription))
=>
	(set-goal research_branch_cavalry 22)
)

; Research Elite Unique Unit with escrow if 'on'
; (Infantry, Archers, Cannoneers, Cavalry)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_infantry 33)
			(goal research_branch_infantry 83))
		(or (goal research_branch_archers 33)
			(goal research_branch_archers 83)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(food-amount < unique-unit-upgrade-food)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_cannon 24)
			(goal research_branch_cannon 74))
		(or (goal research_branch_cavalry 32)
			(goal research_branch_cavalry 82)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(food-amount < unique-unit-upgrade-food)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_infantry 33)
			(goal research_branch_infantry 83))
		(or (goal research_branch_archers 33)
			(goal research_branch_archers 83)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(wood-amount < unique-unit-upgrade-wood)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_cannon 24)
			(goal research_branch_cannon 74))
		(or (goal research_branch_cavalry 32)
			(goal research_branch_cavalry 82)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(wood-amount < unique-unit-upgrade-wood)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_infantry 33)
			(goal research_branch_infantry 83))
		(or (goal research_branch_archers 33)
			(goal research_branch_archers 83)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(gold-amount < unique-unit-upgrade-gold)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(or (goal research_branch_cannon 24)
			(goal research_branch_cannon 74))
		(or (goal research_branch_cavalry 32)
			(goal research_branch_cavalry 82)))
	(goal want-more-town-centers 0)
	(research-available my-unique-unit-upgrade)
	(gold-amount < unique-unit-upgrade-gold)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(goal research_branch_infantry 33)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-unit-upgrade)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(research my-unique-unit-upgrade)
	(set-goal research_branch_infantry 84)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(goal research_branch_archers 33)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-unit-upgrade)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(research my-unique-unit-upgrade)
	(set-goal research_branch_archers 84)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(goal research_branch_cannon 24)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-unit-upgrade)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(research my-unique-unit-upgrade)
	(set-goal research_branch_cannon 75)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(goal research_branch_cavalry 32)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-unit-upgrade)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(research my-unique-unit-upgrade)
	(set-goal research_branch_cavalry 83)
)
(defrule
	(goal is_one_goal research_twig_unique)
	(or	(goal research_branch_infantry 83)
	(or	(goal research_branch_archers 83)
	(or	(goal research_branch_cannon 74)
		(goal research_branch_cavalry 82))))
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-unit-upgrade)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(research my-unique-unit-upgrade)
)
(defrule
	(or (goal research_branch_infantry 33)
		(goal research_branch_infantry 84))
	(or (research-completed my-unique-unit-upgrade)
		(goal is-zero-goal research_twig_unique))
=>
	(set-goal research_branch_infantry 34)
)
(defrule
	(or (goal research_branch_archers 33)
		(goal research_branch_archers 84))
	(or (research-completed my-unique-unit-upgrade)
		(goal is-zero-goal research_twig_unique))
=>
	(set-goal research_branch_archers 34)
)
(defrule
	(or (goal research_branch_cannon 24)
		(goal research_branch_cannon 75))
	(or (research-completed my-unique-unit-upgrade)
		(goal is-zero-goal research_twig_unique))
=>
	(set-goal research_branch_cannon 25)
)
(defrule
	(or (goal research_branch_cavalry 32)
		(goal research_branch_cavalry 83))
	(or (research-completed my-unique-unit-upgrade)
		(goal is-zero-goal research_twig_unique))
=>
	(set-goal research_branch_cavalry 33)
)
(defrule
	(goal research_branch_infantry 33)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-unit-upgrade))
=>
	(set-goal research_branch_infantry 34)
)
(defrule
	(goal research_branch_archers 33)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-unit-upgrade))
=>
	(set-goal research_branch_archers 34)
)
(defrule
	(goal research_branch_cannon 24)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-unit-upgrade))
=>
	(set-goal research_branch_cannon 25)
)
(defrule
	(goal research_branch_cavalry 32)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-unit-upgrade))
=>
	(set-goal research_branch_cavalry 33)
)

; Research Unique Tech with escrow
; (Infantry, Archers, Cavalry, Defence, Siege)
; Goal used as local variable.
(defconst research_unique_tech 40)
(defconst ut_no 0)
(defconst ut_yes 1)

(defrule
	(true)
=>
	(set-goal research_unique_tech ut_no)
)

(defrule
	(or (goal research_branch_infantry 30)
		(goal research_branch_infantry 80))
	(or (civ-selected aztec)
	(or (and (civ-selected frankish)
			(goal is_one_goal research_twig_unique))
		(and (civ-selected gothic)
			(goal is_one_goal research_twig_unique))))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_infantry 30)
		(goal research_branch_infantry 80))
	(or (and (civ-selected mayan)
			(goal is_one_goal research_twig_eaglewarrs))
		(and (civ-selected viking)
			(goal is_one_goal research_twig_unique)))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_archers 30)
		(goal research_branch_archers 80))
	(or (civ-selected briton)
		(and (civ-selected chinese)
			(goal is_one_goal research_twig_unique)))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_cavalry 30)
		(goal research_branch_cavalry 80))
	(or (and (civ-selected byzantine)
			(goal is_one_goal research_twig_unique))
		(and (civ-selected persian)
			(goal is_one_goal research_twig_unique)))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_cavalry 30)
		(goal research_branch_cavalry 80))
	(civ-selected saracen)
	(or (goal is_one_goal research_twig_eaglewarrs)
		(goal is_one_goal research_twig_camels))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_defence 37)
		(goal research_branch_defence 87))
	(or (civ-selected briton)
		(civ-selected teutonic))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_siege 20)
		(goal research_branch_siege 70))
	(or (civ-selected celtic)
	(or (civ-selected mongol)
		(and (civ-selected chinese)
			(goal is_one_goal research_twig_scorpions))))
=>
	(set-goal research_unique_tech ut_yes)
)
(defrule
	(or (goal research_branch_siege 20)
		(goal research_branch_siege 70))
	(or (and (civ-selected japanese)
			(goal is_one_goal research_twig_trebuchets))
	(or (and (civ-selected korean)
			(goal is_one_goal research_twig_mangonels))
		(and (civ-selected turkish)
			(goal is_one_goal research_twig_bombardcannons))))
=>
	(set-goal research_unique_tech ut_yes)
)

(defrule
	(goal research_unique_tech ut_yes)
	(goal want-more-town-centers 0)
	(research-available my-unique-research)
	(food-amount < unique_tech_food)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal want-more-town-centers 0)
	(research-available my-unique-research)
	(wood-amount < unique_tech_wood)
=>
	(set-goal need-wood-goal 1)
	(set-goal escrow-wood-goal 1)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal want-more-town-centers 0)
	(research-available my-unique-research)
	(gold-amount < unique_tech_gold)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal want-more-town-centers 0)
	(research-available my-unique-research)
	(stone-amount < unique_tech_stone)
=>
	(set-goal need-stone-goal 1)
	(set-goal escrow-stone-goal 1)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal research_branch_infantry 30)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
	(set-goal research_branch_infantry 81)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal research_branch_archers 30)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
	(set-goal research_branch_archers 81)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal research_branch_cavalry 30)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
	(set-goal research_branch_cavalry 81)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal research_branch_defence 37)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
	(set-goal research_branch_defence 88)
)
(defrule
	(goal research_unique_tech ut_yes)
	(goal research_branch_siege 20)
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
	(set-goal research_branch_siege 71)
)
(defrule
	(goal research_unique_tech ut_yes)
	(or (goal research_branch_infantry 80)
	(or (goal research_branch_archers 80)
		(goal research_branch_cavalry 80)))
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
)
(defrule
	(goal research_unique_tech ut_yes)
	(or	(goal research_branch_defence 87)
		(goal research_branch_siege 70))
	(goal want-more-town-centers 0)
	(can-research-with-escrow my-unique-research)
=>
	(release-escrow food)
	(release-escrow wood)
	(release-escrow gold)
	(release-escrow stone)
	(research my-unique-research)
)
 (defrule
	(or (goal research_branch_infantry 30)
		(goal research_branch_infantry 81))
	(or (research-completed my-unique-research)
		(goal research_unique_tech ut_no))
=>
	(set-goal research_branch_infantry 31)
)
(defrule
	(or (goal research_branch_archers 30)
		(goal research_branch_archers 81))
	(or (research-completed my-unique-research)
		(goal research_unique_tech ut_no))
=>
	(set-goal research_branch_archers 31)
)
(defrule
	(or (goal research_branch_cavalry 30)
		(goal research_branch_cavalry 81))
	(or (research-completed my-unique-research)
		(goal research_unique_tech ut_no))
=>
	(set-goal research_branch_cavalry 31)
)
(defrule
	(or (goal research_branch_defence 37)
		(goal research_branch_defence 88))
	(or (research-completed my-unique-research)
		(goal research_unique_tech ut_no))
=>
	(set-goal research_branch_defence 38)
)
(defrule
	(or (goal research_branch_siege 20)
		(goal research_branch_siege 71))
	(or (research-completed my-unique-research)
		(goal research_unique_tech ut_no))
=>
	(set-goal research_branch_siege 21)
)
(defrule
	(goal research_branch_infantry 30)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-research))
=>
	(set-goal research_branch_infantry 31)
)
(defrule
	(goal research_branch_archers 30)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-research))
=>
	(set-goal research_branch_archers 31)
)
(defrule
	(goal research_branch_cavalry 30)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-research))
=>
	(set-goal research_branch_cavalry 31)
)
(defrule
	(goal research_branch_defence 37)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-research))
=>
	(set-goal research_branch_defence 38)
)
(defrule
	(goal research_branch_siege 20)
	(building-type-count castle >= 1)	
	(current-age >= imperial-age)
	(not (research-available my-unique-research))
=>
	(set-goal research_branch_siege 21)
)

; STABLE
; Research Husbandry (Cavalry)
(defrule
	(or (goal research_branch_cavalry 18)
		(goal research_branch_cavalry 68))
	(goal want-more-town-centers 0)
	(research-available ri-husbandry)
	(food-amount < 250)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_cavalry 18)
	(goal want-more-town-centers 0)
	(can-research ri-husbandry)
=>
	(research ri-husbandry)
	(set-goal research_branch_cavalry 69)
)
(defrule
	(goal research_branch_cavalry 68)
	(goal want-more-town-centers 0)
	(can-research ri-husbandry)
=>
	(research ri-husbandry)
)
(defrule
	(or (goal research_branch_cavalry 18)
		(goal research_branch_cavalry 69))
	(research-completed ri-husbandry)
=>
	(set-goal research_branch_cavalry 19)
)
(defrule
	(goal research_branch_cavalry 18)
	(building-type-count stable >= 1)
	(current-age >= castle-age)
	(not (research-available ri-husbandry))
=>
	(set-goal research_branch_cavalry 19)
)

; Research Bloodlines (Archers, Cavalry, Cannoneers)
(defrule
	(or (goal research_branch_archers 20)
		(goal research_branch_archers 70))
	(civ-selected mongol)
	(goal is_one_goal research_twig_unique)
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_archers 20)
		(goal research_branch_archers 70))
	(goal is_one_goal research_twig_cavarchers)
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_cannon 23)
		(goal research_branch_cannon 73))
	(civ-selected spanish)
	(goal is_one_goal research_twig_unique)
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_cavalry 20)
		(goal research_branch_cavalry 70))
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_archers 20)
		(goal research_branch_archers 70))
	(or (goal is_one_goal research_twig_cavarchers)
		(and (civ-selected mongol)
			(goal is_one_goal research_twig_unique)))
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(or (goal research_branch_cannon 23)
		(goal research_branch_cannon 73))
	(civ-selected spanish)
	(goal is_one_goal research_twig_unique)
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(or (goal research_branch_cavalry 20)
		(goal research_branch_cavalry 70))
	(goal want-more-town-centers 0)
	(research-available ri-bloodlines)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_archers 20)
	(or (goal is_one_goal research_twig_cavarchers)
		(and (civ-selected mongol)
			(goal is_one_goal research_twig_unique)))
	(goal want-more-town-centers 0)
	(can-research ri-bloodlines)
=>
	(research ri-bloodlines)
	(set-goal research_branch_archers 71)
)
(defrule
	(goal research_branch_cannon 23)
	(civ-selected mongol)
	(goal is_one_goal research_twig_unique)
	(goal want-more-town-centers 0)
	(can-research ri-bloodlines)
=>
	(research ri-bloodlines)
	(set-goal research_branch_cannon 74)
)
 (defrule
	(goal research_branch_cavalry 20)
	(goal want-more-town-centers 0)
	(can-research ri-bloodlines)
=>
	(research ri-bloodlines)
	(set-goal research_branch_cavalry 71)
)
(defrule
	(or	(and (or (goal research_branch_archers 70)
				(goal research_branch_cannon 73))
			(or (goal is_one_goal research_twig_cavarchers)
				(and (or (civ-selected mongol)
						(civ-selected spanish))
					(goal is_one_goal research_twig_unique))))
		(goal research_branch_cavalry 70))
	(goal want-more-town-centers 0)
	(can-research ri-bloodlines)
=>
	(research ri-bloodlines)
)
(defrule
	(or (goal research_branch_archers 20)
		(goal research_branch_archers 71))
	(or (research-completed ri-bloodlines)
	(or (goal is-zero-goal research_twig_cavarchers)
		(and (civ-selected mongol)
			(goal is-zero-goal research_twig_unique))))
=>
	(set-goal research_branch_archers 21)
)
(defrule
	(or (goal research_branch_cannon 23)
		(goal research_branch_cannon 74))
	(or (research-completed ri-bloodlines)
		(and (civ-selected spanish)
			(goal is-zero-goal research_twig_unique)))
=>
	(set-goal research_branch_cannon 24)
)
 (defrule
	(or (goal research_branch_cavalry 20)
		(goal research_branch_cavalry 71))
	(research-completed ri-bloodlines)
=>
	(set-goal research_branch_cavalry 21)
)
(defrule
	(goal research_branch_archers 20)
	(building-type-count stable >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-bloodlines))
=>
	(set-goal research_branch_archers 21)
)
(defrule
	(goal research_branch_cannon 23)
	(building-type-count stable >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-bloodlines))
=>
	(set-goal research_branch_cannon 24)
)
(defrule
	(goal research_branch_cavalry 20)
	(building-type-count stable >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-bloodlines))
=>
	(set-goal research_branch_cavalry 21)
)

; Upgrade to Light Cavalry if 'on' (Cavalry)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(or (goal research_branch_cavalry 26)
		(goal research_branch_cavalry 76))
	(goal want-more-town-centers 0)
	(research-available ri-light-cavalry)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(or (goal research_branch_cavalry 26)
		(goal research_branch_cavalry 76))
	(goal want-more-town-centers 0)
	(research-available ri-light-cavalry)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(goal research_branch_cavalry 26)
	(goal want-more-town-centers 0)
	(can-research ri-light-cavalry)
=>
	(research ri-light-cavalry)
	(set-goal research_branch_cavalry 77)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(goal research_branch_cavalry 76)
	(goal want-more-town-centers 0)
	(can-research ri-light-cavalry)
=>
	(research ri-light-cavalry)
)
(defrule
	(or (goal research_branch_cavalry 26)
		(goal research_branch_cavalry 77))
	(or (research-completed ri-light-cavalry)
		(goal is-zero-goal research_twig_scoutcav))
=>
	(set-goal research_branch_cavalry 27)
)
(defrule
	(goal research_branch_cavalry 26)
	(building-type-count stable >= 1)
	(current-age >= castle-age)
	(not (research-available ri-light-cavalry))
=>
	(set-goal research_branch_cavalry 27)
)

; Upgrade to Hussar if 'on' (Cavalry)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(or (goal research_branch_cavalry 29)
		(goal research_branch_cavalry 79))
	(goal want-more-town-centers 0)
	(research-available ri-hussar)
	(food-amount < 500)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(or (goal research_branch_cavalry 29)
		(goal research_branch_cavalry 79))
	(goal want-more-town-centers 0)
	(research-available ri-hussar)
	(gold-amount < 600)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(goal research_branch_cavalry 29)
	(goal want-more-town-centers 0)
	(can-research ri-hussar)
=>
	(research ri-hussar)
	(set-goal research_branch_cavalry 80)
)
(defrule
	(goal is_one_goal research_twig_scoutcav)
	(goal research_branch_cavalry 79)
	(goal want-more-town-centers 0)
	(can-research ri-hussar)
=>
	(research ri-hussar)
)
(defrule
	(or (goal research_branch_cavalry 29)
		(goal research_branch_cavalry 80))
	(or (research-completed ri-hussar)
		(goal is-zero-goal research_twig_scoutcav))
=>
	(set-goal research_branch_cavalry 30)
)
(defrule
	(goal research_branch_cavalry 29)
	(building-type-count stable >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-light-cavalry)
		(not (research-available ri-light-cavalry)))
	(not (research-available ri-hussar))
=>
	(set-goal research_branch_cavalry 30)
)

; Upgrade to Cavalier if 'on' (Cavalry)
(defrule
	(goal is_one_goal research_twig_knights)
	(or (goal research_branch_cavalry 23)
		(goal research_branch_cavalry 73))
	(goal want-more-town-centers 0)
	(research-available ri-cavalier)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(or (goal research_branch_cavalry 23)
		(goal research_branch_cavalry 73))
	(goal want-more-town-centers 0)
	(research-available ri-cavalier)
	(gold-amount < 300)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(goal research_branch_cavalry 23)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-cavalier)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-cavalier)
	(set-goal research_branch_cavalry 74)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(goal research_branch_cavalry 73)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-cavalier)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-cavalier)
)
(defrule
	(or (goal research_branch_cavalry 23)
		(goal research_branch_cavalry 74))
	(or (research-completed ri-cavalier)
		(goal is-zero-goal research_twig_knights))
=>
	(set-goal research_branch_cavalry 24)
)
(defrule
	(goal research_branch_cavalry 23)
	(building-type-count stable >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-cavalier))
=>
	(set-goal research_branch_cavalry 24)
)

; Upgrade to Paladin if 'on' (Cavalry)
(defrule
	(goal is_one_goal research_twig_knights)
	(or (goal research_branch_cavalry 28)
		(goal research_branch_cavalry 78))
	(goal want-more-town-centers 0)
	(research-available ri-paladin)
	(food-amount < 1300)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(or (goal research_branch_cavalry 28)
		(goal research_branch_cavalry 78))
	(goal want-more-town-centers 0)
	(research-available ri-paladin)
	(gold-amount < 750)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(goal research_branch_cavalry 28)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-paladin)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-paladin)
	(set-goal research_branch_cavalry 79)
)
(defrule
	(goal is_one_goal research_twig_knights)
	(goal research_branch_cavalry 78)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-paladin)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-paladin)
)
(defrule
	(or (goal research_branch_cavalry 28)
		(goal research_branch_cavalry 79))
	(or (research-completed ri-paladin)
		(goal is-zero-goal research_twig_knights))
=>
	(set-goal research_branch_cavalry 29)
)
(defrule
	(goal research_branch_cavalry 28)
	(building-type-count stable >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-cavalier)
		(not (research-available ri-cavalier)))
	(not (research-available ri-paladin))
=>
	(set-goal research_branch_cavalry 29)
)

; Upgrade to Heavy Camel if 'on' (Cavalry)
(defrule
	(goal is_one_goal research_twig_camels)
	(or (goal research_branch_cavalry 24)
		(goal research_branch_cavalry 74))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-camel)
	(food-amount < 325)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_camels)
	(or (goal research_branch_cavalry 24)
		(goal research_branch_cavalry 74))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-camel)
	(gold-amount < 360)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_camels)
	(goal research_branch_cavalry 24)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-camel)
=>
	(research ri-heavy-camel)
	(set-goal research_branch_cavalry 75)
)
(defrule
	(goal is_one_goal research_twig_camels)
	(goal research_branch_cavalry 74)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-camel)
=>
	(research ri-heavy-camel)
)
(defrule
	(or (goal research_branch_cavalry 24)
		(goal research_branch_cavalry 75))
	(or (research-completed ri-heavy-camel)
		(goal is-zero-goal research_twig_camels))
=>
	(set-goal research_branch_cavalry 25)
)
(defrule
	(goal research_branch_cavalry 24)
	(building-type-count stable >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-heavy-camel))
=>
	(set-goal research_branch_cavalry 25)
)

; ARCHERY RANGE
; Research Parthian Tactics if Cavalry Archers 'on' (Archers)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(or (goal research_branch_archers 23)
		(goal research_branch_archers 73))
	(goal want-more-town-centers 0)
	(research-available ri-parthian-tactics)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(or (goal research_branch_archers 23)
		(goal research_branch_archers 73))
	(goal want-more-town-centers 0)
	(research-available ri-parthian-tactics)
	(gold-amount < 250)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(goal research_branch_archers 23)
	(goal want-more-town-centers 0)
	(can-research ri-parthian-tactics)
=>
	(research ri-parthian-tactics)
	(set-goal research_branch_archers 74)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(goal research_branch_archers 73)
	(goal want-more-town-centers 0)
	(can-research ri-parthian-tactics)
=>
	(research ri-parthian-tactics)
)
(defrule
	(or (goal research_branch_archers 23)
		(goal research_branch_archers 74))
	(or (research-completed ri-parthian-tactics)
		(goal is-zero-goal research_twig_cavarchers))
=>
	(set-goal research_branch_archers 24)
)
(defrule
	(goal research_branch_archers 23)
	(building-type-count archery-range >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-parthian-tactics))
=>
	(set-goal research_branch_archers 24)
)

; Research Thumb Ring (Archers)
(defrule
	(or (goal research_branch_archers 26)
		(goal research_branch_archers 76))
	(goal want-more-town-centers 0)
	(research-available ri-thumb-ring)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_archers 26)
		(goal research_branch_archers 76))
	(goal want-more-town-centers 0)
	(research-available ri-thumb-ring)
	(wood-amount < 250)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal research_branch_archers 26)
	(goal want-more-town-centers 0)
	(can-research ri-thumb-ring)
=>
	(research ri-thumb-ring)
	(set-goal research_branch_archers 77)
)
(defrule
	(goal research_branch_archers 76)
	(goal want-more-town-centers 0)
	(can-research ri-thumb-ring)
=>
	(research ri-thumb-ring)
)
(defrule
	(or (goal research_branch_archers 26)
		(goal research_branch_archers 77))
	(research-completed ri-thumb-ring)
=>
	(set-goal research_branch_archers 27)
)
(defrule
	(goal research_branch_archers 26)
	(building-type-count archery-range >= 1)
	(current-age >= castle-age)
	(not (research-available ri-thumb-ring))
=>
	(set-goal research_branch_archers 27)
)

; Research Hand Cannoneer if 'on' (Cannoneers)
(defrule
	(goal is_one_goal research_twig_cannoneers)
	(or (goal research_branch_cannon 19)
		(goal research_branch_cannon 69))
	(goal want-more-town-centers 0)
	(research-available ri-hand-cannon)
	(food-amount < 450)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cannoneers)
	(or (goal research_branch_cannon 19)
		(goal research_branch_cannon 69))
	(goal want-more-town-centers 0)
	(research-available ri-hand-cannon)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cannoneers)
	(goal research_branch_cannon 19)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-hand-cannon)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-hand-cannon)
	(set-goal research_branch_cannon 70)
)
(defrule
	(goal is_one_goal research_twig_cannoneers)
	(goal research_branch_cannon 69)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-hand-cannon)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-hand-cannon)
)
(defrule
	(or (goal research_branch_cannon 19)
		(goal research_branch_cannon 70))
	(or (research-completed ri-hand-cannon)
		(goal is-zero-goal research_twig_cannoneers))
=>
	(set-goal research_branch_cannon 20)
)
(defrule
	(goal research_branch_cannon 19)
	(building-type-count archery-range >= 1)
	(current-age >= imperial-age)
	(research-completed ri-chemistry)	
	(not (research-available ri-hand-cannon))
=>
	(set-goal research_branch_cannon 20)
)

; Research Crossbowman if 'on' (Archers)
(defrule
	(goal is_one_goal research_twig_archers)
	(or (goal research_branch_archers 17)
		(goal research_branch_archers 67))
	(goal want-more-town-centers 0)
	(research-available ri-crossbow)
	(food-amount < 125)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(or (goal research_branch_archers 17)
		(goal research_branch_archers 67))
	(goal want-more-town-centers 0)
	(research-available ri-crossbow)
	(gold-amount < 75)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(goal research_branch_archers 17)
	(goal want-more-town-centers 0)
	(can-research ri-crossbow)
=>
	(research ri-crossbow)
	(set-goal research_branch_archers 68)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(goal research_branch_archers 67)
	(goal want-more-town-centers 0)
	(can-research ri-crossbow)
=>
	(research ri-crossbow)
)
(defrule
	(or (goal research_branch_archers 17)
		(goal research_branch_archers 68))
	(or (research-completed ri-crossbow)
		(goal is-zero-goal research_twig_archers))
=>
	(set-goal research_branch_archers 18)
)
(defrule
	(goal research_branch_archers 17)
	(building-type-count archery-range >= 1)
	(current-age >= castle-age)
	(not (research-available ri-crossbow))
=>
	(set-goal research_branch_archers 18)
)

; Research Arbalest if 'on' (Archers)
(defrule
	(goal is_one_goal research_twig_archers)
	(or (goal research_branch_archers 22)
		(goal research_branch_archers 72))
	(goal want-more-town-centers 0)
	(research-available ri-arbalest)
	(food-amount < 350)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(or (goal research_branch_archers 22)
		(goal research_branch_archers 72))
	(goal want-more-town-centers 0)
	(research-available ri-arbalest)
	(gold-amount < 300)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(goal research_branch_archers 22)
	(goal want-more-town-centers 0)
	(can-research ri-arbalest)
=>
	(research ri-arbalest)
	(set-goal research_branch_archers 73)
)
(defrule
	(goal is_one_goal research_twig_archers)
	(goal research_branch_archers 72)
	(goal want-more-town-centers 0)
	(can-research ri-arbalest)
=>
	(research ri-arbalest)
)
(defrule
	(or (goal research_branch_archers 22)
		(goal research_branch_archers 73))
	(or (research-completed ri-arbalest)
		(goal is-zero-goal research_twig_archers))
=>
	(set-goal research_branch_archers 23)
)
(defrule
	(goal research_branch_archers 22)
	(building-type-count archery-range >= 1)
	(current-age >= imperial-age)
	(research-completed ri-crossbow)
	(not (research-available ri-arbalest))
=>
	(set-goal research_branch_archers 23)
)

; Research Elite Skirmisher if 'on' (Archers)
(defrule
	(goal is_one_goal research_twig_skirmishers)
	(or (goal research_branch_archers 19)
		(goal research_branch_archers 69))
	(goal want-more-town-centers 0)
	(research-available ri-elite-skirmisher)
	(food-amount < 250)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_skirmishers)
	(or (goal research_branch_archers 19)
		(goal research_branch_archers 69))
	(goal want-more-town-centers 0)
	(research-available ri-elite-skirmisher)
	(gold-amount < 160)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_skirmishers)
	(goal research_branch_archers 19)
	(goal want-more-town-centers 0)
	(can-research ri-elite-skirmisher)
=>
	(research ri-elite-skirmisher)
	(set-goal research_branch_archers 70)
)
(defrule
	(goal is_one_goal research_twig_skirmishers)
	(goal research_branch_archers 69)
	(goal want-more-town-centers 0)
	(can-research ri-elite-skirmisher)
=>
	(research ri-elite-skirmisher)
)
(defrule
	(or (goal research_branch_archers 19)
		(goal research_branch_archers 70))
	(or (research-completed ri-elite-skirmisher)
		(goal is-zero-goal research_twig_skirmishers))
=>
	(set-goal research_branch_archers 20)
)
(defrule
	(goal research_branch_archers 19)
	(building-type-count archery-range >= 1)
	(current-age >= castle-age)
	(not (research-available ri-elite-skirmisher))
=>
	(set-goal research_branch_archers 20)
)

; Research Heavy Cavalry Archer if 'on' (Archers)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(or (goal research_branch_archers 29)
		(goal research_branch_archers 79))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-cavalry-archer)
	(food-amount < 900)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(or (goal research_branch_archers 29)
		(goal research_branch_archers 79))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-cavalry-archer)
	(gold-amount < 500)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(goal research_branch_archers 29)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-cavalry-archer)
=>
	(research ri-heavy-cavalry-archer)
	(set-goal research_branch_archers 80)
)
(defrule
	(goal is_one_goal research_twig_cavarchers)
	(goal research_branch_archers 79)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-cavalry-archer)
=>
	(research ri-heavy-cavalry-archer)
)
(defrule
	(or (goal research_branch_archers 29)
		(goal research_branch_archers 80))
	(or (research-completed ri-heavy-cavalry-archer)
		(goal is-zero-goal research_twig_cavarchers))
=>
	(set-goal research_branch_archers 30)
)
(defrule
	(goal research_branch_archers 29)
	(building-type-count archery-range >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-heavy-cavalry-archer))
=>
	(set-goal research_branch_archers 30)
)

; BARRACKS
; Research Tracking (Infantry)
(defrule
	(or (goal research_branch_infantry 25)
		(goal research_branch_infantry 75))
	(goal want-more-town-centers 0)
	(research-available ri-tracking)
	(food-amount < 75)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_infantry 25)
	(goal want-more-town-centers 0)
	(can-research ri-tracking)
=>
	(research ri-tracking)
	(set-goal research_branch_infantry 76)
)
(defrule
	(goal research_branch_infantry 75)
	(goal want-more-town-centers 0)
	(can-research ri-tracking)
=>
	(research ri-tracking)
)
(defrule
	(or (goal research_branch_infantry 25)
		(goal research_branch_infantry 76))
	(research-completed ri-tracking)
=>
	(set-goal research_branch_infantry 26)
)
(defrule
	(goal research_branch_infantry 25)
	(building-type-count barracks >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-tracking))
=>
	(set-goal research_branch_infantry 26)
)

; Research Squires (Infantry)
(defrule
	(or (goal research_branch_infantry 21)
		(goal research_branch_infantry 71))
	(goal want-more-town-centers 0)
	(research-available ri-squires)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal research_branch_infantry 21)
	(goal want-more-town-centers 0)
	(can-research ri-squires)
=>
	(research ri-squires)
	(set-goal research_branch_infantry 72)
)
(defrule
	(goal research_branch_infantry 71)
	(goal want-more-town-centers 0)
	(can-research ri-squires)
=>
	(research ri-squires)
)
(defrule
	(or (goal research_branch_infantry 21)
		(goal research_branch_infantry 72))
	(research-completed ri-squires)
=>
	(set-goal research_branch_infantry 22)
)
(defrule
	(goal research_branch_infantry 21)
	(building-type-count barracks >= 1)
	(current-age >= castle-age)
	(not (research-available ri-squires))
=>
	(set-goal research_branch_infantry 22)
)

; Research Man-at-Arms if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 17)
		(goal research_branch_infantry 67))
	(goal want-more-town-centers 0)
	(research-available ri-man-at-arms)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 17)
		(goal research_branch_infantry 67))
	(goal want-more-town-centers 0)
	(research-available ri-man-at-arms)
	(gold-amount < 40)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 17)
	(goal want-more-town-centers 0)
	(can-research ri-man-at-arms)
=>
	(research ri-man-at-arms)
	(set-goal research_branch_infantry 68)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 67)
	(goal want-more-town-centers 0)
	(can-research ri-man-at-arms)
=>
	(research ri-man-at-arms)
)
(defrule
	(or (goal research_branch_infantry 17)
		(goal research_branch_infantry 68))
	(or (research-completed ri-man-at-arms)
		(goal is-zero-goal research_twig_militia))
=>
	(set-goal research_branch_infantry 18)
)
(defrule
	(goal research_branch_infantry 17)
	(building-type-count barracks >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-man-at-arms))
=>
	(set-goal research_branch_infantry 18)
)

; Research Long Swordsman if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 19)
		(goal research_branch_infantry 69))
	(goal want-more-town-centers 0)
	(research-available ri-long-swordsman)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 19)
		(goal research_branch_infantry 69))
	(goal want-more-town-centers 0)
	(research-available ri-long-swordsman)
	(gold-amount < 65)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 19)
	(goal want-more-town-centers 0)
	(can-research ri-long-swordsman)
=>
	(research ri-long-swordsman)
	(set-goal research_branch_infantry 70)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 69)
	(goal want-more-town-centers 0)
	(can-research ri-long-swordsman)
=>
	(research ri-long-swordsman)
)
(defrule
	(or (goal research_branch_infantry 19)
		(goal research_branch_infantry 70))
	(or (research-completed ri-long-swordsman)
		(goal is-zero-goal research_twig_militia))
=>
	(set-goal research_branch_infantry 20)
)
(defrule
	(goal research_branch_infantry 19)
	(building-type-count barracks >= 1)
	(current-age >= castle-age)
	(or (research-completed ri-man-at-arms)
		(not (research-available ri-man-at-arms)))
	(not (research-available ri-long-swordsman))
=>
	(set-goal research_branch_infantry 20)
)

; Research Two-Handed Swordsman if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 26)
		(goal research_branch_infantry 76))
	(goal want-more-town-centers 0)
	(research-available ri-two-handed-swordsman)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 26)
		(goal research_branch_infantry 76))
	(goal want-more-town-centers 0)
	(research-available ri-two-handed-swordsman)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 26)
	(goal want-more-town-centers 0)
	(can-research ri-two-handed-swordsman)
=>
	(research ri-two-handed-swordsman)
	(set-goal research_branch_infantry 77)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 76)
	(goal want-more-town-centers 0)
	(can-research ri-two-handed-swordsman)
=>
	(research ri-two-handed-swordsman)
)
(defrule
	(or (goal research_branch_infantry 26)
		(goal research_branch_infantry 77))
	(or (research-completed ri-two-handed-swordsman)
		(goal is-zero-goal research_twig_militia))
=>
	(set-goal research_branch_infantry 27)
)
(defrule
	(goal research_branch_infantry 26)
	(building-type-count barracks >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-man-at-arms)
		(not (research-available ri-man-at-arms)))
	(or (research-completed ri-long-swordsman)
		(not (research-available ri-long-swordsman)))
	(not (research-available ri-two-handed-swordsman))
=>
	(set-goal research_branch_infantry 27)
)

; Research Champion if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 31)
		(goal research_branch_infantry 81))
	(goal want-more-town-centers 0)
	(research-available ri-champion)
	(food-amount < 750)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(or (goal research_branch_infantry 31)
		(goal research_branch_infantry 81))
	(goal want-more-town-centers 0)
	(research-available ri-champion)
	(gold-amount < 350)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 31)
	(goal want-more-town-centers 0)
	(can-research ri-champion)
=>
	(research ri-champion)
	(set-goal research_branch_infantry 82)
)
(defrule
	(goal is_one_goal research_twig_militia)
	(goal research_branch_infantry 81)
	(goal want-more-town-centers 0)
	(can-research ri-champion)
=>
	(research ri-champion)
)
(defrule
	(or (goal research_branch_infantry 31)
		(goal research_branch_infantry 82))
	(or (research-completed ri-champion)
		(goal is-zero-goal research_twig_militia))
=>
	(set-goal research_branch_infantry 32)
)
(defrule
	(goal research_branch_infantry 31)
	(building-type-count barracks >= 1)
	(current-age >= imperial-age)
	(research-completed ri-man-at-arms)
	(or (research-completed ri-long-swordsman)
		(not (research-available ri-long-swordsman)))
	(or (research-completed ri-two-handed-swordsman)
		(not (research-available ri-two-handed-swordsman)))
	(not (research-available ri-champion))
=>
	(set-goal research_branch_infantry 32)
)

; Research Pikeman if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(or (goal research_branch_infantry 18)
		(goal research_branch_infantry 68))
	(goal want-more-town-centers 0)
	(research-available ri-pikeman)
	(food-amount < 215)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(or (goal research_branch_infantry 18)
		(goal research_branch_infantry 68))
	(goal want-more-town-centers 0)
	(research-available ri-pikeman)
	(gold-amount < 90)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(goal research_branch_infantry 18)
	(goal want-more-town-centers 0)
	(can-research ri-pikeman)
=>
	(research ri-pikeman)
	(set-goal research_branch_infantry 69)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(goal research_branch_infantry 68)
	(goal want-more-town-centers 0)
	(can-research ri-pikeman)
=>
	(research ri-pikeman)
)
(defrule
	(or (goal research_branch_infantry 18)
		(goal research_branch_infantry 69))
	(or (research-completed ri-pikeman)
		(goal is-zero-goal research_twig_spearmen))
=>
	(set-goal research_branch_infantry 19)
)
(defrule
	(goal research_branch_infantry 18)
	(building-type-count barracks >= 1)
	(current-age >= castle-age)
	(not (research-available ri-pikeman))
=>
	(set-goal research_branch_infantry 19)
)

; Research Halberdier if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(or (goal research_branch_infantry 28)
		(goal research_branch_infantry 78))
	(goal want-more-town-centers 0)
	(research-available ri-halberdier)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(or (goal research_branch_infantry 28)
		(goal research_branch_infantry 78))
	(goal want-more-town-centers 0)
	(research-available ri-halberdier)
	(gold-amount < 600)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(goal research_branch_infantry 28)
	(goal want-more-town-centers 0)
	(can-research ri-halberdier)
=>
	(research ri-halberdier)
	(set-goal research_branch_infantry 79)
)
(defrule
	(goal is_one_goal research_twig_spearmen)
	(goal research_branch_infantry 78)
	(goal want-more-town-centers 0)
	(can-research ri-halberdier)
=>
	(research ri-halberdier)
)
(defrule
	(or (goal research_branch_infantry 28)
		(goal research_branch_infantry 79))
	(or (research-completed ri-halberdier)
		(goal is-zero-goal research_twig_spearmen))
=>
	(set-goal research_branch_infantry 29)
)
(defrule
	(goal research_branch_infantry 28)
	(building-type-count barracks >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-halberdier))
=>
	(set-goal research_branch_infantry 29)
)

; Research Elite Eagle Warrior if 'on' (Infantry)
(defrule
	(goal is_one_goal research_twig_eaglewarrs)
	(or (goal research_branch_infantry 32)
		(goal research_branch_infantry 82))
	(goal want-more-town-centers 0)
	(research-available ri-elite-eagle-warrior)
	(food-amount < 800)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_eaglewarrs)
	(or (goal research_branch_infantry 32)
		(goal research_branch_infantry 82))
	(goal want-more-town-centers 0)
	(research-available ri-elite-eagle-warrior)
	(gold-amount < 500)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_eaglewarrs)
	(goal research_branch_infantry 32)
	(goal want-more-town-centers 0)
	(can-research ri-elite-eagle-warrior)
=>
	(research ri-elite-eagle-warrior)
	(set-goal research_branch_infantry 83)
)
(defrule
	(goal is_one_goal research_twig_eaglewarrs)
	(goal research_branch_infantry 82)
	(goal want-more-town-centers 0)
	(can-research ri-elite-eagle-warrior)
=>
	(research ri-elite-eagle-warrior)
)
(defrule
	(or (goal research_branch_infantry 32)
		(goal research_branch_infantry 83))
	(or (research-completed ri-elite-eagle-warrior)
		(goal is-zero-goal research_twig_eaglewarrs))
=>
	(set-goal research_branch_infantry 33)
)
(defrule
	(goal research_branch_infantry 32)
	(building-type-count barracks >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-elite-eagle-warrior))
=>
	(set-goal research_branch_infantry 33)
)

; MONASTERY
; Research Sanctity (Monks)
(defrule
	(or (goal research_branch_monks 18)
		(goal research_branch_monks 68))
	(goal want-more-town-centers 0)
	(research-available ri-sanctity)
	(gold-amount < 120)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 18)
	(goal want-more-town-centers 0)
	(can-research ri-sanctity)
=>
	(research ri-sanctity)
	(set-goal research_branch_monks 69)
)
(defrule
	(goal research_branch_monks 68)
	(goal want-more-town-centers 0)
	(can-research ri-sanctity)
=>
	(research ri-sanctity)
)
(defrule
	(or (goal research_branch_monks 18)
		(goal research_branch_monks 69))
	(research-completed ri-sanctity)
=>
	(set-goal research_branch_monks 19)
)
(defrule
	(goal research_branch_monks 18)
	(building-type-count monastery >= 1)
	(current-age >= castle-age)
	(not (research-available ri-sanctity))
=>
	(set-goal research_branch_monks 19)
)

; Research Fervor (Monks)
(defrule
	(or (goal research_branch_monks 17)
		(goal research_branch_monks 67))
	(goal want-more-town-centers 0)
	(research-available ri-fervor)
	(gold-amount < 140)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 17)
	(goal want-more-town-centers 0)
	(can-research ri-fervor)
=>
	(research ri-fervor)
	(set-goal research_branch_monks 68)
)
(defrule
	(goal research_branch_monks 67)
	(goal want-more-town-centers 0)
	(can-research ri-fervor)
=>
	(research ri-fervor)
)
(defrule
	(or (goal research_branch_monks 17)
		(goal research_branch_monks 68))
	(research-completed ri-fervor)
=>
	(set-goal research_branch_monks 18)
)
(defrule
	(goal research_branch_monks 17)
	(building-type-count monastery >= 1)
	(current-age >= castle-age)
	(not (research-available ri-fervor))
=>
	(set-goal research_branch_monks 18)
)

; Research Atonement (Monks)
(defrule
	(or (goal research_branch_monks 19)
		(goal research_branch_monks 69))
	(goal want-more-town-centers 0)
	(research-available ri-atonement)
	(gold-amount < 325)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 19)
	(goal want-more-town-centers 0)
	(can-research ri-atonement)
=>
	(research ri-atonement)
	(set-goal research_branch_monks 70)
)
(defrule
	(goal research_branch_monks 69)
	(goal want-more-town-centers 0)
	(can-research ri-atonement)
=>
	(research ri-atonement)
)
(defrule
	(or (goal research_branch_monks 19)
		(goal research_branch_monks 70))
	(research-completed ri-atonement)
=>
	(set-goal research_branch_monks 20)
)
(defrule
	(goal research_branch_monks 19)
	(building-type-count monastery >= 1)
	(current-age >= castle-age)
	(not (research-available ri-atonement))
=>
	(set-goal research_branch_monks 20)
)

; Research Illumination (Monks)
(defrule
	(or (goal research_branch_monks 34)
		(goal research_branch_monks 84))
	(goal want-more-town-centers 0)
	(research-available ri-illumination)
	(gold-amount < 120)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 34)
	(goal want-more-town-centers 0)
	(can-research ri-illumination)
=>
	(research ri-illumination)
	(set-goal research_branch_monks 85)
)
(defrule
	(goal research_branch_monks 84)
	(goal want-more-town-centers 0)
	(can-research ri-illumination)
=>
	(research ri-illumination)
)
(defrule
	(or (goal research_branch_monks 34)
		(goal research_branch_monks 85))
	(research-completed ri-illumination)
=>
	(set-goal research_branch_monks 35)
)
(defrule
	(goal research_branch_monks 34)
	(building-type-count monastery >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-illumination))
=>
	(set-goal research_branch_monks 35)
)

; Research Theocracy (Monks)
(defrule
	(or (goal research_branch_monks 35)
		(goal research_branch_monks 85))
	(goal want-more-town-centers 0)
	(research-available ri-theocracy)
	(food-amount < 400)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_monks 35)
		(goal research_branch_monks 85))
	(goal want-more-town-centers 0)
	(research-available ri-theocracy)
	(gold-amount < 800)
=>
	(set-goal need-gold-goal 1)
)
 (defrule
	(goal research_branch_monks 35)
	(goal want-more-town-centers 0)
	(can-research ri-theocracy)
=>
	(research ri-theocracy)
	(set-goal research_branch_monks 86)
)
(defrule
	(goal research_branch_monks 85)
	(goal want-more-town-centers 0)
	(can-research ri-theocracy)
=>
	(research ri-theocracy)
)
(defrule
	(or (goal research_branch_monks 35)
		(goal research_branch_monks 86))
	(research-completed ri-theocracy)
=>
	(set-goal research_branch_monks 36)
)
(defrule
	(goal research_branch_monks 35)
	(building-type-count monastery >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-theocracy))
=>
	(set-goal research_branch_monks 36)
)

; Research Block Printing (Monks)
(defrule
	(or (goal research_branch_monks 33)
		(goal research_branch_monks 83))
	(goal want-more-town-centers 0)
	(research-available ri-block-printing)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 33)
	(goal want-more-town-centers 0)
	(can-research ri-block-printing)
=>
	(research ri-block-printing)
	(set-goal research_branch_monks 84)
)
(defrule
	(goal research_branch_monks 83)
	(goal want-more-town-centers 0)
	(can-research ri-block-printing)
=>
	(research ri-block-printing)
)
(defrule
	(or (goal research_branch_monks 33)
		(goal research_branch_monks 84))
	(research-completed ri-block-printing)
=>
	(set-goal research_branch_monks 34)
)
(defrule
	(goal research_branch_monks 33)
	(building-type-count monastery >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-block-printing))
=>
	(set-goal research_branch_monks 34)
)

; Research Redemption (Monks)
(defrule
	(or (goal research_branch_monks 36)
		(goal research_branch_monks 86))
	(goal want-more-town-centers 0)
	(research-available ri-redemption)
	(gold-amount < 475)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_monks 36)
	(goal want-more-town-centers 0)
	(can-research ri-redemption)
=>
	(research ri-redemption)
	(set-goal research_branch_monks 87)
)
(defrule
	(goal research_branch_monks 86)
	(goal want-more-town-centers 0)
	(can-research ri-redemption)
=>
	(research ri-redemption)
)
(defrule
	(or (goal research_branch_monks 36)
		(goal research_branch_monks 87))
	(research-completed ri-redemption)
=>
	(set-goal research_branch_monks 37)
)
(defrule
	(goal research_branch_monks 36)
	(building-type-count monastery >= 1)
	(current-age >= castle-age)
	(not (research-available ri-redemption))
=>
	(set-goal research_branch_monks 37)
)

; Research Faith using escrow (Cavalry)
(defrule
	(or (goal research_branch_cavalry 33)
		(goal research_branch_cavalry 83))
	(goal want-more-town-centers 0)
	(research-available ri-faith)
	(food-amount < 750)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(or (goal research_branch_cavalry 33)
		(goal research_branch_cavalry 83))
	(goal want-more-town-centers 0)
	(research-available ri-faith)
	(gold-amount < 1000)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal research_branch_cavalry 33)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-faith)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-faith)
	(set-goal research_branch_cavalry 84)
)
(defrule
	(goal research_branch_cavalry 83)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-faith)
=>
	(release-escrow food)
	(release-escrow gold)
	(research ri-faith)
)
(defrule
	(or (goal research_branch_cavalry 33)
		(goal research_branch_cavalry 84))
	(research-completed ri-faith)
=>
	(set-goal research_branch_cavalry 34)
)
(defrule
	(goal research_branch_cavalry 33)
	(building-type-count monastery >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-faith))
=>
	(set-goal research_branch_cavalry 34)
)

; Research Heresy with escrow (Cavalry)
(defrule
	(or (goal research_branch_cavalry 40)
		(goal research_branch_cavalry 90))
	(goal want-more-town-centers 0)
	(research-available ri-heresy)
	(gold-amount < 1000)
=>
	(set-goal need-gold-goal 1)
	(set-goal escrow-gold-goal 1)
)
(defrule
	(goal research_branch_cavalry 40)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-heresy)
=>
	(release-escrow gold)
	(research ri-heresy)
	(set-goal research_branch_cavalry 91)
)
(defrule
	(goal research_branch_cavalry 90)
	(goal want-more-town-centers 0)
	(can-research-with-escrow ri-heresy)
=>
	(release-escrow gold)
	(research ri-heresy)
)
(defrule
	(or (goal research_branch_cavalry 40)
		(goal research_branch_cavalry 91))
	(research-completed ri-heresy)
=>
	(set-goal research_branch_cavalry 41)
)
(defrule
	(goal research_branch_cavalry 40)
	(building-type-count monastery >= 1)
	(current-age >= castle-age)
	(not (research-available ri-heresy))
=>
	(set-goal research_branch_cavalry 41)
)

; SIEGE WORKSHOP
; Research Onager if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(or (goal research_branch_siege 17)
		(goal research_branch_siege 67))
	(goal want-more-town-centers 0)
	(research-available ri-onager)
	(food-amount < 800)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(or (goal research_branch_siege 17)
		(goal research_branch_siege 67))
	(goal want-more-town-centers 0)
	(research-available ri-onager)
	(gold-amount < 500)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(goal research_branch_siege 17)
	(goal want-more-town-centers 0)
	(can-research ri-onager)
=>
	(research ri-onager)
	(set-goal research_branch_siege 68)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(goal research_branch_siege 67)
	(goal want-more-town-centers 0)
	(can-research ri-onager)
=>
	(research ri-onager)
)
(defrule
	(or (goal research_branch_siege 17)
		(goal research_branch_siege 68))
	(or (research-completed ri-onager)
		(goal is-zero-goal research_twig_mangonels))
=>
	(set-goal research_branch_siege 18)
)
(defrule
	(goal research_branch_siege 17)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-onager))
=>
	(set-goal research_branch_siege 18)
)

; Research Siege Onager if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(or (goal research_branch_siege 35)
		(goal research_branch_siege 85))
	(goal want-more-town-centers 0)
	(research-available ri-siege-onager)
	(food-amount < 1450)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(or (goal research_branch_siege 35)
		(goal research_branch_siege 85))
	(goal want-more-town-centers 0)
	(research-available ri-siege-onager)
	(gold-amount < 1000)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(goal research_branch_siege 35)
	(goal want-more-town-centers 0)
	(can-research ri-siege-onager)
=>
	(research ri-siege-onager)
	(set-goal research_branch_siege 86)
)
(defrule
	(goal is_one_goal research_twig_mangonels)
	(goal research_branch_siege 85)
	(goal want-more-town-centers 0)
	(can-research ri-siege-onager)
=>
	(research ri-siege-onager)
)
(defrule
	(or (goal research_branch_siege 35)
		(goal research_branch_siege 86))
	(or (research-completed ri-siege-onager)
		(goal is-zero-goal research_twig_mangonels))
=>
	(set-goal research_branch_siege 36)
)
(defrule
	(goal research_branch_siege 35)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(or	(research-completed ri-onager)
		(not (research-available ri-onager)))
	(not (research-available ri-siege-onager))
=>
	(set-goal research_branch_siege 36)
)

; Research Capped Ram if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_rams)
	(or (goal research_branch_siege 18)
		(goal research_branch_siege 68))
	(goal want-more-town-centers 0)
	(research-available ri-capped-ram)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(or (goal research_branch_siege 18)
		(goal research_branch_siege 68))
	(goal want-more-town-centers 0)
	(research-available ri-capped-ram)
	(gold-amount < 250)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(goal research_branch_siege 18)
	(goal want-more-town-centers 0)
	(can-research ri-capped-ram)
=>
	(research ri-capped-ram)
	(set-goal research_branch_siege 69)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(goal research_branch_siege 68)
	(goal want-more-town-centers 0)
	(can-research ri-capped-ram)
=>
	(research ri-capped-ram)
)
(defrule
	(or (goal research_branch_siege 18)
		(goal research_branch_siege 69))
	(or (research-completed ri-capped-ram)
		(goal is-zero-goal research_twig_rams))
=>
	(set-goal research_branch_siege 19)
)
(defrule
	(goal research_branch_siege 18)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-capped-ram))
=>
	(set-goal research_branch_siege 19)
)

; Research Siege Ram if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_rams)
	(or (goal research_branch_siege 36)
		(goal research_branch_siege 86))
	(goal want-more-town-centers 0)
	(research-available ri-siege-ram)
	(food-amount < 1000)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(or (goal research_branch_siege 36)
		(goal research_branch_siege 86))
	(goal want-more-town-centers 0)
	(research-available ri-siege-ram)
	(gold-amount < 800)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(goal research_branch_siege 36)
	(goal want-more-town-centers 0)
	(can-research ri-siege-ram)
=>
	(research ri-siege-ram)
	(set-goal research_branch_siege 87)
)
(defrule
	(goal is_one_goal research_twig_rams)
	(goal research_branch_siege 86)
	(goal want-more-town-centers 0)
	(can-research ri-siege-ram)
=>
	(research ri-siege-ram)
)
(defrule
	(or (goal research_branch_siege 36)
		(goal research_branch_siege 87))
	(or (research-completed ri-siege-ram)
		(goal is-zero-goal research_twig_rams))
=>
	(set-goal research_branch_siege 37)
)
(defrule
	(goal research_branch_siege 36)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(or (research-completed ri-capped-ram)
		(not (research-available ri-capped-ram)))
	(not (research-available ri-siege-ram))
=>
	(set-goal research_branch_siege 37)
)

; Research Heavy Scorpion if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_scorpions)
	(or (goal research_branch_siege 33)
		(goal research_branch_siege 83))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-scorpion)
	(food-amount < 1000)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scorpions)
	(or (goal research_branch_siege 33)
		(goal research_branch_siege 83))
	(goal want-more-town-centers 0)
	(research-available ri-heavy-scorpion)
	(gold-amount < 1100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_scorpions)
	(goal research_branch_siege 33)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-scorpion)
=>
	(research ri-heavy-scorpion)
	(set-goal research_branch_siege 84)
)
(defrule
	(goal is_one_goal research_twig_scorpions)
	(goal research_branch_siege 83)
	(goal want-more-town-centers 0)
	(can-research ri-heavy-scorpion)
=>
	(research ri-heavy-scorpion)
)
(defrule
	(or (goal research_branch_siege 33)
		(goal research_branch_siege 84))
	(or (research-completed ri-heavy-scorpion)
		(goal is-zero-goal research_twig_scorpions))
=>
	(set-goal research_branch_siege 34)
)
(defrule
	(goal research_branch_siege 33)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-heavy-scorpion))
=>
	(set-goal research_branch_siege 34)
)

; Research Bombard Cannon if 'on' (Siege)
(defrule
	(goal is_one_goal research_twig_bombardcannons)
	(or (goal research_branch_siege 19)
		(goal research_branch_siege 69))
	(goal want-more-town-centers 0)
	(research-available ri-bombard-cannon)
	(food-amount < 500)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal is_one_goal research_twig_bombardcannons)
	(or (goal research_branch_siege 19)
		(goal research_branch_siege 69))
	(goal want-more-town-centers 0)
	(research-available ri-bombard-cannon)
	(gold-amount < 250)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal is_one_goal research_twig_bombardcannons)
	(goal research_branch_siege 19)
	(goal want-more-town-centers 0)
	(can-research ri-bombard-cannon)
=>
	(research ri-bombard-cannon)
	(set-goal research_branch_siege 70)
)
(defrule
	(goal is_one_goal research_twig_bombardcannons)
	(goal research_branch_siege 69)
	(goal want-more-town-centers 0)
	(can-research ri-bombard-cannon)
=>
	(research ri-bombard-cannon)
)
(defrule
	(or (goal research_branch_siege 19)
		(goal research_branch_siege 70))
	(or (research-completed ri-bombard-cannon)
		(goal is-zero-goal research_twig_bombardcannons))
=>
	(set-goal research_branch_siege 20)
)
(defrule
	(goal research_branch_siege 19)
	(building-type-count siege-workshop >= 1)
	(current-age >= imperial-age)
	(research-completed ri-chemistry)
	(not (research-available ri-bombard-cannon))
=>
	(set-goal research_branch_siege 20)
)

; MARKET
; Research Cartography (City)
(defrule
	(or (goal research_branch_city 37)
		(goal research_branch_city 87))
	(not (goal is-zero-goal research_branch_trade))
	(goal want-more-town-centers 0)
	(research-available ri-cartography)
	(food-amount < 100)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 37)
		(goal research_branch_city 87))
	(not (goal is-zero-goal research_branch_trade))
	(goal want-more-town-centers 0)
	(research-available ri-cartography)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_city 37)
	(not (goal is-zero-goal research_branch_trade))
	(goal want-more-town-centers 0)
	(can-research ri-cartography)
=>
	(research ri-cartography)
	(set-goal research_branch_city 88)
)
(defrule
	(goal research_branch_city 87)
	(not (goal is-zero-goal research_branch_trade))
	(goal want-more-town-centers 0)
	(can-research ri-cartography)
=>
	(research ri-cartography)
)
(defrule
	(or (goal research_branch_city 37)
		(goal research_branch_city 88))
	(or (research-completed ri-cartography)
		(goal is-zero-goal research_branch_trade))
=>
	(set-goal research_branch_city 38)
)
(defrule
	(goal research_branch_city 37)
	(building-type-count market >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-cartography))
=>
	(set-goal research_branch_city 38)
)

; Research Coinage (Trade)
(defrule
	(or (goal research_branch_trade 33)
		(goal research_branch_trade 83))
	(goal want-more-town-centers 0)
	(research-available ri-coinage)
	(food-amount < 150)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_trade 33)
		(goal research_branch_trade 83))
	(goal want-more-town-centers 0)
	(research-available ri-coinage)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_trade 33)
	(goal want-more-town-centers 0)
	(can-research ri-coinage)
=>
	(research ri-coinage)
	(set-goal research_branch_trade 84)
)
(defrule
	(goal research_branch_trade 83)
	(goal want-more-town-centers 0)
	(can-research ri-coinage)
=>
	(research ri-coinage)
)
(defrule
	(or (goal research_branch_trade 33)
		(goal research_branch_trade 84))
	(research-completed ri-coinage)
=>
	(set-goal research_branch_trade 34)
)
(defrule
	(goal research_branch_trade 33)
	(building-type-count market >= 1)
	(current-age >= feudal-age)
	(not (research-available ri-coinage))
=>
	(set-goal research_branch_trade 34)
)

; Research Caravan if we will train Trade Carts (Trade)
(defrule
	(or (goal research_branch_trade 34)
		(goal research_branch_trade 84))
	(not (goal is-zero-goal trade-carts-to-train))
	(goal want-more-town-centers 0)
	(research-available ri-caravan)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_trade 34)
		(goal research_branch_trade 84))
	(not (goal is-zero-goal trade-carts-to-train))
	(goal want-more-town-centers 0)
	(research-available ri-caravan)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_trade 34)
	(not (goal is-zero-goal trade-carts-to-train))
	(goal want-more-town-centers 0)
	(can-research ri-caravan)
=>
	(research ri-caravan)
	(set-goal research_branch_trade 85)
)
(defrule
	(goal research_branch_trade 84)
	(not (goal is-zero-goal trade-carts-to-train))
	(goal want-more-town-centers 0)
	(can-research ri-caravan)
=>
	(research ri-caravan)
)
(defrule
	(or (goal research_branch_trade 34)
		(goal research_branch_trade 85))
	(or (research-completed ri-caravan)
		(goal is-zero-goal trade-carts-to-train))
=>
	(set-goal research_branch_trade 35)
)
(defrule
	(goal research_branch_trade 34)
	(building-type-count market >= 1)
	(current-age >= castle-age)
	(or (research-completed ri-cartography)
		(not (research-available ri-cartography)))
	(not (research-available ri-caravan))
=>
	(set-goal research_branch_trade 35)
)

; Research Guilds (City)
(defrule
	(or (goal research_branch_city 38)
		(goal research_branch_city 88))
	(goal want-more-town-centers 0)
	(research-available ri-guilds)
	(food-amount < 300)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_city 38)
		(goal research_branch_city 88))
	(goal want-more-town-centers 0)
	(research-available ri-guilds)
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_city 38)
	(goal want-more-town-centers 0)
	(can-research ri-guilds)
=>
	(research ri-guilds)
	(set-goal research_branch_city 89)
)
(defrule
	(goal research_branch_city 88)
	(goal want-more-town-centers 0)
	(can-research ri-guilds)
=>
	(research ri-guilds)
)
(defrule
	(or (goal research_branch_city 38)
		(goal research_branch_city 89))
	(research-completed ri-guilds)
=>
	(set-goal research_branch_city 39)
)
(defrule
	(goal research_branch_city 38)
	(building-type-count market >= 1)
	(current-age >= imperial-age)
	(not (research-available ri-guilds))
=>
	(set-goal research_branch_city 39)
)

; Research Banking (Trade)
(defrule
	(or (goal research_branch_trade 35)
		(goal research_branch_trade 85))
	(goal want-more-town-centers 0)
	(research-available ri-banking)
	(food-amount < 200)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(or (goal research_branch_trade 35)
		(goal research_branch_trade 85))
	(goal want-more-town-centers 0)
	(research-available ri-banking)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal research_branch_trade 35)
	(goal want-more-town-centers 0)
	(can-research ri-banking)
=>
	(research ri-banking)
	(set-goal research_branch_trade 86)
)
(defrule
	(goal research_branch_trade 85)
	(goal want-more-town-centers 0)
	(can-research ri-banking)
=>
	(research ri-banking)
)
(defrule
	(or (goal research_branch_trade 35)
		(goal research_branch_trade 86))
	(research-completed ri-banking)
=>
	(set-goal research_branch_trade 36)
)
(defrule
	(goal research_branch_trade 35)
	(building-type-count market >= 1)
	(current-age >= castle-age)
	(or (research-completed ri-coinage)
		(not (research-available ri-coinage)))
	(not (research-available ri-banking))
=>
	(set-goal research_branch_trade 36)
)

;===========-Economy: Training-=============================
; VILLAGERS
; Local goal variables
(defconst train_more_villagers 40)
(defrule
	(true)
=>
	(set-goal train_more_villagers 0)
)
(defrule
	(or (and (goal current-age-goal dark-age)
			(unit-type-count-total villager < dark_age_vills))
	(or (and (goal current-age-goal feudal-age)
			(unit-type-count-total villager < feudal_age_vills))
	(or (and (goal current-age-goal castle-age)
			(unit-type-count-total villager < castle_age_vills))
		(and (goal current-age-goal imperial-age)
			(unit-type-count-total villager < max-villagers)))))
=>
	(set-goal train_more_villagers 1)
)

; Crank out Villagers until the limit is reached.
(defrule
	(goal train_more_villagers 1)
	(building-type-count-total town-center >= 1)
	(food-amount < 50)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal train_more_villagers 1)
	(can-train villager)
=>
	(train villager)
)

; Just in case, use escrow for villagers when less than min-villagers.
(defrule
	(goal train_more_villagers 1)
	(unit-type-count-total villager < min-villagers)
	(building-type-count-total town-center >= 1)
	(food-amount < 50)
=>
	(set-goal need-food-goal 1)
	(set-goal escrow-food-goal 1)
)
(defrule
	(goal train_more_villagers 1)
	(unit-type-count-total villager < min-villagers)
	(building-type-count-total town-center >= 1)
	(can-train-with-escrow villager)
=>
	(release-escrow food)
	(train villager)
)

;===========-Military: Training-============================
; UNIQUE UNITS
; Crank out Unique Units in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total my-unique-unit-line < unique-units-to-train)
	(food-amount < unique-unit-food)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total my-unique-unit-line < unique-units-to-train)
	(wood-amount < unique-unit-wood)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total my-unique-unit-line < unique-units-to-train)
	(gold-amount < unique-unit-gold)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total my-unique-unit-line < unique-units-to-train)
	(can-train my-unique-unit-line)
=>
	(train my-unique-unit-line)
)

; KNIGHTS - CAVALIERS - PALADINS
; Crank out Knights in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total knight-line < knights-to-train)
	(food-amount < 60)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total knight-line < knights-to-train)
	(gold-amount < 75)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total knight-line < knights-to-train)
	(can-train knight-line)
=>
	(train knight-line)
)

; CAMELS - HEAVY CAMELS
; Crank out Camels in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total camel-line < camels-to-train)
	(food-amount < 55)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total camel-line < camels-to-train)
	(gold-amount < 60)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total camel-line < camels-to-train)
	(can-train camel-line)
=>
	(train camel-line)
)

; SCOUTS: SCOUT CAVALRY and EAGLE WARRIORS
; Train Scouts when available.
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total scout_type < scouts-to-train)
	(unit-available scout_type)
	(food-amount < scout_food)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total scout_type < scouts-to-train)
	(unit-available scout_type)
	(wood-amount < scout_wood)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total scout_type < scouts-to-train)
	(unit-available scout_type)
	(gold-amount < scout_gold)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total scout_type < scouts-to-train)
	(can-train scout_type)
=>
	(train scout_type)
)

; SCOUT CAVALRY - LIGHT CAVALRY - HUSSARS
; Crank out Scout Cavalry in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total scout-cavalry-line < scout-cavalry-to-train)
	(food-amount < 80)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total scout-cavalry-line < scout-cavalry-to-train)
	(can-train scout-cavalry-line)
=>
	(train scout-cavalry-line)
)

; HAND CANNONEERS
; Crank out Hand Cannoneers in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total hand-cannoneer < hand-cannoneers-to-train)
	(food-amount < 45)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total hand-cannoneer < hand-cannoneers-to-train)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total hand-cannoneer < hand-cannoneers-to-train)
	(can-train hand-cannoneer)
=>
	(train hand-cannoneer)
)

; CAVALRY ARCHERS - HEAVY CAVALRY ARCHERS
; Crank out Cavalry Archers in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total cavalry-archer-line < cavalry-archers-to-train)
	(wood-amount < 40)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total cavalry-archer-line < cavalry-archers-to-train)
	(gold-amount < 70)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total cavalry-archer-line < cavalry-archers-to-train)
	(can-train cavalry-archer-line)
=>
	(train cavalry-archer-line)
)

; ARCHERS - CROSSBOWMEN - ARBALESTS
; Crank out Archers in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total archer-line < archers-to-train)
	(wood-amount < 25)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total archer-line < archers-to-train)
	(gold-amount < 45)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total archer-line < archers-to-train)
	(can-train archer-line)
=>
	(train archer-line)
)

; SKIRMISHERS - ELITE SKIRMISHERS
; Crank out Skirmishers in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total skirmisher-line < skirmishers-to-train)
	(food-amount < 25)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total skirmisher-line < skirmishers-to-train)
	(wood-amount < 35)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total skirmisher-line < skirmishers-to-train)
	(can-train skirmisher-line)
=>
	(train skirmisher-line)
)

; MONKS - MISSIONARIES
; Train Monks for relic collection when available.
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total monk < min-monks-to-train)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(unit-type-count-total monk < min-monks-to-train)
	(can-train monk)
=>
	(train monk)
)

; Crank out Monks or Missionaries in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count monastery >= 1)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total monk < monks-to-train)
	(gold-amount < 100)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total monk_type < monks-to-train)
	(can-train monk_type)
=>
	(train monk_type)
)

; BATTERING RAMS - CAPPED RAMS - SIEGE RAMS
; Crank out Battering Rams in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total battering-ram-line < battering-rams-to-train)
	(wood-amount < 160)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total battering-ram-line < battering-rams-to-train)
	(gold-amount < 75)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total battering-ram-line < battering-rams-to-train)
	(can-train battering-ram-line)
=>
	(train battering-ram-line)
)

; MANGONELS - ONAGERS - SIEGE ONAGERS
; Crank out Mangonels in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total mangonel-line < mangonels-to-train)
	(wood-amount < 160)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total mangonel-line < mangonels-to-train)
	(gold-amount < 135)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total mangonel-line < mangonels-to-train)
	(can-train mangonel-line)
=>
	(train mangonel-line)
)

; SCORPIONS - HEAVY SCORPIONS
; Crank out Scorpions in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total scorpion-line < scorpions-to-train)
	(wood-amount < 75)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total scorpion-line < scorpions-to-train)
	(gold-amount < 75)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total scorpion-line < scorpions-to-train)
	(can-train scorpion-line)
=>
	(train scorpion-line)
)

; BOMBARD CANNONS
; Crank out Bombard Cannons in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total bombard-cannon < bombard-cannons-to-train)
	(wood-amount < 225)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total bombard-cannon < bombard-cannons-to-train)
	(gold-amount < 225)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total bombard-cannon < bombard-cannons-to-train)
	(can-train bombard-cannon)
=>
	(train bombard-cannon)
)

; PETARDS
; Crank out Petards in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total petard < petards-to-train)
	(food-amount < 80)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total petard < petards-to-train)
	(gold-amount < 20)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total petard < petards-to-train)
	(can-train petard)
=>
	(train petard)
)

; SPEARMEN - PIKEMEN - HALBERDIER
; Crank out Spearmen in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total spearman-line < spearmen-to-train)
	(food-amount < 35)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total spearman-line < spearmen-to-train)
	(wood-amount < 25)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total spearman-line < spearmen-to-train)
	(can-train spearman-line)
=>
	(train spearman-line)
)

; MILITIAS - MEN-AT-ARMS - LONG SWORDSMEN - 2H SWORDSMEN - CHAMPIONS
; Crank out Militia in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total militiaman-line < militias-to-train)
	(food-amount < 60)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total militiaman-line < militias-to-train)
	(gold-amount < 20)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total militiaman-line < militias-to-train)
	(can-train militiaman-line)
=>
	(train militiaman-line)
)

; EAGLE WARRIORS - ELITE EAGLE WARRIORS
; Crank out Eagle Warriors in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total eagle-warrior-line < eaglewarrs-to-train)
	(food-amount < 20)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total eagle-warrior-line < eaglewarrs-to-train)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(goal no_gold_limits 0)
	(housing-headroom > 0)
	(unit-type-count-total eagle-warrior-line < eaglewarrs-to-train)
	(can-train eagle-warrior-line)
=>
	(train eagle-warrior-line)
)

; TRANSPORT SHIPS
; Crank out Transport Ships in the Imperial Age.
(defrule
	(goal want-more-town-centers 0)
	(building-type-count dock >= 1)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(housing-headroom > 0)
	(unit-type-count-total transport-ship < transports-to-train)
	(wood-amount < 125)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(housing-headroom > 0)
	(unit-type-count-total transport-ship < transports-to-train)
	(can-train transport-ship)
=>
	(train transport-ship)
)

; TREBUCHETS
; Crank out Trebuchets in the Imperial Age (but not if many unpacked).
; Trebs will be built for the No Gold Army.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(housing-headroom > 0)
	(or (unit-type-count-total trebuchet < trebuchets-to-train)
		(unit-type-count 42 > 3))
	(wood-amount < 200)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(housing-headroom > 0)
	(or (unit-type-count-total trebuchet < trebuchets-to-train)
		(unit-type-count 42 > 3))
	(gold-amount < 200)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(or (unit-type-count-total trebuchet < trebuchets-to-train)
		(unit-type-count 42 > 3))
	(can-train trebuchet)
=>
	(train trebuchet)
)

;===========-Military: Train No Gold Units-=================
; Train units for late No Gold Army.
(defrule
	(goal no_gold_limits 1)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total no_gold_unit < no_gold_units_to_train)
	(food-amount < no_gold_unit_food)
=>
	(set-goal need-food-goal 1)
)
(defrule
	(goal no_gold_limits 1)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total no_gold_unit < no_gold_units_to_train)
	(wood-amount < no_gold_unit_wood)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal no_gold_limits 1)
	(goal want-more-town-centers 0)
	(housing-headroom > 0)
	(unit-type-count-total no_gold_unit < no_gold_units_to_train)
	(can-train no_gold_unit)
=>
	(train no_gold_unit)
)

;===========-Economy: Training-=============================
; TRADE CARTS
; Build Trade Carts once we've started the attack cycle.
(defrule
	(goal want-more-town-centers 0)
	(players-building-type-count any-ally market >= 1)
	(or (doctrine doc_late_defence)
		(doctrine doc_late_offence))
	(unit-type-count-total trade-cart < trade-carts-to-train)
	(wood-amount < 100)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(players-building-type-count any-ally market >= 1)
	(or (doctrine doc_late_defence)
		(doctrine doc_late_offence))
	(unit-type-count-total trade-cart < trade-carts-to-train)
	(gold-amount < 50)
=>
	(set-goal need-gold-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(players-building-type-count any-ally market >= 1)
	(or (doctrine doc_late_defence)
		(doctrine doc_late_offence))
	(unit-type-count-total trade-cart < trade-carts-to-train)
	(can-train trade-cart)
=>
	(train trade-cart)
)

;===========-Buildings: Forward Towers-=====================
; Forward build normal Towers.
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total watch-tower-line < towers-to-build)
	(wood-amount < 25)
=>
	(set-goal need-wood-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total watch-tower-line < towers-to-build)
	(stone-amount < 125)
=>
	(set-goal need-stone-goal 1)
)
(defrule
	(goal want-more-town-centers 0)
	(or (goal current-age-goal imperial-age)
		(current-age == imperial-age))
	(building-type-count-total watch-tower-line < towers-to-build)
	(can-build watch-tower-line)
=>
	(build-forward watch-tower-line)
)

;===========-Military: Attack Cycle-här========================
; Doctrine is HIDE
(defrule
	(doctrine doc_early_defend_city)
	(or (unit-type-count defender-type < defenders-to-train)
		(unit-type-count defender-type == 0))
=>
	(set-strategic-number sn-task-ungrouped-soldiers 0)
	(set-strategic-number sn-percent-enemy-sighted-response 0)
	(set-strategic-number sn-enemy-sighted-response-distance 10)
	(set-strategic-number sn-sentry-distance 0)
	(set-strategic-number sn-target-evaluation-siege-weapon 0)
	(set-strategic-number sn-percent-attack-soldiers 0)
	(set-doctrine doc_early_hide)
	(chat-local-to-self "Doctrine is Hide")
)
; Doctrine is DEFEND CITY
(defrule
	(doctrine doc_early_hide)
	(unit-type-count defender-type >= defenders-to-train)
=>
	(set-strategic-number sn-task-ungrouped-soldiers 1)
	(set-strategic-number sn-percent-enemy-sighted-response 100)
	(set-strategic-number sn-enemy-sighted-response-distance 50)
	(set-strategic-number sn-sentry-distance 20)
	(set-strategic-number sn-target-evaluation-siege-weapon 0)
	(set-strategic-number sn-percent-attack-soldiers 0)
	(set-doctrine doc_early_defend_city)
	(chat-local-to-self "Doctrine is Defend City")
)

; Doctrine is DEFENCE
; Advance from early doctrines?
(defrule
	(or (goal current-age-goal imperial-age)
		(current-age >= imperial-age))
=>
	(set-doctrine doc_late_defence)
	(disable-self)
)
(defrule
	(or (doctrine doc_late_offence)
		(doctrine doc_late_no_gold_offence))
	(timer-triggered attack-timer)
=>
	(disable-timer attack-timer)
	(enable-timer attack-timer time_to_recuperate)
	(set-doctrine doc_late_defence)
)
(defrule
	(doctrine doc_late_defence)
=>
	(set-strategic-number sn-task-ungrouped-soldiers 0)
	(set-strategic-number sn-percent-enemy-sighted-response 50)
	(set-strategic-number sn-enemy-sighted-response-distance 30)
	(set-strategic-number sn-sentry-distance 20)
	(set-strategic-number sn-target-evaluation-siege-weapon 0)
	(set-strategic-number sn-percent-attack-soldiers 0)
	(set-strategic-number sn-group-form-distance 25)
	(set-strategic-number sn-number-attack-groups 0)
	(set-strategic-number sn-consecutive-idle-unit-limit 0)
	(set-goal attack_when_goal attack_later)
	(chat-local-to-self "Doctrine is Defence")
)

; Doctrine is OFFENCE
; Check if the army is complete.
(defrule
	(goal attack_when_goal attack_later)
	(unit-type-count militiaman-line >= min_militias_for_attack)
	(unit-type-count spearman-line >= min_spearmen_for_attack)
	(unit-type-count eagle-warrior-line >= min_eaglewarrs_for_attack)
	(unit-type-count archer-line >= min_archers_for_attack)
	(unit-type-count skirmisher-line >= min_skirmishers_for_attack)
	(unit-type-count cavalry-archer-line >= min_cavarchers_for_attack)
	(unit-type-count hand-cannoneer >= min_cannoneers_for_attack)
=>
	(set-goal attack_when_goal infarch_ready)
)
(defrule
	(goal attack_when_goal infarch_ready)
	(unit-type-count scout-cavalry-line >= min_scoutcav_for_attack)
	(unit-type-count knight-line >= min_knights_for_attack)
	(unit-type-count camel-line >= min_camels_for_attack)
	(or (unit-type-count trebuchet >= min_trebuchets_for_attack)
		(unit-type-count 42 >= 3))
	(unit-type-count scorpion-line >= min_scorpions_for_attack)
	(unit-type-count battering-ram-line >= min_rams_for_attack)
	(unit-type-count mangonel-line >= min_mangonels_for_attack)
	(unit-type-count bombard-cannon >= min_bombcannons_for_attack)
	(unit-type-count petard >= min_petards_for_attack)
=>
	(set-goal attack_when_goal cavsiege_ready)
)
(defrule
	(goal attack_when_goal cavsiege_ready)
	(unit-type-count my-unique-unit-line >= min_unique_for_attack)
	(unit-type-count monk_type >= min_monks_for_attack)
=>
	(set-goal attack_when_goal attack_now)
)
(defrule
	(population >= max-population)
=>
	(set-goal attack_when_goal attack_now)
)
(defrule
	(not (goal attack_when_goal attack_now))
=>
	(set-goal attack_when_goal attack_later)
)

; Attack when army is trained and techs are done.
(defrule
	(doctrine doc_late_defence)
	(goal attack_when_goal attack_now)
	(or (goal research_next_phase 99)
		(game-time > 4500))
=>
	(set-doctrine doc_late_offence)
	(chat-local-to-self "Doctrine is Offence")
)
(defrule
	(doctrine doc_late_offence)
	(timer-triggered attack-timer)
=>
	(set-strategic-number sn-task-ungrouped-soldiers 0)
	(set-strategic-number sn-percent-enemy-sighted-response 40)
	(set-strategic-number sn-enemy-sighted-response-distance 35)
	(set-strategic-number sn-sentry-distance 30)
	(set-strategic-number sn-consecutive-idle-unit-limit 10)
	(set-strategic-number sn-target-evaluation-siege-weapon 1)
	(set-strategic-number sn-group-form-distance 45)
	(set-strategic-number sn-percent-attack-soldiers 100)
	(set-strategic-number sn-number-attack-groups 2)
	(attack-now)
	(disable-timer attack-timer)
	(enable-timer attack-timer time_to_charge)
)

; Doctrine is NO GOLD OFFENCE
; Keep attacking even though we are out of gold.
; Save the little gold we have/get for siege.
(defrule
	(doctrine doc_late_defence)
	(goal no_gold_limits 1)
	(goal attack_when_goal attack_later)
=>
	(set-doctrine doc_late_no_gold_offence)
	(chat-local-to-self "Doctrine is No Gold Offence")
)
(defrule
	(doctrine doc_late_no_gold_offence)
	(or (unit-type-count trebuchet >= 1)
	(or	(unit-type-count 42 >= 1)
		(population >= max-population)))
	(timer-triggered attack-timer)
=>
	(set-strategic-number sn-percent-enemy-sighted-response 40)
	(set-strategic-number sn-enemy-sighted-response-distance 35)
	(set-strategic-number sn-sentry-distance 30)
	(set-strategic-number sn-target-evaluation-siege-weapon 1)
	(set-strategic-number sn-percent-attack-soldiers 100)
	(set-strategic-number sn-number-attack-groups 1)
	(attack-now)
	(disable-timer attack-timer)
	(enable-timer attack-timer time_to_charge)
)

;===========-Economy: Resource Management-==================
; Resource Management local variables.
(defconst trade_limits 39)
(defconst trade_early 0)
(defconst trade_late 1)

; Handle escrow goals
(defrule
	(goal escrow-food-goal 1)
=>
	(set-escrow-percentage food 80)
	(set-goal escrow-food-goal 0)
)
(defrule
	(goal escrow-food-goal 0)
=>
	(release-escrow food)
	(set-escrow-percentage food 0)
)
(defrule
	(goal escrow-wood-goal 1)
=>
	(set-escrow-percentage wood 80)
	(set-goal escrow-wood-goal 0)
)
(defrule
	(goal escrow-wood-goal 0)
=>
	(release-escrow wood)
	(set-escrow-percentage wood 0)
)
(defrule
	(goal escrow-gold-goal 1)
=>
	(set-escrow-percentage gold 80)
	(set-goal escrow-gold-goal 0)
)
(defrule
	(goal escrow-gold-goal 0)
=>
	(release-escrow gold)
	(set-escrow-percentage gold 0)
)
(defrule
	(goal escrow-stone-goal 1)
=>
	(set-escrow-percentage stone 50)
	(set-goal escrow-stone-goal 0)
)
(defrule
	(goal escrow-stone-goal 0)
=>
	(release-escrow stone)
	(set-escrow-percentage stone 0)
)

(defrule
	(true)
=>
	(set-goal trade_limits trade_early)
)
(defrule
	(current-age >= imperial-age)
	(goal research_next_phase 99)
=>
	(set-goal trade_limits trade_late)
)

(defrule
	(goal trade_limits trade_early)
	(food-amount >= min_food_for_early_trade)
=>
	(sell-commodity food)
)
(defrule
	(goal trade_limits trade_early)
	(wood-amount >= min_wood_for_early_trade)
=>
	(sell-commodity wood)
)
(defrule
	(goal trade_limits trade_early)
	(stone-amount >= min_stone_for_early_trade)
=>
	(sell-commodity stone)
)
(defrule
	(goal trade_limits trade_late)
	(food-amount >= min_food_for_late_trade)
=>
	(sell-commodity food)
)
(defrule
	(goal trade_limits trade_late)
	(wood-amount >= min_wood_for_late_trade)
=>
	(sell-commodity wood)
)
(defrule
	(goal trade_limits trade_late)
	(stone-amount >= min_stone_for_late_trade)
=>
	(sell-commodity stone)
)

; Buy commodities as needed.
(defrule
	(goal need-stone-goal 1)
	(can-buy-commodity stone)
	(goal trade_limits trade_early)
	(gold-amount >= min_gold_for_early_trade)
=>
	(buy-commodity stone)
)
(defrule
	(goal need-stone-goal 1)
	(can-buy-commodity stone)
	(goal trade_limits trade_late)
	(gold-amount >= min_gold_for_late_trade)
=>
	(buy-commodity stone)
)

; Don't gather gold or stone if too far away and maxed out on mining camps.
(defrule
	(building-type-count-total mining-camp >= max-mining-camps)
	(dropsite-min-distance gold > max-gold-dropsite-distance)
=>
	(set-goal need-gold-goal 0)
)
(defrule
	(building-type-count-total mining-camp >= max-mining-camps)
	(dropsite-min-distance stone > max-stone-dropsite-distance)
=>
	(set-goal need-stone-goal 0)
)

; Extend food gathering distance when farms are idle and need food.
(defrule
	(goal need-food-goal 1)
	(idle-farm-count > 0)
=>
	(set-strategic-number sn-maximum-food-drop-distance idle-farm-gather-distance)
)
(defrule
	(or (goal need-food-goal 0)
		(idle-farm-count < 1))
=>
	(set-strategic-number sn-maximum-food-drop-distance max-food-dropsite-distance)
)

; Keep track of whether or not we needed gold or stone.
(defrule
	(goal need-gold-goal 0)
=>
	(set-goal needed-gold-goal 0)
)
(defrule
	(goal need-gold-goal 1)
=>
	(set-goal needed-gold-goal 1)
)
(defrule
	(goal need-stone-goal 0)
=>
	(set-goal needed-stone-goal 0)
)
(defrule
	(goal need-stone-goal 1)
=>
	(set-goal needed-stone-goal 1)
)

; Set the gathering percentages.
(defrule
	(current-age <= castle-age)
	(unit-type-count villager <= 11)
=>
	(set-strategic-number sn-food-gatherer-percentage 100)
	(set-strategic-number sn-wood-gatherer-percentage 0)
	(set-strategic-number sn-gold-gatherer-percentage 0)
	(set-strategic-number sn-stone-gatherer-percentage 0)
)
(defrule
	(current-age <= castle-age)
	(unit-type-count villager > 11)
	(unit-type-count villager <= 21)
=>
	(set-strategic-number sn-food-gatherer-percentage 50)
	(set-strategic-number sn-wood-gatherer-percentage 50)
	(set-strategic-number sn-gold-gatherer-percentage 0)
	(set-strategic-number sn-stone-gatherer-percentage 0)
)
(defrule
	(current-age <= castle-age)
	(unit-type-count villager > 21)
	(unit-type-count villager <= 24)
=>
	(set-strategic-number sn-food-gatherer-percentage 45)
	(set-strategic-number sn-wood-gatherer-percentage 45)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age <= castle-age)
	(unit-type-count villager > 24)
	(unit-type-count villager <= 34)
=>
	(set-strategic-number sn-food-gatherer-percentage 30)
	(set-strategic-number sn-wood-gatherer-percentage 30)
	(set-strategic-number sn-gold-gatherer-percentage 20)
	(set-strategic-number sn-stone-gatherer-percentage 20)
)
(defrule
	(current-age <= castle-age)
	(unit-type-count villager > 34)
	(unit-type-count villager <= 50)
=>
	(set-strategic-number sn-food-gatherer-percentage 28)
	(set-strategic-number sn-wood-gatherer-percentage 28)
	(set-strategic-number sn-gold-gatherer-percentage 28)
	(set-strategic-number sn-stone-gatherer-percentage 16)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 0)
	(goal need-gold-goal 0)
	(goal need-stone-goal 0)
=>
	(set-strategic-number sn-food-gatherer-percentage 43)
	(set-strategic-number sn-wood-gatherer-percentage 35)
	(set-strategic-number sn-gold-gatherer-percentage 17)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal no_gold_limits 1)
	(goal need-food-goal 0)
	(goal need-wood-goal 0)
=>
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 42)
	(set-strategic-number sn-wood-gatherer-percentage 48)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal no_gold_limits 1)
	(goal need-food-goal 1)
	(goal need-wood-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 42)
	(set-strategic-number sn-wood-gatherer-percentage 48)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal no_gold_limits 1)
	(goal need-food-goal 1)
	(goal need-wood-goal 0)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 65)
	(set-strategic-number sn-wood-gatherer-percentage 25)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal no_gold_limits 1)
	(goal need-food-goal 0)
	(goal need-wood-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 20)
	(set-strategic-number sn-wood-gatherer-percentage 70)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 0)
	(goal need-gold-goal 0)
	(goal need-stone-goal 0)
=>
	(set-goal need-food-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 80)
	(set-strategic-number sn-wood-gatherer-percentage 10)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 1)
	(goal need-gold-goal 0)
	(goal need-stone-goal 0)
=>
	(set-goal need-wood-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 15)
	(set-strategic-number sn-wood-gatherer-percentage 75)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 1)
	(goal need-gold-goal 0)
	(goal need-stone-goal 0)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 45)
	(set-strategic-number sn-wood-gatherer-percentage 45)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 0)
	(goal need-gold-goal 1)
	(goal need-stone-goal 0)
=>
	(set-goal need-gold-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 25)
	(set-strategic-number sn-wood-gatherer-percentage 15)
	(set-strategic-number sn-gold-gatherer-percentage 50)
	(set-strategic-number sn-stone-gatherer-percentage 10)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 0)
	(goal need-gold-goal 1)
	(goal need-stone-goal 0)
=>
	(set-goal need-food-goal 0)
	(set-goal need-gold-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 55)
	(set-strategic-number sn-wood-gatherer-percentage 10)
	(set-strategic-number sn-gold-gatherer-percentage 30)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 1)
	(goal need-gold-goal 1)
	(goal need-stone-goal 0)
=>
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 10)
	(set-strategic-number sn-wood-gatherer-percentage 50)
	(set-strategic-number sn-gold-gatherer-percentage 35)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 1)
	(goal need-gold-goal 1)
	(goal need-stone-goal 0)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 50)
	(set-strategic-number sn-wood-gatherer-percentage 25)
	(set-strategic-number sn-gold-gatherer-percentage 20)
	(set-strategic-number sn-stone-gatherer-percentage 5)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 0)
	(goal need-gold-goal 0)
	(goal need-stone-goal 1)
=>
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 20)
	(set-strategic-number sn-wood-gatherer-percentage 20)
	(set-strategic-number sn-gold-gatherer-percentage 10)
	(set-strategic-number sn-stone-gatherer-percentage 50)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 0)
	(goal need-gold-goal 0)
	(goal need-stone-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 55)
	(set-strategic-number sn-wood-gatherer-percentage 10)
	(set-strategic-number sn-gold-gatherer-percentage 10)
	(set-strategic-number sn-stone-gatherer-percentage 25)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 1)
	(goal need-gold-goal 0)
	(goal need-stone-goal 1)
=>
	(set-goal need-wood-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 10)
	(set-strategic-number sn-wood-gatherer-percentage 50)
	(set-strategic-number sn-gold-gatherer-percentage 10)
	(set-strategic-number sn-stone-gatherer-percentage 30)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 1)
	(goal need-gold-goal 0)
	(goal need-stone-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 45)
	(set-strategic-number sn-wood-gatherer-percentage 35)
	(set-strategic-number sn-gold-gatherer-percentage 5)
	(set-strategic-number sn-stone-gatherer-percentage 15)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 0)
	(goal need-gold-goal 1)
	(goal need-stone-goal 1)
=>
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 15)
	(set-strategic-number sn-wood-gatherer-percentage 10)
	(set-strategic-number sn-gold-gatherer-percentage 38)
	(set-strategic-number sn-stone-gatherer-percentage 37)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 0)
	(goal need-gold-goal 1)
	(goal need-stone-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 57)
	(set-strategic-number sn-wood-gatherer-percentage 10)
	(set-strategic-number sn-gold-gatherer-percentage 18)
	(set-strategic-number sn-stone-gatherer-percentage 15)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 0)
	(goal need-wood-goal 1)
	(goal need-gold-goal 1)
	(goal need-stone-goal 1)
=>
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 15)
	(set-strategic-number sn-wood-gatherer-percentage 40)
	(set-strategic-number sn-gold-gatherer-percentage 25)
	(set-strategic-number sn-stone-gatherer-percentage 20)
)
(defrule
	(current-age >= imperial-age)
	(goal need-food-goal 1)
	(goal need-wood-goal 1)
	(goal need-gold-goal 1)
	(goal need-stone-goal 1)
=>
	(set-goal need-food-goal 0)
	(set-goal need-wood-goal 0)
	(set-goal need-gold-goal 0)
	(set-goal need-stone-goal 0)
	(set-strategic-number sn-food-gatherer-percentage 40)
	(set-strategic-number sn-wood-gatherer-percentage 30)
	(set-strategic-number sn-gold-gatherer-percentage 17)
	(set-strategic-number sn-stone-gatherer-percentage 13)
)

